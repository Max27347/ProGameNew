<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="description" content="Notcoin-inspired clicker game">
<title>Clicker Game</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
*:focus,*:active{outline:none;-webkit-tap-highlight-color:transparent}
:root{--bg-color:#000;--bg-gradient:radial-gradient(circle at 50% 50%,rgba(255,255,255,0.2),transparent 70%);--highlight-color:#FFF;--text-color:#fff;--footer-bg:rgba(30,30,30,0.85);--counter-bg:rgba(30,30,30,0.85);--top-menu-bg:rgba(30,30,30,0.85);--tg-bg-color:linear-gradient(135deg,#1c2526,#2a1b3d);--tg-text-color:#fff;--tg-footer-bg:rgba(44,47,71,0.85);--tg-counter-bg:rgba(44,47,71,0.85);--tg-top-menu-bg:rgba(44,47,71,0.85)}
[data-telegram="true"]{--bg-color:var(--tg-bg-color);--text-color:var(--tg-text-color);--footer-bg:var(--tg-footer-bg);--counter-bg:var(--tg-counter-bg);--top-menu-bg:var(--tg-top-menu-bg)}
body{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-color);background-image:var(--bg-gradient);color:var(--text-color);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;font-size:16px;line-height:1.5;overflow:hidden;-webkit-user-select:none;user-select:none}
.loading-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;opacity:1;transition:opacity 0.5s ease}
.loading-screen.hidden{opacity:0;pointer-events:none}
.loading-ring{width:100px;height:100px;border:8px solid transparent;border-top-color:rgba(255,255,255,0.8);border-right-color:rgba(255,255,255,0.4);border-radius:50%;animation:spin 1.5s linear infinite;opacity:1;transition:opacity 0.5s ease}
.loading-ring.hidden{opacity:0}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.loading-percent{position:absolute;bottom:2rem;font-size:1.5rem;font-weight:600;color:#FFF;opacity:1;transition:opacity 0.5s ease}
.loading-percent.hidden{opacity:0}
.game-hidden{opacity:0;pointer-events:none;transition:opacity 0.5s ease}
.game-hidden.visible{opacity:1;pointer-events:auto}
.top-menu{position:fixed;top:1rem;width:calc(100% - 3rem);margin:0 1.5rem;background:var(--top-menu-bg);border-radius:20px;padding:1rem;display:flex;justify-content:space-between;align-items:center;z-index:2;opacity:1;transition:opacity 0.5s ease}
.top-menu-left{display:flex;align-items:center;gap:0.75rem}
.top-menu-right{display:flex;flex-direction:column;align-items:flex-end;gap:0.2rem}
.player-avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
.player-info{display:flex;flex-direction:column;gap:0.2rem}
.player-nickname{font-size:1rem;font-weight:600}
.player-max-coins{font-size:0.9rem;opacity:0.8;display:flex;align-items:center;gap:0.3rem}
.gem-icon{width:20px;height:20px;vertical-align:middle;margin-right:0.3rem}
.player-rank{font-size:1rem;font-weight:600}
.player-stats{font-size:0.9rem;opacity:0.8}
#particleCanvas,#confettiCanvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:1;transition:opacity 0.5s ease}
#particleCanvas{z-index:-1}
#confettiCanvas{z-index:11}
main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;max-width:800px;padding:1rem;z-index:1;opacity:1;transition:opacity 0.5s ease}
.coin-counter{position:fixed;right:1rem;padding:0.75rem 1.5rem;background:none;font-size:2rem;font-weight:700;display:flex;align-items:center;gap:0.5rem;opacity:1;transition:opacity 0.5s ease;z-index:2}
.coin-counter.hidden{opacity:0;pointer-events:none}
.coin-counter.visible{opacity:1;pointer-events:auto}
.coin-icon{width:32px;height:32px;vertical-align:middle;margin-left:0.5rem}
.character{width:180px;height:180px;object-fit:contain;cursor:pointer;user-select:none;touch-action:manipulation;opacity:1;transition:opacity 0.5s ease}
.click-effect{position:absolute;width:40px;height:40px;object-fit:contain;pointer-events:none;animation:fadeOut 1s ease forwards;z-index:2;transform:translate(-50%,-50%)}
@keyframes fadeOut{0%{opacity:1;transform:translate(-50%,-50%)}100%{opacity:0;transform:translate(-50%,-70%)}}
footer{width:100%;position:fixed;bottom:0;z-index:12;display:flex;justify-content:center;align-items:center;padding:0;opacity:1;transition:opacity 0.5s ease}
.footer-menu-container{width:auto;background:var(--footer-bg);border-radius:20px 20px 0 0;display:flex;justify-content:center;align-items:center;padding:0.75rem}
.footer-menu{display:flex;justify-content:space-around;align-items:center;width:100%;gap:1rem}
.menu-item{display:flex;flex-direction:column;align-items:center;gap:0.4rem;cursor:pointer}
.menu-item img{width:64px;height:64px;object-fit:contain;border-radius:50%;background:#2E2E2E;padding:12px}
.menu-item.highlighted img{background:var(--highlight-color)}
.menu-item span{font-size:1rem;font-weight:500;color:var(--text-color);text-transform:uppercase;letter-spacing:0.5px}
.hidden-opacity{opacity:0;pointer-events:none;transition:opacity 0.5s ease}
.hidden-opacity.visible{opacity:1;pointer-events:auto}
.shop-container,.inventory-container,.market-container,.friends-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;background:var(--counter-bg);border-radius:20px;padding:1.5rem;display:flex;flex-direction:column;align-items:center;gap:1rem;z-index:3;opacity:0;transition:opacity 0.5s ease}
.shop-container.visible,.inventory-container.visible,.market-container.visible,.friends-container.visible{opacity:1;pointer-events:auto}
.shop-container.hidden,.inventory-container.hidden,.market-container.hidden,.friends-container.hidden{opacity:0;pointer-events:none}
.shop-title,.inventory-title,.market-title,.friends-title{font-size:1.5rem;font-weight:700;color:#FFF;text-transform:uppercase}
.cases-container,.inventory-items-container,.market-items-container,.friends-list-container{display:flex;justify-content:center;gap:1rem;width:100%;flex-wrap:wrap;overflow-y:auto}
.cases-container,.inventory-items-container{min-height:20vh}
.market-items-container{height:53vh}
.friends-list-container{height:40vh; overflow-y: auto;}
.case-container,.inventory-item-container,.market-item-container,.friend-item-container{width:150px;background:#2E2E2E;border-radius:16px;padding:1rem;display:flex;flex-direction:column;align-items:center;gap:0.5rem;cursor:pointer;transition:background 0.3s ease}
.case-image,.inventory-image,.market-image,.friend-avatar{width:80px;height:80px;object-fit:contain;border-radius:50%}
.case-name,.inventory-name,.market-name,.friend-name{font-size:1rem;font-weight:600;color:#FFF}
.case-price,.market-price{font-size:0.9rem;font-weight:500;color:#FFF;opacity:0.8;display:flex;align-items:center;gap:0.3rem}
.shop-arrow{position:fixed;top:50%;transform:translateY(-50%);font-size:2rem;color:#FFF;cursor:pointer;padding:0.5rem;background:rgba(30,30,30,0.85);border-radius:50%;z-index:3;opacity:0;transition:opacity 0.5s ease}
.shop-arrow.visible{opacity:1;pointer-events:auto}
.shop-arrow.hidden{opacity:0;pointer-events:none}
.shop-arrow.left{left:1rem}
.shop-arrow.right{right:1rem}
.case-animation-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(5px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;z-index:10;opacity:0;transition:opacity 0.5s ease}
.case-animation-overlay.visible{opacity:1;pointer-events:auto}
.case-animation-overlay.hidden{opacity:0;pointer-events:none}
.case-animation-message{font-size:2rem;font-weight:700;color:#FFF;text-align:center;max-width:90%;text-shadow:0 2px 4px rgba(0,0,0,0.5);opacity:0;transition:opacity 0.3s ease,transform 0.3s ease}
.case-animation-message.visible{opacity:1;transform:scale(1)}
.case-animation-message.hidden{opacity:0;transform:scale(0.9)}
.case-animation-container{width:480px;height:200px;background:#2E2E2E;border-radius:16px;display:flex;justify-content:center;align-items:center;position:relative;overflow:hidden}
.roulette-strip{width:5440px;height:100%;display:flex;flex-direction:row;align-items:center;transform:translateX(0);position:absolute;left:0;animation:roulette-slow-spin 40s linear infinite}
.roulette-item{width:120px;height:120px;margin:0 8px;display:flex;justify-content:center;align-items:center;background:#1E1E1E;border-radius:8px;position:relative;transition:transform 0.5s ease, box-shadow 0.5s ease, border 0.5s ease}
.roulette-item img{width:100px;height:100px;object-fit:contain}
.roulette-item.winner{transform:scale(1.5);border:2px solid #FFF;animation:glow-winner 1s ease-in-out infinite;z-index:10}
.animation-character{width:100px;height:100px;object-fit:contain;z-index:3}
.animation-character.mutated{filter:brightness(1.5) hue-rotate(200deg)}
.animation-background{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:8px;opacity:0.8;z-index:1}
.animation-bar{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:4px;height:90%;background:#FFF;border-radius:2px}
.case-animation-button{font-size:1.2rem;font-weight:600;color:#000;background:var(--highlight-color);padding:0.75rem 1.5rem;border-radius:16px;cursor:pointer;margin-top:1rem}
.case-animation-cancel{font-size:0.9rem;font-weight:500;color:#FFF;opacity:0.8;cursor:pointer;margin-top:0.5rem}
@keyframes roulette-slow-spin{0%{transform:translateX(0)}100%{transform:translateX(-5440px)}}
@keyframes roulette-spin{0%{transform:translateX(0)}100%{transform:translateX(-2434px)}}
@keyframes glow-winner{0%,100%{box-shadow:0 0 10px rgba(255,255,255,0.8)}50%{box-shadow:0 0 20px rgba(255,255,255,1)}}
.filters-container{display:flex;flex-wrap:wrap;justify-content:center;gap:0.5rem;width:100%;margin-bottom:1rem}
.filter-select,.sort-select{width:100%;max-width:150px;padding:0.5rem;background:#2E2E2E;border-radius:8px;color:#FFF;font-size:0.9rem;border:none;appearance:none;-webkit-appearance:none;-moz-appearance:none;background-image:url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');background-repeat:no-repeat;background-position:right 0.5rem center;background-size:16px}
.filter-select option,.sort-select option{background:#2E2E2E;color:#FFF}
.buy-button{font-size:0.9rem;font-weight:600;color:#000;background:var(--highlight-color);padding:0.5rem 1rem;border-radius:12px;cursor:pointer;margin-top:0.5rem}
.friends-container{position:fixed;top:53%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;background:var(--counter-bg);border-radius:20px;padding:1.5rem;display:flex;flex-direction:column;align-items:center;gap:1rem;z-index:3;opacity:0;transition:opacity 0.5s ease}
.friends-container.visible{opacity:1;pointer-events:auto}
.friends-container.hidden{opacity:0;pointer-events:none}
.friends-title{font-size:1.5rem;font-weight:700;color:#FFF;text-transform:uppercase}
.friends-header{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:1rem}
.friends-header img{width:32px;height:32px;cursor:pointer;filter:brightness(1.2);transition:transform 0.3s ease}
.friends-header img:hover{transform:scale(1.2)}
.invite-section{width:100%;background:#2E2E2E;border-radius:16px;padding:1rem;margin-bottom:1rem;text-align:center}
.invite-section p{font-size:1rem;color:#FFF;margin-bottom:0.5rem}
.invite-link{display:flex;flex-direction:column;align-items:center;gap:1rem}
.invite-link img{width:48px;height:48px}
.invite-link span{font-size:1.2rem;color:#A0D4FF;cursor:pointer}
.invite-link button{font-size:0.9rem;color:#000;background:#FFF;padding:0.6rem 1.2rem;border-radius:12px;cursor:pointer;transition:background 0.3s ease;transform:scale(1.2)}
.invite-link button:hover{background:#E0E0E0}
.rewards-section{width:100%;background:#2E2E2E;border-radius:16px;padding:1rem;margin-bottom:1rem}
.rewards-section p{font-size:1rem;color:#FFF;margin-bottom:0.5rem}
.rewards-section ul{list-style:none;color:#FFF}
.rewards-section li{font-size:0.9rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem}
.rewards-section li img{width:20px;height:20px}
.claim-button{font-size:0.9rem;font-weight:600;color:#000;background:#FFF;padding:0.5rem 1rem;border-radius:12px;cursor:pointer;transition:background 0.3s ease;text-align:center}
.claim-button:disabled{background:#666;color:#999;cursor:not-allowed}
.friends-list-container{height:40vh; overflow-y: auto;}
@media (max-width:600px){
.loading-percent{font-size:1.2rem}
.top-menu{top:0.8rem;width:calc(100% - 2rem);margin:0 1rem;padding:0.75rem;border-radius:16px}
.player-avatar{width:32px;height:32px}
.player-nickname{font-size:0.9rem}
.player-max-coins{font-size:0.8rem;gap:0.2rem}
.gem-icon{width:16px;height:16px;margin-right:0.2rem}
.player-rank{font-size:0.9rem}
.player-stats{font-size:0.8rem}
.coin-counter{font-size:1.5rem;padding:0.5rem 1rem;gap:0.4rem}
.coin-icon{width:24px;height:24px;margin-left:0.4rem}
.character{width:140px;height:140px}
footer{bottom:0;padding:0}
.footer-menu-container{border-radius:16px 16px 0 0;padding:0.6rem}
.footer-menu{gap:0.8rem}
.menu-item img{width:48px;height:48px;padding:10px}
.menu-item span{font-size:0.9rem}
.shop-container,.inventory-container,.market-container,.friends-container{width:85%;padding:1rem}
.shop-title,.inventory-title,.market-title,.friends-title{font-size:1.2rem}
.cases-container,.inventory-items-container,.friends-list-container{min-height:15vh}
.market-items-container{height:53vh}
.friends-list-container{height:35vh;}
.case-container,.inventory-item-container,.market-item-container,.friend-item-container{width:120px;padding:0.8rem}
.case-image,.inventory-image,.market-image,.friend-avatar{width:60px;height:60px}
.case-name,.inventory-name,.market-name,.friend-name{font-size:0.9rem}
.case-price,.market-price{font-size:0.8rem;gap:0.2rem}
.shop-arrow{font-size:1.5rem;padding:0.4rem}
.shop-arrow.left{left:0.8rem}
.shop-arrow.right{right:0.8rem}
.case-animation-message{font-size:1.5rem}
.case-animation-container{width:384px;height:160px}
.roulette-strip{width:4480px;animation:roulette-slow-spin 32s linear infinite}
.roulette-item{width:96px;height:96px;margin:0 8px}
.roulette-item img{width:80px;height:80px}
.roulette-item.winner{transform:scale(1.5);border:2px solid #FFF;animation:glow-winner 1s ease-in-out infinite}
.animation-character{width:80px;height:80px}
.animation-background{width:100%;height:100%}
.animation-bar{width:3px;height:80%}
.case-animation-button{font-size:1rem;padding:0.6rem 1.2rem;color:#000}
.case-animation-cancel{font-size:0.8rem}
.filters-container{gap:0.4rem}
.filter-select,.sort-select{max-width:120px;padding:0.4rem;font-size:0.8rem;background-size:14px}
.buy-button{font-size:0.8rem;padding:0.4rem 0.8rem}
.friends-header img{width:24px;height:24px}
.invite-section p,.rewards-section p{font-size:0.9rem}
.invite-link img{width:36px;height:36px}
.invite-link span{font-size:1rem}
.invite-link button{font-size:0.9rem;padding:0.6rem 1.2rem;transform:scale(1.2)}
.rewards-section li{font-size:0.8rem}
.rewards-section li img{width:16px;height:16px}
@keyframes roulette-slow-spin{0%{transform:translateX(0)}100%{transform:translateX(-4480px)}}
@keyframes roulette-spin{0%{transform:translateX(0)}100%{transform:translateX(-2008px)}}
@keyframes glow-winner{0%,100%{box-shadow:0 0 8px rgba(255,255,255,0.8)}50%{box-shadow:0 0 15px rgba(255,255,255,1)}}
</style>
</head>
<body>
<div class="loading-screen" id="loadingScreen">
<div class="loading-ring"></div>
<span class="loading-percent" id="loadingPercent">0%</span>
</div>
<header class="top-menu game-hidden" id="topMenu">
<div class="top-menu-left">
<img src="https://placehold.co/40x40" alt="Player Avatar" class="player-avatar" draggable="false">
<div class="player-info">
<span class="player-nickname">Player123</span>
<span class="player-max-coins">
<img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem Stone" class="gem-icon">
<span id="totalCoins">0</span>
</span>
</div>
</div>
<div class="top-menu-right">
<span class="player-rank">Rank: 1</span>
<span class="player-stats">World of Consoles</span>
</div>
</header>
<canvas id="particleCanvas" class="game-hidden"></canvas>
<canvas id="confettiCanvas" class="game-hidden"></canvas>
<main class="game-hidden" id="mainContent">
<div class="coin-counter visible" id="coinCounter">
<span id="coinCount">0</span>
<img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem Stone" class="coin-icon" draggable="false">
</div>
<img src="https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp" alt="Game Controller" class="character" id="character" draggable="false">
</main>
<div class="shop-container hidden" id="shopContainer">
<div class="shop-title">Cases</div>
<div class="cases-container">
<div class="case-container" data-case="diamond-rain">
<img src="https://em-content.zobj.net/source/telegram/386/popcorn_1f37f.webp" alt="Diamond Rain" class="case-image" draggable="false">
<div class="case-name">Diamond Rain</div>
<div class="case-price">100 Diamonds</div>
</div>
<div class="case-container" data-case="character-magic">
<img src="https://em-content.zobj.net/source/telegram/386/luggage_1f9f3.webp" alt="Character Magic" class="case-image" draggable="false">
<div class="case-name">Character Magic</div>
<div class="case-price">100 Telegram Stars</div>
</div>
</div>
</div>
<div class="inventory-container hidden" id="inventoryContainer">
<div class="inventory-title">Inventory</div>
<div class="inventory-items-container" id="inventoryItems"></div>
</div>
<div class="market-container hidden" id="marketContainer">
<div class="market-title">Market</div>
<div class="filters-container">
<select class="filter-select" id="characterFilter">
<option value="">All Characters</option>
</select>
<select class="filter-select" id="backgroundFilter">
<option value="">All Backgrounds</option>
</select>
<select class="sort-select" id="priceSort">
<option value="newest">Newest First</option>
<option value="price-desc">Price: High to Low</option>
<option value="price-asc">Price: Low to High</option>
</select>
</div>
<div class="market-items-container" id="marketItems"></div>
</div>
<div class="friends-container hidden" id="friendsContainer">
<div class="friends-title">Friends</div>
<div class="friends-header">
<img src="https://em-content.zobj.net/source/telegram/386/back-arrow_1f519.webp" alt="Back" draggable="false">
</div>
<div class="invite-section">
<p>Invite a Friend</p>
<div class="invite-link">
<img src="https://em-content.zobj.net/source/telegram/386/dizzy_1f4ab.webp" alt="Invite">
<span>https://yourgame.com/referral?code=abcdef123</span>
<button>Copy</button>
</div>
</div>
<div class="rewards-section">
<p>Rewards for Inviting</p>
<ul>
<li><img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem"> 1 friend - 100 diamonds<button class="claim-button">Claim</button></li>
<li><img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem"> 3 friends - 350 diamonds<button class="claim-button">Claim</button></li>
<li><img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem"> 5 friends - 700 diamonds<button class="claim-button">Claim</button></li>
<li><img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem"> 10 friends - 1500 diamonds<button class="claim-button">Claim</button></li>
<li><img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem"> 30 friends - 5000 diamonds<button class="claim-button">Claim</button></li>
</ul>
</div>
</div>
<div class="shop-arrow left hidden" id="shopArrowLeft"><</div>
<div class="shop-arrow right hidden" id="shopArrowRight">></div>
<footer class="game-hidden" id="footer">
<div class="footer-menu-container">
<div class="footer-menu">
<div class="menu-item highlighted" data-menu="home">
<img src="https://em-content.zobj.net/source/telegram/386/television_1f4fa.webp" alt="Home" draggable="false">
<span>Home</span>
</div>
<div class="menu-item" data-menu="shop">
<img src="https://em-content.zobj.net/source/telegram/386/crown_1f451.webp" alt="Shop" draggable="false">
<span>Shop</span>
</div>
<div class="menu-item" data-menu="market">
<img src="https://em-content.zobj.net/source/telegram/386/shopping-bags_1f6cd-fe0f.webp" alt="Market" draggable="false">
<span>Market</span>
</div>
<div class="menu-item" data-menu="games">
<img src="https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp" alt="Games" draggable="false">
<span>Games</span>
</div>
<div class="menu-item" data-menu="friends">
<img src="https://em-content.zobj.net/source/telegram/386/revolving-hearts_1f49e.webp" alt="Friends" draggable="false">
<span>Friends</span>
</div>
</div>
</div>
</footer>
<script>
const CONFIG={PARTICLE_COUNT:50,CLICK_EFFECT_DURATION:1000,RESIZE_DEBOUNCE:200,CONFETTI_COUNT:30,MAX_SCALE:1.4,MIN_SCALE:1,SCALE_INCREMENT:0.1}
const SKINS=[{src:'https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp',gradient:'radial-gradient(circle at 50% 50%,rgba(255,255,255,0.2),transparent 70%)',color:'#FFFFFF',worldName:'World of Consoles'}]
const CHARACTERS=[
{src:'https://em-content.zobj.net/source/telegram/386/monkey-face_1f435.webp',name:'Monkey'},
{src:'https://em-content.zobj.net/source/telegram/386/gorilla_1f98d.webp',name:'Gorilla'},
{src:'https://em-content.zobj.net/source/telegram/386/dog-face_1f436.webp',name:'Dog'},
{src:'https://em-content.zobj.net/source/telegram/386/cat-face_1f431.webp',name:'Cat'},
{src:'https://em-content.zobj.net/source/telegram/386/lion_1f981.webp',name:'Lion'},
{src:'https://em-content.zobj.net/source/telegram/386/tiger-face_1f42f.webp',name:'Tiger'},
{src:'https://em-content.zobj.net/source/telegram/386/hamster_1f439.webp',name:'Hamster'},
{src:'https://em-content.zobj.net/source/telegram/386/panda_1f43c.webp',name:'Panda'},
{src:'https://em-content.zobj.net/source/telegram/386/chicken_1f414.webp',name:'Chicken'},
{src:'https://em-content.zobj.net/source/telegram/386/baby-chick_1f424.webp',name:'Baby Chick'}
]
const BACKGROUND_GRADIENTS=[
'radial-gradient(circle at 30% 30%, #FF6B6B, #4ECDC4 70%)',
'linear-gradient(45deg, #FF9A8B, #FF6A88, #4A4E69)',
'radial-gradient(circle at 50% 50%, #A8E6CF, #DCFFFB 70%)',
'linear-gradient(135deg, #FFD3A5, #FD6585, #8B008B)',
'radial-gradient(circle at 70% 20%, #C4E0E5, #4CA1AF 70%)',
'linear-gradient(90deg, #FEE140, #FA709A)',
'radial-gradient(circle at 40% 60%, #FFDEE9, #B5FFFC 70%)',
'linear-gradient(180deg, #8EC5FC, #E0C3FC, #6366F1)',
'radial-gradient(circle at 20% 80%, #F4C4F3, #FC67FA 70%)',
'linear-gradient(270deg, #A1C4FD, #C2E9FB, #4B6CB7)'
]
const MUTATION_GRADIENT='radial-gradient(circle at 50% 50%, #FFD700, #FF4500 70%)';
const MARKET_SKINS=[
{id:1,character:CHARACTERS[0],background:BACKGROUND_GRADIENTS[0],price:150,timestamp:1625097600000},
{id:2,character:CHARACTERS[1],background:BACKGROUND_GRADIENTS[1],price:300,timestamp:1625184000000},
{id:3,character:CHARACTERS[2],background:BACKGROUND_GRADIENTS[2],price:200,timestamp:1625270400000},
{id:4,character:CHARACTERS[3],background:BACKGROUND_GRADIENTS[3],price:450,timestamp:1625356800000},
{id:5,character:CHARACTERS[4],background:BACKGROUND_GRADIENTS[4],price:100,timestamp:1625443200000},
{id:6,character:CHARACTERS[5],background:BACKGROUND_GRADIENTS[5],price:250,timestamp:1625529600000},
{id:7,character:CHARACTERS[6],background:BACKGROUND_GRADIENTS[6],price:350,timestamp:1625616000000},
{id:8,character:CHARACTERS[7],background:BACKGROUND_GRADIENTS[7],price:400,timestamp:1625702400000},
{id:9,character:CHARACTERS[8],background:BACKGROUND_GRADIENTS[8],price:175,timestamp:1625788800000},
{id:10,character:CHARACTERS[9],background:BACKGROUND_GRADIENTS[9],price:500,timestamp:1625875200000}
];
class GameState {
    constructor() {
        this.coins = 0;
        this.scale = CONFIG.MIN_SCALE;
        this.canInteract = true;
        this.isOverlayActive = false;
        this.isTelegram = !!(window.Telegram?.WebApp?.initData);
        this.isShopActive = false;
        this.isMarketActive = false;
        this.hasSeenShopTutorial = false;
        this.inventory = [];
        this.selectedCharacter = null;
        this.invitedFriendsCount = 0;
        this.claimedRewards = new Set();
    }
    getCoins() { return this.coins; }
    addCoins(amount) { this.coins += amount; }
    resetCoins(value) { this.coins = value; }
    isTelegramEnvironment() { return this.isTelegram; }
    isShopViewActive() { return this.isShopActive; }
    setShopViewActive(value) { this.isShopActive = value; }
    isMarketViewActive() { return this.isMarketActive; }
    setMarketViewActive(value) { this.isMarketActive = value; }
    setShopTutorialSeen() { this.hasSeenShopTutorial = true; }
    addToInventory(item) { this.inventory.push(item); }
    getInventory() { return this.inventory; }
    setSelectedCharacter(character) { this.selectedCharacter = character; }
    getSelectedCharacter() { return this.selectedCharacter; }
    incrementInvitedFriends() { this.invitedFriendsCount++; }
    getInvitedFriendsCount() { return this.invitedFriendsCount; }
    claimReward(friendCount) { this.claimedRewards.add(friendCount); }
    hasClaimedReward(friendCount) { return this.claimedRewards.has(friendCount); }
}
class ParticleSystem {
    constructor(canvas, count) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.particles = new Array(count);
        this.time = 0;
        for (let i = 0; i < count; i++) this.particles[i] = this.createParticle();
    }
    createParticle() {
        return {
            x: Math.random() * this.canvas.width,
            y: Math.random() * this.canvas.height,
            size: Math.random() * 3 + 1,
            speedX: Math.random() * 0.5 - 0.25,
            speedY: Math.random() * 0.5 - 0.25,
            opacity: Math.random() * 0.5 + 0.3
        };
    }
    update() {
        this.time += 0.016;
        for (let i = 0; i < this.particles.length; i++) {
            const p = this.particles[i];
            p.x += p.speedX;
            p.y += p.speedY;
            p.speedX += (Math.random() - 0.5) * 0.05;
            p.speedY += (Math.random() - 0.5) * 0.05;
            p.speedX = Math.max(-0.5, Math.min(0.5, p.speedX));
            p.speedY = Math.max(-0.5, Math.min(0.5, p.speedY));
            p.opacity = 0.3 + 0.5 * (Math.sin(this.time + i) + 1) / 2;
            if (p.x < 0 || p.x > this.canvas.width) p.speedX *= -1;
            if (p.y < 0 || p.y > this.canvas.height) p.speedY *= -1;
        }
    }
    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        const highlightColor = getComputedStyle(document.documentElement).getPropertyValue('--highlight-color').trim();
        let r = 255, g = 255, b = 255;
        if (highlightColor.startsWith('#')) {
            const hex = highlightColor.replace('#', '');
            r = parseInt(hex.substring(0, 2), 16);
            g = parseInt(hex.substring(2, 4), 16);
            b = parseInt(hex.substring(4, 6), 16);
        }
        for (let i = 0; i < this.particles.length; i++) {
            const p = this.particles[i];
            this.ctx.fillStyle = `rgba(${r},${g},${b},${p.opacity})`;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            this.ctx.fill();
        }
    }
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        for (let i = 0; i < this.particles.length; i++) {
            const p = this.particles[i];
            p.x = Math.random() * this.canvas.width;
            p.y = Math.random() * this.canvas.height;
        }
    }
}
class ConfettiSystem {
    constructor(canvas, count, nextColor) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.particles = [];
        this.isAnimating = false;
        this.nextColor = nextColor || '#FFFFFF';
        this.colors = ['#FFFFFF', this.nextColor];
        this.maxCount = count;
        this.spawnRate = 0.05;
        this.removeProbability = 0.02;
    }
    createParticle() {
        return {
            x: Math.random() * this.canvas.width,
            y: -Math.random() * 50,
            width: Math.random() * 3 + 3,
            height: Math.random() * 3 + 3,
            speedY: Math.random() * 2 + 2,
            opacity: 1,
            color: this.colors[Math.floor(Math.random() * this.colors.length)],
            rotation: Math.random() * Math.PI * 2
        };
    }
    update() {
        this.particles = this.particles.filter(p => {
            p.y += p.speedY;
            p.rotation += 0.05;
            if (p.y > this.canvas.height * 0.9) return Math.random() > this.removeProbability;
            return true;
        });
        if (this.particles.length < this.maxCount && Math.random() < this.spawnRate) this.particles.push(this.createParticle());
    }
    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        for (let i = 0; i < this.particles.length; i++) {
            const p = this.particles[i];
            this.ctx.save();
            this.ctx.translate(p.x + p.width / 2, p.y + p.height / 2);
            this.ctx.rotate(p.rotation);
            this.ctx.fillStyle = p.color;
            this.ctx.globalAlpha = p.opacity;
            this.ctx.fillRect(-p.width / 2, -p.height / 2, p.width, p.height);
            this.ctx.restore();
        }
    }
    start(nextColor) {
        if (this.isAnimating) return;
        if (nextColor) {
            this.nextColor = nextColor;
            this.colors = ['#FFFFFF', this.nextColor];
        }
        this.particles = [];
        for (let i = 0; i < this.maxCount; i++) {
            const p = this.createParticle();
            p.y = Math.random() * this.canvas.height;
            this.particles.push(p);
        }
        this.isAnimating = true;
        this.canvas.classList.remove('game-hidden');
        this.canvas.classList.add('visible');
        this.animate();
    }
    stop() {
        this.isAnimating = false;
        this.canvas.classList.remove('visible');
        this.canvas.classList.add('game-hidden');
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.particles = [];
    }
    animate() {
        if (!this.isAnimating) return;
        this.update();
        this.draw();
        requestAnimationFrame(() => this.animate());
    }
    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.particles = [];
        if (this.isAnimating) {
            for (let i = 0; i < this.maxCount; i++) {
                const p = this.createParticle();
                p.y = Math.random() * this.canvas.height;
                this.particles.push(p);
            }
        }
    }
}
class ClickEffectPool {
    constructor() {
        this.pool = [];
        this.active = [];
    }
    getEffect() {
        let effect = this.pool.pop();
        if (!effect) {
            effect = document.createElement('img');
            effect.src = 'https://em-content.zobj.net/source/telegram/386/collision_1f4a5.webp';
            effect.className = 'click-effect';
            effect.setAttribute('draggable', 'false');
        }
        return effect;
    }
    showEffect(x, y) {
        const effect = this.getEffect();
        effect.style.left = `${x}px`;
        effect.style.top = `${y}px`;
        document.body.appendChild(effect);
        this.active.push(effect);
        setTimeout(() => {
            effect.remove();
            this.active = this.active.filter(e => e !== effect);
            this.pool.push(effect);
        }, CONFIG.CLICK_EFFECT_DURATION);
    }
}
class UIManager {
    constructor(elements) {
        this.elements = elements;
        this.pendingUpdates = {};
    }
    updateCoinCounterPosition() {
        const topMenuHeight = this.elements.topMenu.offsetHeight;
        this.elements.coinCounter.style.top = `${topMenuHeight + 10}px`;
    }
    updateLoadingPercent(percent) {
        this.elements.loadingPercent.textContent = `${Math.round(percent)}%`;
    }
    showGameUI() {
        this.elements.loadingScreen.classList.add('hidden');
        this.elements.topMenu.classList.remove('game-hidden');
        this.elements.topMenu.classList.add('visible');
        this.elements.particleCanvas.classList.remove('game-hidden');
        this.elements.particleCanvas.classList.add('visible');
        this.elements.mainContent.classList.remove('game-hidden');
        this.elements.mainContent.classList.add('visible');
        this.elements.footer.classList.remove('game-hidden');
        this.elements.footer.classList.add('visible');
        setTimeout(() => { this.elements.loadingScreen.style.display = 'none'; }, 500);
    }
    updateCharacterScale(scale) {
        this.elements.character.style.transform = `scale(${scale})`;
    }
    queueUpdate(key, value) {
        this.pendingUpdates[key] = value;
    }
    applyUpdates() {
        requestAnimationFrame(() => {
            for (const [key, value] of Object.entries(this.pendingUpdates)) {
                if (key === 'coins') this.elements.coinCount.textContent = value;
                if (key === 'totalCoins') this.elements.totalCoins.textContent = value;
                if (key === 'characterSrc') this.elements.character.src = value;
                if (key === 'gradient') document.documentElement.style.setProperty('--bg-gradient', value);
                if (key === 'highlightColor') document.documentElement.style.setProperty('--highlight-color', value);
                if (key === 'worldName') this.elements.playerStats.textContent = value;
            }
            this.pendingUpdates = {};
            const digits = this.elements.coinCount.textContent.length;
            const translateX = digits > 5 ? -(digits - 5) * 10 : 0;
            this.elements.coinCounter.style.transform = `translateX(${translateX}px)`;
        });
    }
}
class CharacterController {
    constructor(state, ui, effectPool, confettiSystem) {
        this.state = state;
        this.ui = ui;
        this.effectPool = effectPool;
        this.confettiSystem = confettiSystem;
        this.listeners = [];
        this.lastTapTime = 0;
        this.resetTimeout = null;
    }
    initialize() {
        const currentSkin = SKINS[0];
        this.ui.queueUpdate('characterSrc', currentSkin.src);
        this.ui.queueUpdate('gradient', currentSkin.gradient);
        this.ui.queueUpdate('highlightColor', currentSkin.color);
        this.ui.queueUpdate('worldName', currentSkin.worldName);
        this.ui.applyUpdates();
        this.attachListeners();
    }
    updateAppearance() {
        const currentSkin = SKINS[0];
        const selectedCharacter = this.state.getSelectedCharacter();
        if (selectedCharacter) {
            this.ui.queueUpdate('characterSrc', selectedCharacter.src);
            this.ui.queueUpdate('gradient', selectedCharacter.isMutated ? MUTATION_GRADIENT : selectedCharacter.background || currentSkin.gradient);
            this.ui.queueUpdate('highlightColor', selectedCharacter.isMutated ? '#FFD700' : currentSkin.color);
        } else {
            this.ui.queueUpdate('characterSrc', currentSkin.src);
            this.ui.queueUpdate('gradient', currentSkin.gradient);
            this.ui.queueUpdate('highlightColor', currentSkin.color);
        }
        this.ui.queueUpdate('worldName', currentSkin.worldName);
        this.ui.applyUpdates();
    }
    handleTap(e) {
        e.preventDefault();
        const now = performance.now();
        if (now - this.lastTapTime < 100) return;
        this.lastTapTime = now;
        if (!this.state.canInteract || this.state.isOverlayActive) return;
        this.state.scale = Math.min(this.state.scale + CONFIG.SCALE_INCREMENT, CONFIG.MAX_SCALE);
        this.ui.updateCharacterScale(this.state.scale);
        this.effectPool.showEffect(e.clientX, e.clientY);
        if (this.resetTimeout) clearTimeout(this.resetTimeout);
        this.resetTimeout = setTimeout(() => {
            if (this.state.scale !== CONFIG.MIN_SCALE) {
                this.state.scale = CONFIG.MIN_SCALE;
                this.ui.updateCharacterScale(this.state.scale);
            }
        }, 1000);
    }
    attachListeners() {
        const tapListener = this.handleTap.bind(this);
        this.ui.elements.character.addEventListener('pointerdown', tapListener);
        this.listeners.push({ element: this.ui.elements.character, type: 'pointerdown', listener: tapListener });
    }
    destroy() {
        this.listeners.forEach(({ element, type, listener }) => element.removeEventListener(type, listener));
        if (this.resetTimeout) clearTimeout(this.resetTimeout);
    }
}
class Game {
    constructor(elements) {
        this.state = new GameState();
        this.ui = new UIManager(elements);
        this.particleSystem = new ParticleSystem(elements.particleCanvas, CONFIG.PARTICLE_COUNT);
        this.confettiSystem = new ConfettiSystem(elements.confettiCanvas, CONFIG.CONFETTI_COUNT, '#FFFFFF');
        this.effectPool = new ClickEffectPool();
        this.characterController = new CharacterController(this.state, this.ui, this.effectPool, this.confettiSystem);
        this.resizeTimeout = null;
        this.listeners = [];
        this.isInventoryView = false;
        this.availableMarketSkins = [...MARKET_SKINS];
    }
    async preloadAssets() {
        const imageUrls = [
            'https://placehold.co/40x40',
            ...SKINS.map(skin => skin.src),
            ...CHARACTERS.map(char => char.src),
            'https://em-content.zobj.net/source/telegram/386/television_1f4fa.webp',
            'https://em-content.zobj.net/source/telegram/386/crown_1f451.webp',
            'https://em-content.zobj.net/source/telegram/386/shopping-bags_1f6cd-fe0f.webp',
            'https://em-content.zobj.net/source/telegram/386/collision_1f4a5.webp',
            'https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp',
            'https://em-content.zobj.net/source/telegram/386/popcorn_1f37f.webp',
            'https://em-content.zobj.net/source/telegram/386/luggage_1f9f3.webp',
            'https://em-content.zobj.net/source/telegram/386/joystick_1f579-fe0f.webp',
            'https://em-content.zobj.net/source/telegram/386/revolving-hearts_1f49e.webp',
            'https://em-content.zobj.net/source/telegram/386/dizzy_1f4ab.webp',
            'https://em-content.zobj.net/source/telegram/386/back-arrow_1f519.webp'
        ];
        let loadedCount = 0;
        const totalImages = imageUrls.length;
        const loadImage = url => {
            return new Promise(resolve => {
                const img = new Image();
                img.src = url;
                img.onload = () => {
                    loadedCount++;
                    const percent = (loadedCount / totalImages) * 100;
                    this.ui.updateLoadingPercent(percent);
                    resolve();
                };
                img.onerror = () => {
                    console.warn(`Failed to load image: ${url}. Attempting fallback.`);
                    img.src = 'https://dummyimage.com/40x40/000/fff';
                    img.onload = () => {
                        loadedCount++;
                        const percent = (loadedCount / totalImages) * 100;
                        this.ui.updateLoadingPercent(percent);
                        resolve();
                    };
                    img.onerror = () => {
                        console.error(`Failed to load fallback image for: ${url}`);
                        loadedCount++;
                        const percent = (loadedCount / totalImages) * 100;
                        this.ui.updateLoadingPercent(percent);
                        resolve();
                    };
                };
            });
        };
        await Promise.all(imageUrls.map(loadImage));
        this.ui.showGameUI();
        this.characterController.initialize();
    }
    updateInventoryDisplay() {
        const inventoryContainer = this.ui.elements.inventoryItems;
        inventoryContainer.innerHTML = '';
        const inventory = this.state.getInventory();
        inventory.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item-container';
            itemDiv.style.background = item.background;
            itemDiv.style.boxShadow = '0 0 10px rgba(255,255,255,0.3)';
            const img = document.createElement('img');
            img.src = item.src;
            img.alt = item.name;
            img.className = 'inventory-image';
            if (item.isMutated) img.className += ' mutated';
            const nameDiv = document.createElement('div');
            nameDiv.className = 'inventory-name';
            nameDiv.textContent = item.name;
            itemDiv.appendChild(img);
            itemDiv.appendChild(nameDiv);
            itemDiv.addEventListener('pointerdown', () => {
                this.state.setSelectedCharacter(item);
                this.ui.elements.inventoryContainer.classList.remove('visible');
                this.ui.elements.inventoryContainer.classList.add('hidden');
                this.ui.elements.shopContainer.classList.remove('hidden');
                this.ui.elements.shopContainer.classList.add('visible');
                this.isInventoryView = false;
                this.characterController.updateAppearance();
            });
            inventoryContainer.appendChild(itemDiv);
        });
    }
    initializeMarketFilters() {
        const characterFilter = this.ui.elements.characterFilter;
        const backgroundFilter = this.ui.elements.backgroundFilter;
        CHARACTERS.forEach(char => {
            const option = document.createElement('option');
            option.value = char.name;
            option.textContent = char.name;
            characterFilter.appendChild(option);
        });
        BACKGROUND_GRADIENTS.forEach((bg, index) => {
            const option = document.createElement('option');
            option.value = bg;
            option.textContent = `Background ${index + 1}`;
            backgroundFilter.appendChild(option);
        });
    }
    updateMarketDisplay() {
        const marketContainer = this.ui.elements.marketItems;
        marketContainer.innerHTML = '';
        let filteredSkins = [...this.availableMarketSkins];
        const characterFilter = this.ui.elements.characterFilter.value;
        const backgroundFilter = this.ui.elements.backgroundFilter.value;
        const sortOption = this.ui.elements.priceSort.value;
        if (characterFilter) {
            filteredSkins = filteredSkins.filter(skin => skin.character.name === characterFilter);
        }
        if (backgroundFilter) {
            filteredSkins = filteredSkins.filter(skin => skin.background === backgroundFilter);
        }
        if (sortOption === 'price-desc') {
            filteredSkins.sort((a, b) => b.price - a.price);
        } else if (sortOption === 'price-asc') {
            filteredSkins.sort((a, b) => a.price - b.price);
        } else {
            filteredSkins.sort((a, b) => b.timestamp - a.timestamp);
        }
        filteredSkins.forEach(skin => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'market-item-container';
            itemDiv.style.background = skin.background;
            itemDiv.style.boxShadow = '0 0 10px rgba(255,255,255,0.3)';
            itemDiv.style.minHeight = '200px';
            const img = document.createElement('img');
            img.src = skin.character.src;
            img.alt = skin.character.name;
            img.className = 'market-image';
            const nameDiv = document.createElement('div');
            nameDiv.className = 'market-name';
            nameDiv.textContent = skin.character.name;
            const priceDiv = document.createElement('div');
            priceDiv.className = 'market-price';
            priceDiv.innerHTML = `
                <span>${skin.price}</span>
                <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem Stone" class="gem-icon">
            `;
            const buyButton = document.createElement('div');
            buyButton.className = 'buy-button';
            buyButton.textContent = 'Buy';
            buyButton.addEventListener('pointerdown', () => {
                if (this.state.getCoins() >= skin.price) {
                    this.state.addCoins(-skin.price);
                    this.state.addToInventory({
                        src: skin.character.src,
                        name: skin.character.name,
                        background: skin.background,
                        isMutated: false
                    });
                    this.availableMarketSkins = this.availableMarketSkins.filter(s => s.id !== skin.id);
                    this.updateMarketDisplay();
                    this.ui.queueUpdate('coins', this.state.getCoins());
                    this.ui.queueUpdate('totalCoins', this.state.getCoins());
                    this.ui.applyUpdates();
                } else {
                    alert('Not enough diamonds!');
                }
            });
            itemDiv.appendChild(img);
            itemDiv.appendChild(nameDiv);
            itemDiv.appendChild(priceDiv);
            itemDiv.appendChild(buyButton);
            marketContainer.appendChild(itemDiv);
        });
    }
    showCaseAnimation(caseType) {
        const isDiamondCase = caseType === 'diamond-rain';
        const currency = isDiamondCase ? 'Diamonds' : 'Telegram Stars';
        const overlay = document.createElement('div');
        overlay.className = 'case-animation-overlay hidden';
        const message = document.createElement('div');
        message.className = 'case-animation-message hidden';
        message.textContent = `Wondering what you'll get? Spin for 100 ${currency}!`;
        const animationContainer = document.createElement('div');
        animationContainer.id = 'caseAnimationContainer';
        animationContainer.className = 'case-animation-container';
        const rouletteStrip = document.createElement('div');
        rouletteStrip.className = 'roulette-strip';
        animationContainer.appendChild(rouletteStrip);
        const animationBar = document.createElement('div');
        animationBar.className = 'animation-bar';
        animationContainer.appendChild(animationBar);
        const spinButton = document.createElement('div');
        spinButton.className = 'case-animation-button';
        spinButton.textContent = 'Spin';
        const cancelButton = document.createElement('div');
        cancelButton.className = 'case-animation-cancel';
        cancelButton.textContent = "I'll stop tempting fate";
        overlay.appendChild(message);
        overlay.appendChild(animationContainer);
        overlay.appendChild(spinButton);
        overlay.appendChild(cancelButton);
        document.body.appendChild(overlay);
        const items = [...CHARACTERS];
        const diamondItem = { src: 'https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp', name: 'Diamonds' };
        if (isDiamondCase) {
            items.push(diamondItem);
        }
        const rouletteItems = [];
        const reward = this.generateCaseReward(caseType);
        for (let i = 0; i < 40; i++) {
            if (i === 19) {
                rouletteItems.push(reward);
                continue;
            }
            let randomItem;
            if (isDiamondCase && Math.random() < 0.6) {
                randomItem = diamondItem;
            } else {
                randomItem = items[Math.floor(Math.random() * (isDiamondCase ? items.length : CHARACTERS.length))];
            }
            rouletteItems.push({
                ...randomItem,
                isMutated: randomItem.name !== 'Diamonds' && Math.random() < 0.1,
                background: BACKGROUND_GRADIENTS[Math.floor(Math.random() * BACKGROUND_GRADIENTS.length)],
                value: randomItem.name === 'Diamonds' ? Math.floor(Math.random() * 250) + 1 : undefined
            });
        }
        const renderRoulette = () => {
            rouletteStrip.innerHTML = '';
            rouletteItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'roulette-item';
                itemDiv.dataset.itemName = item.name;
                itemDiv.style.background = item.background;
                itemDiv.style.boxShadow = '0 0 10px rgba(255,255,255,0.3)';
                const bgDiv = document.createElement('div');
                bgDiv.className = 'animation-background';
                bgDiv.style.background = item.background;
                itemDiv.appendChild(bgDiv);
                const img = document.createElement('img');
                img.src = item.src;
                img.alt = item.name;
                img.className = 'animation-character';
                if (item.isMutated && item.name !== 'Diamonds') img.className += ' mutated';
                itemDiv.appendChild(img);
                if (index === 19) {
                    itemDiv.dataset.winner = 'true';
                }
                rouletteStrip.appendChild(itemDiv);
            });
        };
        renderRoulette();
        requestAnimationFrame(() => {
            overlay.classList.remove('hidden');
            overlay.classList.add('visible');
            message.classList.remove('hidden');
            message.classList.add('visible');
            setTimeout(() => {
                spinButton.className += ' visible';
                cancelButton.className += ' visible';
            }, 300);
        });
        const onCancel = () => {
            overlay.classList.remove('visible');
            overlay.classList.add('hidden');
            message.classList.remove('visible');
            message.classList.add('hidden');
            spinButton.classList.remove('visible');
            cancelButton.classList.remove('visible');
            setTimeout(() => {
                overlay.remove();
                this.state.isOverlayActive = false;
            }, 500);
            cancelButton.removeEventListener('pointerdown', onCancel);
        };
        cancelButton.addEventListener('pointerdown', onCancel);
        const startRoulette = () => {
            spinButton.style.pointerEvents = 'none';
            spinButton.style.opacity = '0.5';
            rouletteStrip.style.opacity = '1';
            rouletteStrip.style.animation = 'roulette-spin 5s cubic-bezier(0.1, 0.7, 0.3, 1) forwards';
            const onAnimationEnd = () => {
                const isMobile = window.innerWidth <= 600;
                rouletteStrip.style.transform = isMobile ? 'translateX(-2008px)' : 'translateX(-2434px)';
                const winnerIndex = 19;
                const winnerItem = rouletteStrip.children[winnerIndex];
                if (winnerItem) {
                    const img = winnerItem.querySelector('img');
                    if (img) {
                        img.src = reward.src;
                        img.alt = reward.name;
                        img.className = 'animation-character';
                        if (reward.isMutated && reward.name !== 'Diamonds') img.className += ' mutated';
                    }
                    const bgDiv = winnerItem.querySelector('.animation-background');
                    if (bgDiv) {
                        bgDiv.style.background = reward.background;
                    }
                    winnerItem.dataset.itemName = reward.name;
                    winnerItem.style.background = reward.background;
                    winnerItem.style.boxShadow = '0 0 10px rgba(255,255,255,0.3)';
                    winnerItem.dataset.winner = 'true';
                    winnerItem.classList.add('winner');
                    message.textContent = `You won ${reward.name === 'Diamonds' ? `${reward.value} Diamonds` : reward.name}${reward.isMutated && reward.name !== 'Diamonds' ? ' (Mutated)' : ''}!`;
                    if (reward.name === 'Diamonds') {
                        this.state.addCoins(reward.value);
                        this.ui.queueUpdate('coins', this.state.getCoins());
                        this.ui.queueUpdate('totalCoins', this.state.getCoins());
                    } else {
                        this.state.addToInventory(reward);
                    }
                    this.ui.applyUpdates();
                    setTimeout(() => {
                        overlay.classList.remove('visible');
                        overlay.classList.add('hidden');
                        message.classList.remove('visible');
                        message.classList.add('hidden');
                        spinButton.classList.remove('visible');
                        cancelButton.classList.remove('visible');
                        setTimeout(() => {
                            overlay.remove();
                            this.state.isOverlayActive = false;
                            rouletteStrip.style.opacity = '1';
                        }, 500);
                    }, 2000);
                }
                rouletteStrip.removeEventListener('animationend', onAnimationEnd);
            };
            rouletteStrip.addEventListener('animationend', onAnimationEnd);
        };
        spinButton.addEventListener('pointerdown', startRoulette);
    }
    generateCaseReward(caseType) {
        const isDiamondCase = caseType === 'diamond-rain';
        const background = BACKGROUND_GRADIENTS[Math.floor(Math.random() * BACKGROUND_GRADIENTS.length)];
        if (isDiamondCase) {
            const roll = Math.random();
            if (roll < 0.95) {
                const diamonds = Math.floor(Math.random() * 250) + 1;
                return {
                    type: 'diamonds',
                    name: 'Diamonds',
                    value: diamonds,
                    isMutated: false,
                    background,
                    src: 'https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp'
                };
            } else {
                const characterIndex = Math.floor(Math.random() * CHARACTERS.length);
                const character = CHARACTERS[characterIndex];
                const isMutated = Math.random() < 0.1;
                return {
                    type: 'character',
                    character,
                    isMutated,
                    background,
                    name: character.name,
                    src: character.src
                };
            }
        } else {
            const characterIndex = Math.floor(Math.random() * CHARACTERS.length);
            const character = CHARACTERS[characterIndex];
            const isMutated = Math.random() < 0.1;
            return {
                type: 'character',
                character,
                isMutated,
                background,
                name: character.name,
                src: character.src
            };
        }
    }
    handleMenuClick(e) {
        const menuItem = e.target.closest('.menu-item');
        if (!menuItem) return;
        const menuType = menuItem.dataset.menu;
        document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('highlighted'));
        menuItem.classList.add('highlighted');
        if (menuType === 'home') {
            this.state.setShopViewActive(false);
            this.state.setMarketViewActive(false);
            this.ui.elements.mainContent.classList.remove('hidden-opacity');
            this.ui.elements.mainContent.classList.add('visible');
            this.ui.elements.coinCounter.classList.remove('hidden');
            this.ui.elements.coinCounter.classList.add('visible');
            this.ui.elements.character.classList.remove('hidden-opacity');
            this.ui.elements.character.classList.add('visible');
            this.ui.elements.shopContainer.classList.remove('visible');
            this.ui.elements.shopContainer.classList.add('hidden');
            this.ui.elements.inventoryContainer.classList.remove('visible');
            this.ui.elements.inventoryContainer.classList.add('hidden');
            this.ui.elements.marketContainer.classList.remove('visible');
            this.ui.elements.marketContainer.classList.add('hidden');
            this.ui.elements.friendsContainer.classList.remove('visible');
            this.ui.elements.friendsContainer.classList.add('hidden');
            this.ui.elements.shopArrowLeft.classList.remove('visible');
            this.ui.elements.shopArrowLeft.classList.add('hidden');
            this.ui.elements.shopArrowRight.classList.remove('visible');
            this.ui.elements.shopArrowRight.classList.add('hidden');
            this.isInventoryView = false;
            this.characterController.updateAppearance();
        } else if (menuType === 'shop') {
            this.state.setShopViewActive(true);
            this.state.setMarketViewActive(false);
            this.ui.elements.mainContent.classList.remove('visible');
            this.ui.elements.mainContent.classList.add('hidden-opacity');
            this.ui.elements.coinCounter.classList.remove('hidden');
            this.ui.elements.coinCounter.classList.add('visible');
            this.ui.elements.character.classList.remove('visible');
            this.ui.elements.character.classList.add('hidden-opacity');
            this.ui.elements.shopContainer.classList.remove('hidden');
            this.ui.elements.shopContainer.classList.add('visible');
            this.ui.elements.inventoryContainer.classList.remove('visible');
            this.ui.elements.inventoryContainer.classList.add('hidden');
            this.ui.elements.marketContainer.classList.remove('visible');
            this.ui.elements.marketContainer.classList.add('hidden');
            this.ui.elements.friendsContainer.classList.remove('visible');
            this.ui.elements.friendsContainer.classList.add('hidden');
            this.ui.elements.shopArrowLeft.classList.remove('hidden');
            this.ui.elements.shopArrowLeft.classList.add('visible');
            this.ui.elements.shopArrowRight.classList.remove('hidden');
            this.ui.elements.shopArrowRight.classList.add('visible');
            this.isInventoryView = false;
            if (!this.state.hasSeenShopTutorial) {
                this.state.setShopTutorialSeen();
            }
        } else if (menuType === 'market') {
            this.state.setShopViewActive(false);
            this.state.setMarketViewActive(true);
            this.ui.elements.mainContent.classList.remove('visible');
            this.ui.elements.mainContent.classList.add('hidden-opacity');
            this.ui.elements.coinCounter.classList.remove('hidden');
            this.ui.elements.coinCounter.classList.add('visible');
            this.ui.elements.character.classList.remove('visible');
            this.ui.elements.character.classList.add('hidden-opacity');
            this.ui.elements.shopContainer.classList.remove('visible');
            this.ui.elements.shopContainer.classList.add('hidden');
            this.ui.elements.inventoryContainer.classList.remove('visible');
            this.ui.elements.inventoryContainer.classList.add('hidden');
            this.ui.elements.marketContainer.classList.remove('hidden');
            this.ui.elements.marketContainer.classList.add('visible');
            this.ui.elements.friendsContainer.classList.remove('visible');
            this.ui.elements.friendsContainer.classList.add('hidden');
            this.ui.elements.shopArrowLeft.classList.remove('visible');
            this.ui.elements.shopArrowLeft.classList.add('hidden');
            this.ui.elements.shopArrowRight.classList.remove('visible');
            this.ui.elements.shopArrowRight.classList.add('hidden');
            this.isInventoryView = false;
            this.updateMarketDisplay();
        } else if (menuType === 'games') {
            this.state.setShopViewActive(false);
            this.state.setMarketViewActive(false);
            this.ui.elements.mainContent.classList.remove('visible');
            this.ui.elements.mainContent.classList.add('hidden-opacity');
            this.ui.elements.coinCounter.classList.remove('visible');
            this.ui.elements.coinCounter.classList.add('hidden');
            this.ui.elements.character.classList.remove('visible');
            this.ui.elements.character.classList.add('hidden-opacity');
            this.ui.elements.shopContainer.classList.remove('visible');
            this.ui.elements.shopContainer.classList.add('hidden');
            this.ui.elements.inventoryContainer.classList.remove('visible');
            this.ui.elements.inventoryContainer.classList.add('hidden');
            this.ui.elements.marketContainer.classList.remove('visible');
            this.ui.elements.marketContainer.classList.add('hidden');
            this.ui.elements.friendsContainer.classList.remove('visible');
            this.ui.elements.friendsContainer.classList.add('hidden');
            this.ui.elements.shopArrowLeft.classList.remove('visible');
            this.ui.elements.shopArrowLeft.classList.add('hidden');
            this.ui.elements.shopArrowRight.classList.remove('visible');
            this.ui.elements.shopArrowRight.classList.add('hidden');
            this.isInventoryView = false;
        } else if (menuType === 'friends') {
            this.state.setShopViewActive(false);
            this.state.setMarketViewActive(false);
            this.ui.elements.mainContent.classList.remove('visible');
            this.ui.elements.mainContent.classList.add('hidden-opacity');
            this.ui.elements.coinCounter.classList.remove('visible');
            this.ui.elements.coinCounter.classList.add('hidden');
            this.ui.elements.character.classList.remove('visible');
            this.ui.elements.character.classList.add('hidden-opacity');
            this.ui.elements.shopContainer.classList.remove('visible');
            this.ui.elements.shopContainer.classList.add('hidden');
            this.ui.elements.inventoryContainer.classList.remove('visible');
            this.ui.elements.inventoryContainer.classList.add('hidden');
            this.ui.elements.marketContainer.classList.remove('visible');
            this.ui.elements.marketContainer.classList.add('hidden');
            this.ui.elements.friendsContainer.classList.remove('hidden');
            this.ui.elements.friendsContainer.classList.add('visible');
            this.ui.elements.shopArrowLeft.classList.remove('visible');
            this.ui.elements.shopArrowLeft.classList.add('hidden');
            this.ui.elements.shopArrowRight.classList.remove('visible');
            this.ui.elements.shopArrowRight.classList.add('hidden');
            this.isInventoryView = false;

            // Очистка предыдущего содержимого
            this.ui.elements.friendsContainer.innerHTML = '';

            // Секция приглашения
            const inviteSection = document.createElement('div');
            inviteSection.className = 'invite-section';
            const inviteTitle = document.createElement('p');
            inviteTitle.textContent = 'Invite a Friend';
            const inviteLink = document.createElement('div');
            inviteLink.className = 'invite-link';
            const linkText = document.createElement('span');
            linkText.textContent = 'https://yourgame.com/referral?code=' + Math.random().toString(36).substr(2, 9);
            const inviteIcon = document.createElement('img');
            inviteIcon.src = 'https://em-content.zobj.net/source/telegram/386/dizzy_1f4ab.webp';
            inviteIcon.alt = 'Invite';
            const copyButton = document.createElement('button');
            copyButton.textContent = 'Copy';
            copyButton.addEventListener('pointerdown', () => {
                navigator.clipboard.writeText(linkText.textContent).then(() => {
                    alert('Referral link copied!');
                    this.state.incrementInvitedFriends();
                    this.handleMenuClick({ target: menuItem }); // Перезагрузка меню для обновления наград
                });
            });
            inviteLink.appendChild(inviteIcon);
            inviteLink.appendChild(linkText);
            inviteLink.appendChild(copyButton);
            inviteSection.appendChild(inviteTitle);
            inviteSection.appendChild(inviteLink);

            // Секция наград
            const rewardsSection = document.createElement('div');
            rewardsSection.className = 'rewards-section';
            const rewardsTitle = document.createElement('p');
            rewardsTitle.textContent = 'Rewards for Inviting';
            const rewardsList = document.createElement('ul');
            const rewardsData = [
                { count: 1, diamonds: 100 },
                { count: 3, diamonds: 350 },
                { count: 5, diamonds: 700 },
                { count: 10, diamonds: 1500 },
                { count: 30, diamonds: 5000 }
            ];
            rewardsData.forEach(reward => {
                const li = document.createElement('li');
                const canClaim = this.state.getInvitedFriendsCount() >= reward.count && !this.state.hasClaimedReward(reward.count);
                li.innerHTML = `<img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem"> ${reward.count} friend${reward.count > 1 ? 's' : ''} - ${reward.diamonds} diamonds`;
                const claimButton = document.createElement('button');
                claimButton.className = 'claim-button';
                claimButton.textContent = this.state.hasClaimedReward(reward.count) ? 'Claimed' : 'Claim';
                claimButton.disabled = !canClaim || this.state.hasClaimedReward(reward.count);
                claimButton.addEventListener('pointerdown', () => {
                    if (canClaim) {
                        this.state.addCoins(reward.diamonds);
                        this.state.claimReward(reward.count);
                        this.ui.queueUpdate('coins', this.state.getCoins());
                        this.ui.queueUpdate('totalCoins', this.state.getCoins());
                        this.ui.applyUpdates();
                        claimButton.textContent = 'Claimed';
                        claimButton.disabled = true;
                    }
                });
                li.appendChild(claimButton);
                rewardsList.appendChild(li);
            });
            rewardsSection.appendChild(rewardsTitle);
            rewardsSection.appendChild(rewardsList);

            // Сборка страницы
            this.ui.elements.friendsContainer.appendChild(inviteSection);
            this.ui.elements.friendsContainer.appendChild(rewardsSection);
        }
    }
    handleArrowClick(e) {
        const arrow = e.target.closest('.shop-arrow');
        if (!arrow) return;
        if (arrow.id === 'shopArrowRight') {
            this.isInventoryView = true;
            this.ui.elements.shopContainer.classList.remove('visible');
            this.ui.elements.shopContainer.classList.add('hidden');
            this.ui.elements.inventoryContainer.classList.remove('hidden');
            this.ui.elements.inventoryContainer.classList.add('visible');
            this.updateInventoryDisplay();
        } else if (arrow.id === 'shopArrowLeft') {
            this.isInventoryView = false;
            this.ui.elements.shopContainer.classList.remove('hidden');
            this.ui.elements.shopContainer.classList.add('visible');
            this.ui.elements.inventoryContainer.classList.remove('visible');
            this.ui.elements.inventoryContainer.classList.add('hidden');
        }
    }
    init() {
        this.state.addCoins(1000);
        this.ui.queueUpdate('coins', this.state.getCoins());
        this.ui.queueUpdate('totalCoins', this.state.getCoins());
        this.ui.applyUpdates();
        this.particleSystem.resize();
        this.confettiSystem.resize();
        this.ui.updateCoinCounterPosition();
        this.preloadAssets();
        this.initializeMarketFilters();
        const animate = () => {
            this.particleSystem.update();
            this.particleSystem.draw();
            requestAnimationFrame(animate);
        };
        animate();
        const resizeHandler = () => {
            clearTimeout(this.resizeTimeout);
            this.resizeTimeout = setTimeout(() => {
                this.particleSystem.resize();
                this.confettiSystem.resize();
                this.ui.updateCoinCounterPosition();
            }, CONFIG.RESIZE_DEBOUNCE);
        };
        window.addEventListener('resize', resizeHandler);
        this.listeners.push({ element: window, type: 'resize', listener: resizeHandler });
        const menuClickHandler = this.handleMenuClick.bind(this);
        this.ui.elements.footer.addEventListener('pointerdown', menuClickHandler);
        this.listeners.push({ element: this.ui.elements.footer, type: 'pointerdown', listener: menuClickHandler });
        const caseClickHandler = (e) => {
            const caseItem = e.target.closest('.case-container');
            if (!caseItem) return;
            const caseType = caseItem.dataset.case;
            if (caseType) {
                this.state.isOverlayActive = true;
                this.showCaseAnimation(caseType);
            }
        };
        this.ui.elements.shopContainer.addEventListener('pointerdown', caseClickHandler);
        this.listeners.push({ element: this.ui.elements.shopContainer, type: 'pointerdown', listener: caseClickHandler });
        const arrowClickHandler = this.handleArrowClick.bind(this);
        this.ui.elements.shopArrowLeft.addEventListener('pointerdown', arrowClickHandler);
        this.ui.elements.shopArrowRight.addEventListener('pointerdown', arrowClickHandler);
        this.listeners.push({ element: this.ui.elements.shopArrowLeft, type: 'pointerdown', listener: arrowClickHandler });
        this.listeners.push({ element: this.ui.elements.shopArrowRight, type: 'pointerdown', listener: arrowClickHandler });
        const filterChangeHandler = () => this.updateMarketDisplay();
        this.ui.elements.characterFilter.addEventListener('change', filterChangeHandler);
        this.ui.elements.backgroundFilter.addEventListener('change', filterChangeHandler);
        this.ui.elements.priceSort.addEventListener('change', filterChangeHandler);
        this.listeners.push({ element: this.ui.elements.characterFilter, type: 'change', listener: filterChangeHandler });
        this.listeners.push({ element: this.ui.elements.backgroundFilter, type: 'change', listener: filterChangeHandler });
        this.listeners.push({ element: this.ui.elements.priceSort, type: 'change', listener: filterChangeHandler });
        if (this.state.isTelegramEnvironment()) document.documentElement.dataset.telegram = 'true';
    }
    destroy() {
        this.listeners.forEach(({ element, type, listener }) => element.removeEventListener(type, listener));
        this.characterController.destroy();
    }
}
document.addEventListener('DOMContentLoaded', () => {
    const elements = {
        loadingScreen: document.getElementById('loadingScreen'),
        loadingPercent: document.getElementById('loadingPercent'),
        topMenu: document.getElementById('topMenu'),
        particleCanvas: document.getElementById('particleCanvas'),
        confettiCanvas: document.getElementById('confettiCanvas'),
        mainContent: document.getElementById('mainContent'),
        coinCounter: document.getElementById('coinCounter'),
        coinCount: document.getElementById('coinCount'),
        totalCoins: document.getElementById('totalCoins'),
        character: document.getElementById('character'),
        footer: document.getElementById('footer'),
        playerStats: document.querySelector('.player-stats'),
        shopContainer: document.getElementById('shopContainer'),
        inventoryContainer: document.getElementById('inventoryContainer'),
        inventoryItems: document.getElementById('inventoryItems'),
        marketContainer: document.getElementById('marketContainer'),
        marketItems: document.getElementById('marketItems'),
        friendsContainer: document.getElementById('friendsContainer'),
        characterFilter: document.getElementById('characterFilter'),
        backgroundFilter: document.getElementById('backgroundFilter'),
        priceSort: document.getElementById('priceSort'),
        shopArrowLeft: document.getElementById('shopArrowLeft'),
        shopArrowRight: document.getElementById('shopArrowRight')
    };
    const game = new Game(elements);
    game.init();
});

</script>
</body>
</html>