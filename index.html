<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Social Web3 casual game inspired by Notcoin">
    <title>Игра с Кейсами</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus, *:active {
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-color: #000000;
            --bg-gradient: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2), transparent 70%);
            --highlight-color: #FFFFFF;
            --text-color: #ffffff;
            --footer-bg: rgba(30, 30, 30, 0.85);
            --top-menu-bg: rgba(30, 30, 30, 0.85);
            --tg-bg-color: linear-gradient(135deg, #1c2526, #2a1b3d);
            --tg-text-color: #ffffff;
            --tg-footer-bg: rgba(44, 47, 71, 0.85);
            --tg-top-menu-bg: rgba(44, 47, 71, 0.85);
        }

        [data-telegram="true"] {
            --bg-color: var(--tg-bg-color);
            --text-color: var(--tg-text-color);
            --footer-bg: var(--tg-footer-bg);
            --top-menu-bg: var(--tg-top-menu-bg);
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            background-image: var(--bg-gradient);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-ring {
            width: 100px;
            height: 100px;
            border: 8px solid transparent;
            border-top-color: rgba(255, 255, 255, 0.8);
            border-right-color: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-percent {
            position: absolute;
            bottom: 2rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #FFFFFF;
        }

        .game-hidden {
            display: none;
        }

        .top-menu {
            position: fixed;
            top: 1rem;
            width: calc(100% - 3rem);
            margin: 0 1.5rem;
            background: var(--top-menu-bg);
            border-radius: 20px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2;
        }

        .top-menu-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .top-menu-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.2rem;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .player-nickname {
            font-size: 1rem;
            font-weight: 600;
        }

        .player-diamonds {
            font-size: 0.9rem;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .gem-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 0.3rem;
        }

        .player-rank {
            font-size: 1rem;
            font-weight: 600;
        }

        .player-stats {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #particleCanvas, #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #particleCanvas {
            z-index: -1;
        }

        #confettiCanvas {
            z-index: 11;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 800px;
            padding: 1rem;
            z-index: 1;
        }

        .section {
            width: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .section.active {
            display: flex;
        }

        .character {
            width: 180px;
            height: 180px;
            object-fit: contain;
            user-select: none;
        }

        footer {
            width: 100%;
            height: 16vh;
            position: fixed;
            bottom: 1rem;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 1rem;
        }

        .footer-menu-container {
            width: auto;
            background: var(--footer-bg);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.75rem;
        }

        .footer-menu {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            gap: 1rem;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
        }

        .menu-item img {
            width: 64px;
            height: 64px;
            object-fit: contain;
            border-radius: 50%;
            background: #2E2E2E;
            padding: 12px;
        }

        .menu-item.highlighted img {
            background: var(--highlight-color);
        }

        .menu-item span {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .case-container, .inventory-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .case-item, .inventory-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .case-item img, .inventory-item img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 10px;
            background: #2E2E2E;
            padding: 10px;
        }

        .case-item span, .inventory-item span {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .inventory-tabs {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .tab-button {
            background: #2E2E2E;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .tab-button.active {
            background: var(--highlight-color);
            color: #000;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .case-result {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .case-result.active {
            display: flex;
        }

        @media (max-width: 600px) {
            .loading-percent {
                font-size: 1.2rem;
            }

            .top-menu {
                top: 0.8rem;
                width: calc(100% - 2rem);
                margin: 0 1rem;
                padding: 0.75rem;
                border-radius: 16px;
            }

            .player-avatar {
                width: 32px;
                height: 32px;
            }

            .player-nickname {
                font-size: 0.9rem;
            }

            .player-diamonds {
                font-size: 0.8rem;
                gap: 0.2rem;
            }

            .gem-icon {
                width: 16px;
                height: 16px;
                margin-right: 0.2rem;
            }

            .player-rank {
                font-size: 0.9rem;
            }

            .player-stats {
                font-size: 0.8rem;
            }

            .character {
                width: 140px;
                height: 140px;
            }

            footer {
                height: 14vh;
                bottom: 0.8rem;
                padding: 0 0.8rem;
            }

            .footer-menu-container {
                border-radius: 16px;
                padding: 0.6rem;
            }

            .footer-menu {
                gap: 0.8rem;
            }

            .menu-item img {
                width: 48px;
                height: 48px;
                padding: 10px;
            }

            .menu-item span {
                font-size: 0.9rem;
            }

            .section-title {
                font-size: 1.2rem;
            }

            .case-item img, .inventory-item img {
                width: 60px;
                height: 60px;
            }

            .case-item span, .inventory-item span {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-ring"></div>
        <span class="loading-percent" id="loadingPercent">0%</span>
    </div>
    <header class="top-menu game-hidden" id="topMenu">
        <div class="top-menu-left">
            <img src="https://placehold.co/40x40" alt="Аватар игрока" class="player-avatar" draggable="false">
            <div class="player-info">
                <span class="player-nickname">Игрок123</span>
                <span class="player-diamonds">
                    <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Алмаз" class="gem-icon">
                    <span id="totalDiamonds">1000</span>
                </span>
            </div>
        </div>
        <div class="top-menu-right">
            <span class="player-rank">Ранг: 1</span>
            <span class="player-stats">Косметический мир</span>
        </div>
    </header>
    <canvas id="particleCanvas" class="game-hidden"></canvas>
    <canvas id="confettiCanvas" class="game-hidden"></canvas>
    <main class="game-hidden" id="mainContent">
        <div class="section active" id="homeSection">
            <img src="https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp" alt="Персонаж" class="character" id="character" draggable="false">
        </div>
        <div class="section" id="marketSection">
            <h2 class="section-title">Маркет</h2>
            <div class="case-container">
                <div class="case-item" data-case="skin">
                    <img src="https://em-content.zobj.net/source/telegram/386/moai_1f5ff.webp" alt="Кейс скинов">
                    <span>Кейс со скинами (100 алмазов)</span>
                </div>
                <div class="case-item" data-case="background">
                    <img src="https://em-content.zobj.net/source/telegram/386/rocket_1f680.webp" alt="Кейс фонов">
                    <span>Кейс с фонами (100 алмазов)</span>
                </div>
            </div>
            <div class="case-result" id="caseResult">
                <h3>Вы получили!</h3>
                <div class="case-item" id="caseResultItem">
                    <img src="" alt="" id="caseResultImage">
                    <span id="caseResultName"></span>
                </div>
            </div>
        </div>
        <div class="section" id="inventorySection">
            <h2 class="section-title">Инвентарь</h2>
            <div class="inventory-tabs">
                <button class="tab-button active" data-tab="skins">Скины</button>
                <button class="tab-button" data-tab="backgrounds">Фоны</button>
            </div>
            <div class="inventory-container" id="inventoryContent"></div>
        </div>
    </main>
    <footer class="game-hidden" id="footer">
        <div class="footer-menu-container">
            <div class="footer-menu">
                <div class="menu-item highlighted" data-menu="home">
                    <img src="https://em-content.zobj.net/source/telegram/386/television_1f4fa.webp" alt="Главная" draggable="false">
                    <span>Главная</span>
                </div>
                <div class="menu-item" data-menu="inventory">
                    <img src="https://em-content.zobj.net/source/telegram/386/backpack_1f392.webp" alt="Инвентарь" draggable="false">
                    <span>Инвентарь</span>
                </div>
                <div class="menu-item" data-menu="market">
                    <img src="https://em-content.zobj.net/source/telegram/386/crown_1f451.webp" alt="Маркет" draggable="false">
                    <span>Маркет</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        /**
         * Constants for game configuration
         */
        const CONFIG = {
            PARTICLE_COUNT: 50,
            CONFETTI_COUNT: 30,
            RESIZE_DEBOUNCE: 200,
            CASE_COST: 100 // Cost of each case in diamonds
        };

        /**
         * Skin and background configuration
         */
        const SKINS = [
            { id: 'console', name: 'Консоль', src: 'https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp' },
            { id: 'car', name: 'Машина', src: 'https://em-content.zobj.net/source/telegram/386/automobile_1f697.webp' },
            { id: 'train', name: 'Поезд', src: 'https://em-content.zobj.net/source/telegram/386/locomotive_1f682.webp' },
            { id: 'plane', name: 'Самолёт', src: 'https://em-content.zobj.net/source/telegram/386/airplane_2708-fe0f.webp' },
            { id: 'rocket', name: 'Ракета', src: 'https://em-content.zobj.net/source/telegram/386/rocket_1f680.webp' },
            { id: 'moai', name: 'Моаи', src: 'https://em-content.zobj.net/source/telegram/386/moai_1f5ff.webp' },
            { id: 'alien', name: 'Инопланетянин', src: 'https://em-content.zobj.net/source/telegram/386/alien_1f47d.webp' },
            { id: 'robot', name: 'Робот', src: 'https://em-content.zobj.net/source/telegram/386/robot_1f916.webp' }
        ];

        const BACKGROUNDS = [
            { id: 'default', name: 'Стандартный', gradient: 'radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2), transparent 70%)', particleColor: '#FFFFFF' },
            { id: 'red', name: 'Красный', gradient: 'radial-gradient(circle at 50% 50%, rgba(255, 99, 71, 0.2), transparent 70%)', particleColor: '#FF6347' },
            { id: 'orange', name: 'Оранжевый', gradient: 'radial-gradient(circle at 50% 50%, rgba(255, 165, 0, 0.2), transparent 70%)', particleColor: '#FFA500' },
            { id: 'blue', name: 'Голубой', gradient: 'radial-gradient(circle at 50% 50%, rgba(135, 206, 235, 0.2), transparent 70%)', particleColor: '#87CEEB' },
            { id: 'space', name: 'Космос', gradient: 'radial-gradient(circle at 50% 50%, rgba(30, 144, 255, 0.2), transparent 70%)', particleColor: '#FF8C00' }
        ];

        /**
         * Manages game state
         */
        class GameState {
            constructor() {
                this.diamonds = 1000; // Start with 1000 diamonds
                this.inventory = { skins: ['console'], backgrounds: ['default'] }; // Start with default skin and background
                this.currentSkin = 'console';
                this.currentBackground = 'default';
                this.isTelegram = !!(window.Telegram?.WebApp?.initData);
            }

            getDiamonds() { return this.diamonds; }

            addDiamonds(amount) { this.diamonds += amount; }

            deductDiamonds(amount) {
                if (this.diamonds >= amount) {
                    this.diamonds -= amount;
                    return true;
                }
                return false;
            }

            addToInventory(type, id) {
                if (!this.inventory[type].includes(id)) {
                    this.inventory[type].push(id);
                }
            }

            setSkin(skinId) {
                if (this.inventory.skins.includes(skinId)) {
                    this.currentSkin = skinId;
                }
            }

            setBackground(bgId) {
                if (this.inventory.backgrounds.includes(bgId)) {
                    this.currentBackground = bgId;
                }
            }

            isTelegramEnvironment() { return this.isTelegram; }
        }

        /**
         * Manages particle system
         */
        class ParticleSystem {
            constructor(canvas, count) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = new Array(count);
                this.time = 0;
                this.particleColor = '#FFFFFF';
                for (let i = 0; i < count; i++) {
                    this.particles[i] = this.createParticle();
                }
            }

            createParticle() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    size: Math.random() * 3 + 1,
                    speedX: Math.random() * 0.5 - 0.25,
                    speedY: Math.random() * 0.5 - 0.25,
                    opacity: Math.random() * 0.5 + 0.3,
                    colorType: Math.random() < 0.5 ? 'gray' : 'gradient'
                };
            }

            setParticleColor(color) {
                this.particleColor = color;
            }

            update() {
                this.time += 0.016;
                for (let i = 0; i < this.particles.length; i++) {
                    const p = this.particles[i];
                    p.x += p.speedX;
                    p.y += p.speedY;
                    p.speedX += (Math.random() - 0.5) * 0.05;
                    p.speedY += (Math.random() - 0.5) * 0.05;
                    p.speedX = Math.max(-0.5, Math.min(0.5, p.speedX));
                    p.speedY = Math.max(-0.5, Math.min(0.5, p.speedY));
                    p.opacity = 0.3 + 0.5 * (Math.sin(this.time + i) + 1) / 2;
                    if (p.x < 0 || p.x > this.canvas.width) p.speedX *= -1;
                    if (p.y < 0 || p.y > this.canvas.height) p.speedY *= -1;
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                let r = 255, g = 255, b = 255;
                if (this.particleColor.startsWith('#')) {
                    const hex = this.particleColor.replace('#', '');
                    r = parseInt(hex.substring(0, 2), 16);
                    g = parseInt(hex.substring(2, 4), 16);
                    b = parseInt(hex.substring(4, 6), 16);
                }
                for (let i = 0; i < this.particles.length; i++) {
                    const p = this.particles[i];
                    this.ctx.fillStyle = p.colorType === 'gray'
                        ? `rgba(150, 150, 150, ${p.opacity})`
                        : `rgba(${r}, ${g}, ${b}, ${p.opacity})`;
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                for (let i = 0; i < this.particles.length; i++) {
                    const p = this.particles[i];
                    p.x = Math.random() * this.canvas.width;
                    p.y = Math.random() * this.canvas.height;
                }
            }
        }

        /**
         * Manages confetti system
         */
        class ConfettiSystem {
            constructor(canvas, count) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = [];
                this.isAnimating = false;
                this.colors = ['#FFFFFF', '#FF6347', '#FFA500', '#87CEEB', '#FF8C00'];
                this.maxCount = count;
                this.spawnRate = 0.05;
                this.removeProbability = 0.02;
            }

            createParticle() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: -Math.random() * 50,
                    width: Math.random() * 3 + 3,
                    height: Math.random() * 3 + 3,
                    speedY: Math.random() * 2 + 2,
                    opacity: 1,
                    color: this.colors[Math.floor(Math.random() * this.colors.length)],
                    rotation: Math.random() * Math.PI * 2
                };
            }

            update() {
                this.particles = this.particles.filter(p => {
                    p.y += p.speedY;
                    p.rotation += 0.05;
                    if (p.y > this.canvas.height * 0.9) {
                        return Math.random() > this.removeProbability;
                    }
                    return true;
                });

                if (this.particles.length < this.maxCount && Math.random() < this.spawnRate) {
                    this.particles.push(this.createParticle());
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                for (let i = 0; i < this.particles.length; i++) {
                    const p = this.particles[i];
                    this.ctx.save();
                    this.ctx.translate(p.x + p.width / 2, p.y + p.height / 2);
                    this.ctx.rotate(p.rotation);
                    this.ctx.fillStyle = p.color;
                    this.ctx.globalAlpha = p.opacity;
                    this.ctx.fillRect(-p.width / 2, -p.height / 2, p.width, p.height);
                    this.ctx.restore();
                }
            }

            start() {
                if (this.isAnimating) return;
                this.particles = [];
                for (let i = 0; i < this.maxCount; i++) {
                    const p = this.createParticle();
                    p.y = Math.random() * this.canvas.height;
                    this.particles.push(p);
                }
                this.isAnimating = true;
                this.canvas.classList.remove('game-hidden');
                this.animate();
            }

            stop() {
                this.isAnimating = false;
                this.canvas.classList.add('game-hidden');
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.particles = [];
            }

            animate() {
                if (!this.isAnimating) return;
                this.update();
                this.draw();
                requestAnimationFrame(() => this.animate());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.particles = [];
                if (this.isAnimating) {
                    for (let i = 0; i < this.maxCount; i++) {
                        const p = this.createParticle();
                        p.y = Math.random() * this.canvas.height;
                        this.particles.push(p);
                    }
                }
            }
        }

        /**
         * Manages UI updates
         */
        class UIManager {
            constructor(elements) {
                this.elements = elements;
                this.pendingUpdates = {};
            }

            queueUpdate(key, value) {
                this.pendingUpdates[key] = value;
            }

            applyUpdates() {
                requestAnimationFrame(() => {
                    for (const [key, value] of Object.entries(this.pendingUpdates)) {
                        if (key === 'diamonds') this.elements.totalDiamonds.textContent = value;
                        if (key === 'characterSrc') this.elements.character.src = value;
                        if (key === 'gradient') document.documentElement.style.setProperty('--bg-gradient', value);
                        if (key === 'particleColor') this.elements.particleSystem.setParticleColor(value);
                        if (key === 'caseResult') {
                            this.elements.caseResultImage.src = value.src;
                            this.elements.caseResultName.textContent = value.name;
                            this.elements.caseResult.classList.add('active');
                            setTimeout(() => this.elements.caseResult.classList.remove('active'), 3000);
                        }
                    }
                    this.pendingUpdates = {};
                });
            }

            showGameUI() {
                this.elements.loadingScreen.classList.add('hidden');
                this.elements.topMenu.classList.remove('game-hidden');
                this.elements.particleCanvas.classList.remove('game-hidden');
                this.elements.mainContent.classList.remove('game-hidden');
                this.elements.footer.classList.remove('game-hidden');
                setTimeout(() => {
                    this.elements.loadingScreen.style.display = 'none';
                }, 500);
            }

            updateLoadingPercent(percent) {
                this.elements.loadingPercent.textContent = `${Math.round(percent)}%`;
            }
        }

        /**
         * Manages game logic
         */
        class Game {
            constructor(elements) {
                this.state = new GameState();
                this.ui = new UIManager({
                    ...elements,
                    particleSystem: new ParticleSystem(elements.particleCanvas, CONFIG.PARTICLE_COUNT)
                });
                this.particleSystem = this.ui.elements.particleSystem;
                this.confettiSystem = new ConfettiSystem(elements.confettiCanvas, CONFIG.CONFETTI_COUNT);
                this.resizeTimeout = null;
                this.listeners = [];
                this.currentSection = 'home';
            }

            async preloadAssets() {
                const imageUrls = [
                    'https://placehold.co/40x40',
                    ...SKINS.map(skin => skin.src),
                    'https://em-content.zobj.net/source/telegram/386/television_1f4fa.webp',
                    'https://em-content.zobj.net/source/telegram/386/backpack_1f392.webp',
                    'https://em-content.zobj.net/source/telegram/386/crown_1f451.webp',
                    'https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp'
                ];

                let loadedCount = 0;
                const totalImages = imageUrls.length;

                const loadImage = url => {
                    return new Promise(resolve => {
                        const img = new Image();
                        img.src = url;
                        img.onload = () => {
                            loadedCount++;
                            const percent = (loadedCount / totalImages) * 100;
                            this.ui.updateLoadingPercent(percent);
                            resolve();
                        };
                        img.onerror = () => {
                            console.warn(`Failed to load image: ${url}. Using fallback.`);
                            img.src = 'https://dummyimage.com/40x40/000/fff';
                            img.onload = () => {
                                loadedCount++;
                                const percent = (loadedCount / totalImages) * 100;
                                this.ui.updateLoadingPercent(percent);
                                resolve();
                            };
                            img.onerror = () => {
                                console.error(`Failed to load fallback image for: ${url}`);
                                loadedCount++;
                                const percent = (loadedCount / totalImages) * 100;
                                this.ui.updateLoadingPercent(percent);
                                resolve();
                            };
                        };
                    });
                };

                await Promise.all(imageUrls.map(loadImage));
                this.ui.showGameUI();
            }

            showSection(section) {
                this.currentSection = section;
                this.ui.elements.sections.forEach(s => s.classList.remove('active'));
                this.ui.elements[`${section}Section`].classList.add('active');
                this.ui.elements.menuItems.forEach(i => i.classList.remove('highlighted'));
                this.ui.elements.menuItems.forEach(i => {
                    if (i.dataset.menu === section) i.classList.add('highlighted');
                });
                if (section === 'inventory') {
                    this.updateInventoryContent('skins');
                }
                this.confettiSystem.stop();
            }

            openCase(caseType) {
                if (!this.state.deductDiamonds(CONFIG.CASE_COST)) {
                    alert('Недостаточно алмазов!');
                    return;
                }

                this.ui.queueUpdate('diamonds', this.state.getDiamonds());
                this.confettiSystem.start();

                let item = null;
                if (caseType === 'skin') {
                    item = SKINS[Math.floor(Math.random() * SKINS.length)];
                    this.state.addToInventory('skins', item.id);
                } else {
                    item = BACKGROUNDS[Math.floor(Math.random() * BACKGROUNDS.length)];
                    this.state.addToInventory('backgrounds', item.id);
                }

                this.ui.queueUpdate('caseResult', {
                    src: caseType === 'skin' ? item.src : 'https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp',
                    name: item.name
                });

                this.ui.applyUpdates();
            }

            updateInventoryContent(tab) {
                const container = this.ui.elements.inventoryContent;
                container.innerHTML = '';
                const items = tab === 'skins' ? SKINS.filter(s => this.state.inventory.skins.includes(s.id)) : BACKGROUNDS.filter(b => this.state.inventory.backgrounds.includes(b.id));
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'inventory-item';
                    div.innerHTML = `
                        <img src="${tab === 'skins' ? item.src : 'https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp'}" alt="${item.name}">
                        <span>${item.name}</span>
                    `;
                    div.addEventListener('pointerdown', () => {
                        if (tab === 'skins') {
                            this.state.setSkin(item.id);
                            this.ui.queueUpdate('characterSrc', item.src);
                        } else {
                            this.state.setBackground(item.id);
                            this.ui.queueUpdate('gradient', item.gradient);
                            this.ui.queueUpdate('particleColor', item.particleColor);
                        }
                        this.ui.applyUpdates();
                    });
                    container.appendChild(div);
                });
            }

            updateAppearance() {
                const skin = SKINS.find(s => s.id === this.state.currentSkin) || SKINS[0];
                const bg = BACKGROUNDS.find(b => b.id === this.state.currentBackground) || BACKGROUNDS[0];
                this.ui.queueUpdate('characterSrc', skin.src);
                this.ui.queueUpdate('gradient', bg.gradient);
                this.ui.queueUpdate('particleColor', bg.particleColor);
                this.ui.queueUpdate('diamonds', this.state.getDiamonds());
            }

            handleResize() {
                if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => {
                    this.particleSystem.resize();
                    this.confettiSystem.resize();
                }, CONFIG.RESIZE_DEBOUNCE);
            }

            animate() {
                this.particleSystem.update();
                this.particleSystem.draw();
                requestAnimationFrame(() => this.animate());
            }

            initMenu() {
                const handler = e => {
                    e.preventDefault();
                    const item = e.target.closest('.menu-item');
                    if (!item) return;
                    const menu = item.dataset.menu;
                    this.showSection(menu);
                };
                this.ui.elements.footerMenu.addEventListener('pointerdown', handler);
                this.listeners.push({ element: this.ui.elements.footerMenu, type: 'pointerdown', listener: handler });

                const caseItems = this.ui.elements.marketSection.querySelectorAll('.case-item');
                caseItems.forEach(item => {
                    item.addEventListener('pointerdown', () => {
                        const caseType = item.dataset.case;
                        this.openCase(caseType);
                    });
                });

                const tabs = this.ui.elements.inventorySection.querySelectorAll('.tab-button');
                tabs.forEach(tab => {
                    tab.addEventListener('pointerdown', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.updateInventoryContent(tab.dataset.tab);
                    });
                });
            }

            async init() {
                if (this.state.isTelegramEnvironment()) {
                    document.body.setAttribute('data-telegram', 'true');
                }
                this.particleSystem.resize();
                this.confettiSystem.resize();
                this.updateAppearance();
                await this.preloadAssets();
                this.initMenu();
                this.animate();

                const resizeListener = this.handleResize.bind(this);
                window.addEventListener('resize', resizeListener);
                this.listeners.push({ element: window, type: 'resize', listener: resizeListener });
            }

            destroy() {
                this.listeners.forEach(({ element, type, listener }) => {
                    element.removeEventListener(type, listener);
                });
                if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
                this.confettiSystem.stop();
            }
        }

        // Initialize game
        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            loadingPercent: document.getElementById('loadingPercent'),
            topMenu: document.getElementById('topMenu'),
            totalDiamonds: document.getElementById('totalDiamonds'),
            character: document.getElementById('character'),
            particleCanvas: document.getElementById('particleCanvas'),
            confettiCanvas: document.getElementById('confettiCanvas'),
            mainContent: document.getElementById('mainContent'),
            footer: document.getElementById('footer'),
            footerMenu: document.querySelector('.footer-menu'),
            menuItems: document.querySelectorAll('.menu-item'),
            homeSection: document.getElementById('homeSection'),
            marketSection: document.getElementById('marketSection'),
            inventorySection: document.getElementById('inventorySection'),
            sections: [document.getElementById('homeSection'), document.getElementById('marketSection'), document.getElementById('inventorySection')],
            inventoryContent: document.getElementById('inventoryContent'),
            caseResult: document.getElementById('caseResult'),
            caseResultImage: document.getElementById('caseResultImage'),
            caseResultName: document.getElementById('caseResultName')
        };

        const game = new Game(elements);
        game.init().catch(err => console.error('Инициализация игры не удалась:', err));
    </script>
</body>
</html>