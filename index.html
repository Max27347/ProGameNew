<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"/>
<meta content="Notcoin-inspired clicker game" name="description"/>
<title>Clicker Game</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            *:focus,
            *:active {
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }
            :root {
                --bg-color: #000;
                --bg-gradient: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.2), transparent 70%);
                --highlight-color: #fff;
                --text-color: #fff;
                --footer-bg: rgba(30, 30, 30, 0.85);
                --counter-bg: rgba(30, 30, 30, 0.85);
                --top-menu-bg: rgba(30, 30, 30, 0.85);
                --tg-bg-color: linear-gradient(135deg, #1c2526, #2a1b3d);
                --tg-text-color: #fff;
                --tg-footer-bg: rgba(44, 47, 71, 0.85);
                --tg-counter-bg: rgba(44, 47, 71, 0.85);
                --tg-top-menu-bg: rgba(44, 47, 71, 0.85);
            }
            [data-telegram="true"] {
                --bg-color: var(--tg-bg-color);
                --text-color: var(--tg-text-color);
                --footer-bg: var(--tg-footer-bg);
                --counter-bg: var(--tg-counter-bg);
                --top-menu-bg: var(--tg-top-menu-bg);
            }
            body {
                min-height: 100vh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background: var(--bg-color);
                background-image: var(--bg-gradient);
                color: var(--text-color);
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                font-size: 16px;
                line-height: 1.5;
                overflow: hidden;
                -webkit-user-select: none;
                user-select: none;
            }
            .loading-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            .loading-screen.hidden {
                opacity: 0;
                pointer-events: none;
            }
            .loading-ring {
                width: 100px;
                height: 100px;
                border: 8px solid transparent;
                border-top-color: rgba(255, 255, 255, 0.8);
                border-right-color: rgba(255, 255, 255, 0.4);
                border-radius: 50%;
                animation: spin 1.5s linear infinite;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            .loading-ring.hidden {
                opacity: 0;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            .loading-percent {
                position: absolute;
                bottom: 2rem;
                font-size: 1.5rem;
                font-weight: 600;
                color: #fff;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            .loading-percent.hidden {
                opacity: 0;
            }
            .game-hidden {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.5s ease;
            }
            .game-hidden.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .top-menu {
                position: fixed;
                top: 1rem;
                width: calc(100% - 3rem);
                margin: 0 1.5rem;
                background: var(--top-menu-bg);
                border-radius: 20px;
                padding: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                z-index: 2;
                opacity: 1;
                transition: opacity 0.5s ease;
                cursor: pointer;
            }
            .top-menu-left {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }
            .top-menu-right {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 0.2rem;
            }
            .player-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }
            .player-info {
                display: flex;
                flex-direction: column;
                gap: 0.2rem;
            }
            .player-nickname {
                font-size: 1rem;
                font-weight: 600;
            }
            .player-max-coins {
                font-size: 0.9rem;
                opacity: 0.8;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }
            .gem-icon {
                width: 20px;
                height: 20px;
                vertical-align: middle;
                margin-right: 0.3rem;
            }
            .player-rank {
                font-size: 1rem;
                font-weight: 600;
            }
            .player-stats {
                font-size: 0.9rem;
                opacity: 0.8;
            }
            .wallet-container {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
                gap: 0.5rem;
            }
            #ton-connect {
                display: none;
                justify-content: flex-end;
                padding: 0.5rem;
                background: #007bff;
                border-radius: 12px;
                color: #fff;
                font-size: 0.9rem;
                font-weight: 600;
                cursor: pointer;
            }
            .market-container.visible #ton-connect {
                display: flex;
            }
            #disconnect-wallet {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
                background: #007bff;
                color: #fff;
                border-radius: 12px;
                cursor: pointer;
                display: none;
            }
            #disconnect-wallet:hover {
                background: #0056b3;
            }
            #particleCanvas,
            #confettiCanvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            #particleCanvas {
                z-index: -1;
            }
            #confettiCanvas {
                z-index: 11;
            }
            main {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                max-width: 800px;
                padding: 1rem;
                z-index: 1;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            .income-counter {
                position: fixed;
                top: 6.5rem;
                left: 1rem;
                padding: 0.75rem 1.5rem;
                font-size: 1.2rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                border-radius: 12px;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            .income-timer {
                position: fixed;
                top: 8.5rem;
                left: 1rem;
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                border-radius: 12px;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            .coin-counter {
                position: fixed;
                right: 1rem;
                padding: 0.75rem 1.5rem;
                background: none;
                font-size: 2rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                opacity: 1;
                transition: opacity 0.5s ease;
                z-index: 2;
            }
            .coin-counter.hidden {
                opacity: 0;
                pointer-events: none;
            }
            .coin-counter.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .coin-icon {
                width: 32px;
                height: 32px;
                vertical-align: middle;
                margin-left: 0.5rem;
            }
            .character-container {
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .character {
                width: 180px;
                height: 180px;
                object-fit: contain;
                cursor: pointer;
                user-select: none;
                touch-action: manipulation;
                opacity: 1;
                transition: transform 0.3s ease;
            }
            .click-effect {
                position: absolute;
                width: 40px;
                height: 40px;
                object-fit: contain;
                pointer-events: none;
                animation: fadeOut 1s ease forwards;
                z-index: 2;
                transform: translate(-50%, -50%);
            }
            @keyframes fadeOut {
                0% {
                    opacity: 1;
                    transform: translate(-50%, -50%);
                }
                100% {
                    opacity: 0;
                    transform: translate(-50%, -70%);
                }
            }
            footer {
                width: 100%;
                position: fixed;
                bottom: 0;
                z-index: 12;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 0;
                opacity: 1;
                transition: opacity 0.5s ease;
            }
            .footer-menu-container {
                width: auto;
                background: var(--footer-bg);
                border-radius: 20px 20px 0 0;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 0.75rem;
            }
            .footer-menu {
                display: flex;
                justify-content: space-around;
                align-items: center;
                width: 100%;
                gap: 1rem;
            }
            .menu-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.4rem;
                cursor: pointer;
            }
            .menu-item img {
                width: 64px;
                height: 64px;
                object-fit: contain;
                border-radius: 50%;
                background: #2e2e2e;
                padding: 12px;
            }
            .menu-item.highlighted img {
                background: var(--highlight-color);
            }
            .menu-item span {
                font-size: 1rem;
                font-weight: 500;
                color: var(--text-color);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .hidden-opacity {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.5s ease;
            }
            .hidden-opacity.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .shop-container,
            .inventory-container,
            .market-container,
            .leaderboard-container {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 400px;
                background: transparent;
                border-radius: 20px;
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
                z-index: 3;
                opacity: 0;
                transition: opacity 0.5s ease;
            }
            .shop-container.visible,
            .inventory-container.visible,
            .market-container.visible,
            .leaderboard-container.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .shop-container.hidden,
            .inventory-container.hidden,
            .market-container.hidden,
            .leaderboard-container.hidden {
                opacity: 0;
                pointer-events: none;
            }
            .shop-title,
            .inventory-title,
            .market-title,
            .leaderboard-title {
                font-size: 1.5rem;
                font-weight: 700;
                color: #fff;
                text-transform: uppercase;
            }
            .cases-container,
            .inventory-items-container,
            .market-items-container,
            .leaderboard-table-container {
                display: flex;
                justify-content: center;
                gap: 1rem;
                width: 100%;
                flex-wrap: wrap;
                overflow-y: auto;
            }
            .cases-container,
            .inventory-items-container,
            .leaderboard-table-container {
                min-height: 20vh;
            }
            .market-items-container {
                height: 53vh;
            }
            .case-container,
            .inventory-item-container,
            .market-item-container {
                width: 150px;
                background: #2e2e2e;
                border-radius: 16px;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
                transition: background 0.3s ease;
            }
            .upgrade-anim {
                animation: upgradeGlow 0.5s ease-in-out;
            }
            @keyframes upgradeGlow {
                0% {
                    box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
                    transform: scale(1);
                }
                50% {
                    box-shadow: 0 0 20px rgba(255, 215, 0, 1);
                    transform: scale(1.05);
                }
                100% {
                    box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
                    transform: scale(1);
                }
            }
            .case-image,
            .inventory-image,
            .market-image {
                width: 80px;
                height: 80px;
                object-fit: contain;
                border-radius: 50%;
            }
            .case-name,
            .inventory-name,
            .market-name {
                font-size: 1rem;
                font-weight: 600;
                color: #fff;
            }
            .case-price,
            .market-price {
                font-size: 0.9rem;
                font-weight: 500;
                color: #fff;
                opacity: 0.8;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }
            .shop-arrow,
            .inventory-arrow {
                position: fixed;
                top: 50%;
                transform: translateY(-50%);
                font-size: 2rem;
                color: #fff;
                cursor: pointer;
                padding: 0.5rem;
                background: transparent;
                border-radius: 50%;
                z-index: 3;
                opacity: 0;
                transition: opacity 0.5s ease;
            }
            .shop-arrow.visible,
            .inventory-arrow.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .shop-arrow.hidden,
            .inventory-arrow.hidden {
                opacity: 0;
                pointer-events: none;
            }
            .shop-arrow.left {
                left: 1rem;
            }
            .shop-arrow.right {
                right: 1rem;
            }
            .inventory-arrow.left {
                left: 1rem;
            }
            .case-animation-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 1rem;
                z-index: 10;
                opacity: 0;
                transition: opacity 0.5s ease;
            }
            .case-animation-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .case-animation-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }
            .case-animation-message {
                font-size: 2rem;
                font-weight: 700;
                color: #fff;
                text-align: center;
                max-width: 90%;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
                opacity: 0;
                transition: opacity 0.3s ease, transform 0.3s ease;
            }
            .case-animation-message.visible {
                opacity: 1;
                transform: scale(1);
            }
            .case-animation-message.hidden {
                opacity: 0;
                transform: scale(0.9);
            }
            .case-animation-container {
                width: 480px;
                height: 200px;
                background: #2e2e2e;
                border-radius: 16px;
                display: flex;
                justify-content: center;
                align-items: center;
                position: relative;
                overflow: hidden;
            }
            .roulette-strip {
                width: 5440px;
                height: 100%;
                display: flex;
                flex-direction: row;
                align-items: center;
                transform: translateX(0);
                position: absolute;
                left: 0;
                animation: roulette-slow-spin 40s linear infinite;
            }
            .roulette-item {
                width: 120px;
                height: 120px;
                margin: 0 8px;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #1e1e1e;
                border-radius: 8px;
                position: relative;
                transition: transform 0.5s ease, box-shadow 0.5s ease, border 0.5s ease;
            }
            .roulette-item img {
                width: 100px;
                height: 100px;
                object-fit: contain;
            }
            .roulette-item.winner {
                transform: scale(1.5);
                border: 2px solid #fff;
                animation: glow-winner 1s ease-in-out infinite;
                z-index: 10;
            }
            .animation-character {
                width: 100px;
                height: 100px;
                object-fit: contain;
                z-index: 3;
            }
            .animation-character.mutated {
                filter: brightness(1.5) hue-rotate(200deg);
            }
            .animation-background {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border-radius: 8px;
                opacity: 0.8;
                z-index: 1;
            }
            .animation-bar {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                width: 4px;
                height: 90%;
                background: #fff;
                border-radius: 2px;
            }
            .case-animation-button {
                font-size: 1.2rem;
                font-weight: 600;
                color: #000;
                background: var(--highlight-color);
                padding: 0.75rem 1.5rem;
                border-radius: 16px;
                cursor: pointer;
                margin-top: 1rem;
            }
            .case-animation-cancel {
                font-size: 0.9rem;
                font-weight: 500;
                color: #fff;
                opacity: 0.8;
                cursor: pointer;
                margin-top: 0.5rem;
            }
            @keyframes roulette-slow-spin {
                0% {
                    transform: translateX(0);
                }
                100% {
                    transform: translateX(-5440px);
                }
            }
            @keyframes roulette-spin {
                0% {
                    transform: translateX(0);
                }
                100% {
                    transform: translateX(-2434px);
                }
            }
            @keyframes glow-winner {
                0%,
                100% {
                    box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
                }
                50% {
                    box-shadow: 0 0 20px rgba(255, 255, 255, 1);
                }
            }
            .filters-container {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
                width: 100%;
                margin-bottom: 1rem;
            }
            .filter-select,
            .sort-select {
                width: 100%;
                max-width: 150px;
                padding: 0.5rem;
                background: #2e2e2e;
                border-radius: 8px;
                color: #fff;
                font-size: 0.9rem;
                border: none;
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
                background-repeat: no-repeat;
                background-position: right 0.5rem center;
                background-size: 16px;
            }
            .filter-select option,
            .sort-select option {
                background: #2e2e2e;
                color: #fff;
            }
            .buy-button {
                font-size: 0.9rem;
                font-weight: 600;
                color: #000;
                background: var(--highlight-color);
                padding: 0.5rem 1rem;
                border-radius: 12px;
                cursor: pointer;
                margin-top: 0.5rem;
            }
            .upgrade-button {
                font-size: 0.9rem;
                font-weight: 600;
                color: #fff;
                background: #808080;
                padding: 0.5rem 1rem;
                border-radius: 12px;
                cursor: pointer;
                margin-top: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }
            .leaderboard-table {
                width: 100%;
                border-collapse: collapse;
                color: #fff;
            }
            .leaderboard-table th,
            .leaderboard-table td {
                padding: 0.5rem;
                text-align: left;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            .leaderboard-table th {
                font-weight: 600;
                background: #2e2e2e;
            }
            .leaderboard-table tr:hover {
                background: rgba(255, 255, 255, 0.05);
            }
            @media (max-width: 600px) {
                .loading-percent {
                    font-size: 1.2rem;
                }
                .top-menu {
                    top: 0.8rem;
                    width: calc(100% - 2rem);
                    margin: 0 1rem;
                    padding: 0.75rem;
                    border-radius: 16px;
                }
                .player-avatar {
                    width: 32px;
                    height: 32px;
                }
                .player-nickname {
                    font-size: 0.9rem;
                }
                .player-max-coins {
                    font-size: 0.8rem;
                    gap: 0.2rem;
                }
                .gem-icon {
                    width: 16px;
                    height: 16px;
                    margin-right: 0.2rem;
                }
                .player-rank {
                    font-size: 0.9rem;
                }
                .player-stats {
                    font-size: 0.8rem;
                }
                .wallet-container {
                    gap: 0.3rem;
                }
                #disconnect-wallet {
                    font-size: 0.8rem;
                    padding: 0.4rem 0.8rem;
                }
                .income-counter {
                    font-size: 1rem;
                    padding: 0.5rem 1rem;
                    top: 7.5rem;
                    padding: 0.5rem 1rem;
                    top: 6.5rem;
                    padding: 0.5rem 1rem;
                    gap: 0.4rem;
                }
                .coin-icon {
                    width: 24px;
                    height: 24px;
                    margin-left: 0.4rem;
                }
                .character {
                    width: 140px;
                    height: 140px;
                }
                footer {
                    bottom: 0;
                    padding: 0;
                }
                .footer-menu-container {
                    border-radius: 16px 16px 0 0;
                    padding: 0.6rem;
                }
                .footer-menu {
                    gap: 0.8rem;
                }
                .menu-item img {
                    width: 48px;
                    height: 48px;
                    padding: 10px;
                }
                .menu-item span {
                    font-size: 0.9rem;
                }
                .shop-container,
                .inventory-container,
                .market-container,
                .leaderboard-container {
                    width: 85%;
                    padding: 1rem;
                }
                .shop-title,
                .inventory-title,
                .market-title,
                .leaderboard-title {
                    font-size: 1.2rem;
                }
                .cases-container,
                .inventory-items-container,
                .leaderboard-table-container {
                    min-height: 15vh;
                }
                .market-items-container {
                    height: 53vh;
                }
                .case-container,
                .inventory-item-container,
                .market-item-container {
                    width: 120px;
                    padding: 0.8rem;
                }
                .case-image,
                .inventory-image,
                .market-image {
                    width: 60px;
                    height: 60px;
                }
                .case-name,
                .inventory-name,
                .market-name {
                    font-size: 0.9rem;
                }
                .case-price,
                .market-price {
                    font-size: 0.8rem;
                    gap: 0.2rem;
                }
                .shop-arrow,
                .inventory-arrow {
                    font-size: 1.5rem;
                    padding: 0.4rem;
                }
                .shop-arrow.left,
                .inventory-arrow.left {
                    left: 0.8rem;
                }
                .shop-arrow.right {
                    right: 0.8rem;
                }
                .case-animation-message {
                    font-size: 1.5rem;
                }
                .case-animation-container {
                    width: 384px;
                    height: 160px;
                }
                .roulette-strip {
                    width: 4480px;
                    animation: roulette-slow-spin 32s linear infinite;
                }
                .roulette-item {
                    width: 96px;
                    height: 96px;
                    margin: 0 8px;
                }
                .roulette-item img {
                    width: 80px;
                    height: 80px;
                }
                .roulette-item.winner {
                    transform: scale(1.5);
                    border: 2px solid #fff;
                    animation: glow-winner 1s ease-in-out infinite;
                }
                .animation-character {
                    width: 80px;
                    height: 80px;
                }
                .animation-background {
                    width: 100%;
                    height: 100%;
                }
                .animation-bar {
                    width: 3px;
                    height: 80%;
                }
                .case-animation-button {
                    font-size: 1rem;
                    padding: 0.6rem 1.2rem;
                    color: #000;
                }
                .case-animation-cancel {
                    font-size: 0.8rem;
                }
                .filters-container {
                    gap: 0.4rem;
                }
                .filter-select,
                .sort-select {
                    max-width: 120px;
                    padding: 0.4rem;
                    font-size: 0.8rem;
                    background-size: 14px;
                }
                .buy-button,
                .upgrade-button {
                    font-size: 0.8rem;
                    padding: 0.4rem 0.8rem;
                }
                .leaderboard-table th,
                .leaderboard-table td {
                    padding: 0.4rem;
                    font-size: 0.8rem;
                }
                @keyframes roulette-slow-spin {
                    0% {
                        transform: translateX(0);
                    }
                    100% {
                        transform: translateX(-4480px);
                    }
                }
                @keyframes roulette-spin {
                    0% {
                        transform: translateX(0);
                    }
                    100% {
                        transform: translateX(-2008px);
                    }
                }
                @keyframes glow-winner {
                    0%,
                    100% {
                        box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
                    }
                    50% {
                        box-shadow: 0 0 15px rgba(255, 255, 255, 1);
                    }
                }
            }

            .claim-button {
                background: var(--counter-bg);
                border: none;
                padding: 0.4rem 0.8rem;
                border-radius: 6px;
                color: white;
                font-weight: bold;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.3rem;
                cursor: pointer;
                margin-top: 0.5rem;
                transition: transform 0.3s ease;
            }
            .claim-button.pulse {
                animation: pulseBtn 1s infinite ease-in-out;
            }
            @keyframes pulseBtn {
                0%,
                100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.08);
                }
            }

            .case-price {
                display: flex;
                justify-content: flex-end;
                align-items: center;
                height: 40px;
            }

            .arrow-button {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                font-size: 1.5rem;
                background: none;
                border: none;
                cursor: pointer;
                z-index: 10;
            }
            .right-arrow {
                right: 1rem;
            }
            .inventory-arrow.right {
                right: 1rem;
            }

            .case-container {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                padding-bottom: 1rem;
            }
            .case-price {
                margin-top: auto;
                padding-top: 0.5rem;
            }

            .upgrade-button {
                font-size: 0.9rem;
                font-weight: 600;
                color: #fff;
                background: #2e2e2e;
                padding: 0.5rem 1rem;
                border-radius: 12px;
                cursor: pointer;
                margin-top: 0.5rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }


#minigameStarfield {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
}


@keyframes flipCoin {
  0% { transform: rotateY(0); }
  50% { transform: rotateY(720deg); }
  100% { transform: rotateY(1440deg); }
}
#coinImage {
  transition: transform 1.5s ease;
}
</style>
<style>
  .quests-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 2rem;
    color: white;
    background: rgba(0, 0, 0, 0.4);
    padding: 0.5rem;
    border-radius: 50%;
    z-index: 10;
    cursor: pointer;
    display: none;
  }

  .quests-arrow.left {
    left: 1rem;
  }

  .quests-arrow.right {
    right: 1rem;
  }
</style>
<style>
#gamesContainer .claim-button {
  background-color: #4CAF50 !important;
  color: white !important;
  font-weight: bold;
}
#gamesContainer .claim-button:hover {
  background-color: #45a049 !important;
}
</style>
<style>
@keyframes flipCoin {
  0% { transform: rotateY(0); }
  50% { transform: rotateY(720deg); }
  100% { transform: rotateY(1440deg); }
}
#coinFlipGame .coin {
  width: 120px;
  height: 120px;
  transition: transform 1.5s ease;
}
</style></head>
<body>
<style>#raceGameContainer{display:none!important;}</style>
<div class="loading-screen" id="loadingScreen">
<div class="loading-ring"></div>
<span class="loading-percent" id="loadingPercent">0%</span>
</div>
<header class="top-menu game-hidden" id="topMenu">
<div class="top-menu-left">
<img alt="Player Avatar" class="player-avatar" draggable="false" src="https://placehold.co/40x40"/>
<div class="player-info">
<span class="player-nickname">Player123</span>
<span class="player-max-coins">
<img alt="Gem Stone" class="gem-icon" src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp"/>
<span id="totalCoins">8000</span>
</span>
</div>
</div>
<div class="top-menu-right">
<span class="player-rank">Rank: 1</span>
<span class="player-stats">World of Consoles</span>
<div class="wallet-container">
<button id="disconnect-wallet">Disconnect Wallet</button>
</div>
</div>
</header>
<canvas class="game-hidden" id="particleCanvas"></canvas>
<canvas class="game-hidden" id="confettiCanvas"></canvas>
<main class="game-hidden" id="mainContent">
<div class="income-counter" id="incomeCounter">
<span id="incomeRate">0</span> Diamonds/h
                <img alt="Gem Stone" class="gem-icon" draggable="false" src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp"/>
</div>
<div class="income-timer" id="incomeTimer"><span id="timerDisplay">00:00</span><span id="x4Button" onclick="activateX4()" style="margin-left: 8px; font-weight: bold; color: gold; cursor: pointer;">x4</span></div>
<div class="coin-counter visible" id="coinCounter">
<div class="coin-line">
<span id="coinCount">8000</span>
<img alt="Gem Stone" class="coin-icon" draggable="false" src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp"/>
<div class="donation-line" id="starDonation" style="cursor: pointer;">
<span id="starCount">0</span>
<img alt="Star" src="https://em-content.zobj.net/source/telegram/386/star_2b50.webp" style="width: 24px; height: 24px; vertical-align: middle;"/>
</div>
</div>
</div>
<div class="character-container">
<img alt="Controller" class="character" draggable="false" id="character" src="https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp"/>
</div>
</main>
<div class="shop-container hidden" id="shopContainer">
<div class="shop-title">Cases</div>
<div class="cases-container">
<div class="case-container" data-case="diamond-rain">
<img alt="Diamond Rain" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/popcorn_1f37f.webp"/>
<div class="case-name">Diamond Rain</div>
<div class="case-price">100 Diamonds</div>
</div>
<div class="case-container" data-case="character-magic">
<img alt="Character Magic" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/luggage_1f9f3.webp"/>
<div class="case-name">Character Magic</div>
<div class="case-price">Free (Test)</div>
</div>
<div class="cases-container">
<div class="case-container" data-case="telegram-gift">
<img alt="Telegram Gift" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/crystal-ball_1f52e.webp"/>
<div class="case-name">Exclusive</div>
<div class="case-price">Free</div>
</div>
<div class="case-container" data-case="telegram-gift-2">
<img alt="Telegram Gift 2" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/crystal-ball_1f52e.webp"/>
<div class="case-name">Telegram Gift</div>
<div class="case-price">Free</div>
</div>
<!-- Остальные кейсы остаются без изменений -->
</div>
</div>
</div>
<div class="inventory-container hidden" id="inventoryContainer">
<div class="inventory-title">Inventory</div>
<div class="inventory-items-container" id="inventoryItems" style="max-height: 300px; overflow-y: auto;"></div>
</div>
<div class="market-container hidden" id="marketContainer">
<div class="market-title">Market</div>
<div id="ton-connect"></div>
<div class="filters-container">
<select class="filter-select" id="characterFilter">
<option value="">All Characters</option>
</select>
<select class="filter-select" id="backgroundFilter">
<option value="">All Backgrounds</option>
</select>
<select class="sort-select" id="priceSort">
<option value="newest">Newest First</option>
<option value="price-desc">Price: High to Low</option>
<option value="price-asc">Price: Low to High</option>
</select>
</div>
<div class="market-items-container" id="marketItems"></div>
</div>
<div class="leaderboard-container hidden" id="leaderboardContainer">
<div class="leaderboard-title">Leaderboard</div>
<div class="leaderboard-table-container" style="max-height: 400px; overflow-y: auto;">
<table class="leaderboard-table" id="leaderboardTable">
<thead>
<tr>
<th>Rank</th>
<th>Player</th>
<th>Diamonds</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="shop-arrow left hidden" id="shopArrowLeft">&lt;</div>
<div class="shop-arrow right hidden" id="shopArrowRight">&gt;</div>
<div class="inventory-arrow left hidden" id="inventoryArrowLeft">&lt;</div>
<div class="inventory-arrow right hidden" id="inventoryArrowRight">&gt;</div>
<div class="leaderboard-container hidden" id="gamesContainer">
<div class="leaderboard-title">Minigames</div>
<div class="cases-container">
<div class="case-container">
<img alt="Click Challenge" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp"/>
<div class="case-name">Earn Coins</div>
<div class="case-price"><button class="minigame-button" id="earnCoinsPlayBtn">Play</button>
</div>
</div>
<div class="case-container">
<img alt="Memory Match" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/memo_1f4dd.webp"/>
<div class="case-name">Tort</div>
<div class="case-price"><button class="minigame-button" id="tortGamePlayBtn">Play</button></div>
</div>
<div class="case-container"><img alt="Score Rush" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/trophy_1f3c6.webp"/><div class="case-name">Гонки</div><div class="case-price"><button class="minigame-button" id="raceGamePlayBtn">Play</button></div></div><div class="case-container"><img alt="Coin Flip" class="case-image" draggable="false" src="https://em-content.zobj.net/source/telegram/386/coin_1fa99.webp"/><div class="case-name">Монетка</div><div class="case-price"><button class="minigame-button" id="coinFlipPlayBtn">Play</button></div></div></div>
</div>
<footer class="game-hidden" id="footer">
<div class="footer-menu-container">
<div class="footer-menu">
<div class="menu-item highlighted" data-menu="home">
<img alt="Home" draggable="false" src="https://em-content.zobj.net/source/telegram/386/television_1f4fa.webp"/>
<span>Home</span>
</div>
<div class="menu-item" data-menu="shop">
<img alt="Shop" draggable="false" src="https://em-content.zobj.net/source/telegram/386/money-with-wings_1f4b8.webp"/>
<span>Shop</span>
</div>
<div class="menu-item" data-menu="market">
<img alt="Market" draggable="false" src="https://em-content.zobj.net/source/telegram/386/star_2b50.webp"/>
<span>Market</span>
</div>
<div class="menu-item" data-menu="quests">
<img alt="Quests" draggable="false" src="https://em-content.zobj.net/source/telegram/386/trophy_1f3c6.webp"/>
<span>Quests</span>
</div>
<div class="menu-item" data-menu="games">
<img alt="Games" draggable="false" src="https://em-content.zobj.net/source/telegram/386/revolving-hearts_1f49e.webp"/>
<span>Games</span>
</div>
</div>
</div>
</footer>
<div class="leaderboard-container hidden" id="questsContainer">
<div class="leaderboard-title">Quests</div>
<div class="leaderboard-table-container" style="max-height: 400px; overflow-y: auto;">
<div class="case-container">
<img class="case-image" src="https://em-content.zobj.net/source/telegram/386/memo_1f4dd.webp"/>
<div class="case-name">Subscribe to our <a href="https://t.me/nexari_community" style="color: #4fc3f7;" target="_blank">Telegram</a></div>
<div class="case-price">
<button class="claim-button">Claim 50 <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" style="width: 16px; height: 16px;"/></button>
</div>
</div>
<div class="case-container">
<img class="case-image" src="https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp"/>
<div class="case-name">Click the controller 50 times</div>
<div class="case-price">
<button class="claim-button">Claim 150 <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" style="width: 16px; height: 16px;"/></button>
</div>
</div>
<div class="case-container">
<img class="case-image" src="https://em-content.zobj.net/source/telegram/386/star_2b50.webp"/>
<div class="case-name">Earn 100 Stars</div>
<div class="case-price">
<button class="claim-button">Claim 200 <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" style="width: 16px; height: 16px;"/></button>
</div>
</div>
<div class="case-container">
<img class="case-image" src="https://em-content.zobj.net/source/telegram/386/trophy_1f3c6.webp"/>
<div class="case-name">Reach Top 10 in Leaderboard</div>
<div class="case-price">
<button class="claim-button">Claim 500 <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" style="width: 16px; height: 16px;"/></button>
</div>
</div>
</div>
</div>
<div class="leaderboard-container hidden" id="friendsContainer">
<div class="leaderboard-title">Friends</div>
<div style="display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 1rem;">
<button onclick="
    navigator.clipboard.writeText('https://t.me/nexari_bot?start=ref123');
    const copiedMessage = document.createElement('div');
    copiedMessage.textContent = 'Ссылка скопирована';
    copiedMessage.style.position = 'fixed';
    copiedMessage.style.top = '20%';
    copiedMessage.style.left = '50%';
    copiedMessage.style.transform = 'translate(-50%, -50%)';
    copiedMessage.style.backgroundColor = '#000';
    copiedMessage.style.color = '#fff';
    copiedMessage.style.padding = '1rem';
    copiedMessage.style.borderRadius = '12px';
    document.body.appendChild(copiedMessage);
    " style="padding: 0.5rem 1rem; background: #fff; color: #000; border-radius: 12px; font-weight: 600;">
                    Copy Invite Link
                </button>
<div style="font-size: 1.2rem; color: #0ff; font-weight: bold;">+200 <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" style="width: 20px; height: 20px; vertical-align: middle;"/></div>
<div>No friends yet

</div>
</div>
</div>
<script>
            const CONFIG = { PARTICLE_COUNT: 50, CLICK_EFFECT_DURATION: 1000, RESIZE_DEBOUNCE: 200, CONFETTI_COUNT: 30, MAX_SCALE: 1.4, MIN_SCALE: 1, SCALE_INCREMENT: 0.1, INCOME_INTERVAL: 3600000 };
            const SKINS = [
                { src: "https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp", gradient: "radial-gradient(circle at 50% 50%,rgba(255,255,255,0.2),transparent 70%)", color: "#FFFFFF", worldName: "World of Consoles" },
            ];
            const CHARACTERS = [
                { src: "https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp", name: "Controller" },
                { src: "https://em-content.zobj.net/source/telegram/386/monkey-face_1f435.webp", name: "Monkey" },
                { src: "https://em-content.zobj.net/source/telegram/386/gorilla_1f98d.webp", name: "Gorilla" },
                { src: "https://em-content.zobj.net/source/telegram/386/dog-face_1f436.webp", name: "Dog" },
                { src: "https://em-content.zobj.net/source/telegram/386/cat-face_1f431.webp", name: "Cat" },
                { src: "https://em-content.zobj.net/source/telegram/386/lion_1f981.webp", name: "Lion" },
                { src: "https://em-content.zobj.net/source/telegram/386/tiger-face_1f42f.webp", name: "Tiger" },
                { src: "https://em-content.zobj.net/source/telegram/386/hamster_1f439.webp", name: "Hamster" },
                { src: "https://em-content.zobj.net/source/telegram/386/panda_1f43c.webp", name: "Panda" },
                { src: "https://em-content.zobj.net/source/telegram/386/chicken_1f414.webp", name: "Chicken" },
                { src: "https://em-content.zobj.net/source/telegram/386/baby-chick_1f424.webp", name: "Baby Chick" },
            ];
const BACKGROUND_GRADIENTS = [
  'linear-gradient(135deg, #ffafbd, #ffc3a0)',
  'linear-gradient(135deg, #89f7fe, #66a6ff)',
  'linear-gradient(135deg, #f6d365, #fda085)',
  'linear-gradient(135deg, #84fab0, #8fd3f4)',
  '#ffcc70',
  'linear-gradient(135deg, #d299c2, #fef9d7)',
  '#000000',
  'linear-gradient(135deg, #667eea, #764ba2)',
  'linear-gradient(135deg, #ffecd2, #fcb69f)',
  '#d3f8e2',
  '#f6e7d7',
  '#b2fefa',
  'linear-gradient(135deg, #e0c3fc, #8ec5fc)',
  '#d1c4e9',
  '#f48fb1',
  '#ffe082',
  '#bcaaa4',
  '#ffab91',
  '#ce93d8',
  '#90caf9',
  '#a5d6a7',
  '#b0bec5',
  '#b39ddb',
  '#ef9a9a',
  '#a1887f'
];

            const MUTATION_GRADIENT = "radial-gradient(circle at 50% 50%, #FFD700, #FF4500 70%)";
            const MARKET_SKINS = [
                { id: "skin1", character: CHARACTERS[1], background: BACKGROUND_GRADIENTS[0], price: 500, timestamp: Date.now() - 10000, isMutated: true},
                { id: "skin2", character: CHARACTERS[2], background: BACKGROUND_GRADIENTS[1], price: 750, timestamp: Date.now() - 9000, isMutated: true},
                { id: "skin3", character: CHARACTERS[3], background: BACKGROUND_GRADIENTS[2], price: 300, timestamp: Date.now() - 8000, isMutated: true},
                { id: "skin4", character: CHARACTERS[4], background: BACKGROUND_GRADIENTS[3], price: 1000, timestamp: Date.now() - 7000, isMutated: true},
                { id: "skin5", character: CHARACTERS[5], background: BACKGROUND_GRADIENTS[4], price: 600, timestamp: Date.now() - 6000, isMutated: true},
                { id: "skin6", character: CHARACTERS[6], background: BACKGROUND_GRADIENTS[5], price: 450, timestamp: Date.now() - 5000, isMutated: true},
                { id: "skin7", character: CHARACTERS[7], background: BACKGROUND_GRADIENTS[6], price: 800, timestamp: Date.now() - 4000, isMutated: true},
                { id: "skin8", character: CHARACTERS[8], background: BACKGROUND_GRADIENTS[7], price: 550, timestamp: Date.now() - 3000, isMutated: true},
                { id: "skin9", character: CHARACTERS[9], background: BACKGROUND_GRADIENTS[8], price: 700, timestamp: Date.now() - 2000, isMutated: true},
                { id: "skin10", character: CHARACTERS[10], background: BACKGROUND_GRADIENTS[9], price: 400, timestamp: Date.now() - 1000, isMutated: true},
            ];
            this.rainbowInterval = null;

            class GameState {
                constructor() {
                    this.coins = 8000;
                    this.scale = CONFIG.MIN_SCALE;
                    this.canInteract = true;
                    this.isOverlayActive = false;
                    this.isTelegram = !!window.Telegram?.WebApp?.initData;
                    this.isShopActive = false;
                    this.isMarketActive = false;
                    this.isLeaderboardActive = false;
                    this.inventory = [];
                    this.characters = [];
                    this.selectedCharacter = null;
                    this.nextIncomeTime = 0;
                    this.isTimerStarted = false;
                    this.walletConnected = false;
                    this.walletAddress = null;
                    this.leaderboard = [
                        { nickname: "Player123", coins: 1000, rank: 1 },
                        { nickname: "GamerX", coins: 800, rank: 2 },
                        { nickname: "CoinMaster", coins: 600, rank: 3 },
                        { nickname: "DiamondKing", coins: 400, rank: 4 },
                        { nickname: "CryptoStar", coins: 200, rank: 5 },
                    ];
                }
                getCoins() {
                    return this.coins;
                }
                addCoins(amount) {
                    this.coins += amount;
                    this.updateLeaderboard();
                }
                resetCoins(value) {
                    this.coins = value;
                    this.updateLeaderboard();
                }
                isTelegramEnvironment() {
                    return this.isTelegram;
                }
                isShopViewActive() {
                    return this.isShopActive;
                }
                setShopViewActive(value) {
                    this.isShopActive = value;
                }
                isMarketViewActive() {
                    return this.isMarketActive;
                }
                setMarketViewActive(value) {
                    this.isMarketActive = value;
                }
                isLeaderboardViewActive() {
                    return this.isLeaderboardActive;
                }
                setLeaderboardViewActive(value) {
                    this.isLeaderboardActive = value;
                }
                addToInventory(item) {
                    const character = {
                        ...item,
                        level: 1,
                        incomeRate: 100,
                        timerEnd: 0,
                    };
                    this.inventory.push(character);
                    this.characters.push(character);
                    if (item.name === "Controller" && !this.selectedCharacter) {
                        this.selectedCharacter = character;
                    }
                }
                getInventory() {
                    return this.inventory;
                }
                getCharacters() {
                    return this.characters;
                }
                setSelectedCharacter(character) {
                    this.selectedCharacter = character;
                    this.isTimerStarted = false;
                    this.nextIncomeTime = 0;
                }
                getSelectedCharacter() {
                    return this.selectedCharacter;
                }
                updateLeaderboard() {
                    const playerEntry = this.leaderboard.find((p) => p.nickname === "Player123");
                    if (playerEntry) {
                        playerEntry.coins = this.coins;
                    }
                    this.leaderboard.sort((a, b) => b.coins - a.coins);
                    this.leaderboard.forEach((player, index) => {
                        player.rank = index + 1;
                    });
                }
                getLeaderboard() {
                    return this.leaderboard;
                }

                upgradeCharacter(character) {
                    if (character.level < 5) {
                        let upgradeCost;
                        switch (character.level) {
                            case 1:
                                upgradeCost = 500;
                                break;
                            case 2:
                                upgradeCost = 1000;
                                break;
                            case 3:
                                upgradeCost = 2000;
                                break;
                            case 4:
                                upgradeCost = 4000;
                                break;
                        }
                        if (this.coins >= upgradeCost) {
                            this.coins -= upgradeCost;
                            character.level += 1;
                            character.incomeRate = character.level * 100;
                            this.updateLeaderboard();
                            return true;
                        }
                    }
                    return false;
                }

                getNextIncomeTime() {
                    return this.nextIncomeTime;
                }
                setNextIncomeTime(time) {
                    this.nextIncomeTime = time;
                }
                startTimer() {
                    this.isTimerStarted = true;
                }
                isTimerActive() {
                    return this.isTimerStarted;
                }
                setWalletConnected(connected, address = null) {
                    this.walletConnected = connected;
                    this.walletAddress = address;
                }
                isWalletConnected() {
                    return this.walletConnected;
                }
                getWalletAddress() {
                    return this.walletAddress;
                }
            }
            class ParticleSystem {
                constructor(canvas, count) {
                    this.canvas = canvas;
                    this.ctx = canvas.getContext("2d");
                    this.particles = new Array(count);
                    this.time = 0;
                    this.isAnimating = false;
                    for (let i = 0; i < count; i++) this.particles[i] = this.createParticle();
                }
                createParticle() {
                    return {
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        size: Math.random() * 1.2 + 0.4,
                        speedX: Math.random() * 0.5 - 0.25,
                        speedY: Math.random() * 0.5 - 0.25,
                        opacity: Math.random() * 0.5 + 0.3,
                    };
                }
                update() {
                    this.time += 0.016;
                    for (let i = 0; i < this.particles.length; i++) {
                        const p = this.particles[i];
                        p.x += p.speedX;
                        p.y += p.speedY;
                        p.speedX += (Math.random() - 0.5) * 0.05;
                        p.speedY += (Math.random() - 0.5) * 0.05;
                        p.speedX = Math.max(-0.5, Math.min(0.5, p.speedX));
                        p.speedY = Math.max(-0.5, Math.min(0.5, p.speedY));
                        p.opacity = 0.3 + (0.5 * (Math.sin(this.time + i) + 1)) / 2;
                        if (p.x < 0 || p.x > this.canvas.width) p.speedX *= -1;
                        if (p.y < 0 || p.y > this.canvas.height) p.speedY *= -1;
                    }

                }
                draw() {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    const highlightColor = getComputedStyle(document.documentElement).getPropertyValue("--highlight-color").trim();
                    let r = 255,
                        g = 255,
                        b = 255;
                    if (highlightColor.startsWith("#")) {
                        const hex = highlightColor.replace("#", "");
                        r = parseInt(hex.substring(0, 2), 16);
                        g = parseInt(hex.substring(2, 4), 16);
                        b = parseInt(hex.substring(4, 6), 16);
                    }
                    for (let i = 0; i < this.particles.length; i++) {
                        const p = this.particles[i];
                        this.ctx.fillStyle = `rgba(${r},${g},${b},${p.opacity})`;
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                    // Draw lines between close particles
for (let i = 0; i < this.particles.length; i++) {
    const p1 = this.particles[i];
    for (let j = i + 1; j < this.particles.length; j++) {
        const p2 = this.particles[j];
        const dx = p1.x - p2.x;
        const dy = p1.y - p2.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < 80) {
            const opacity = 1 - distance / 80;
            this.ctx.strokeStyle = `rgba(255, 255, 255, ${opacity * 0.2})`;
            this.ctx.beginPath();
            this.ctx.moveTo(p1.x, p1.y);
            this.ctx.lineTo(p2.x, p2.y);
            this.ctx.stroke();
        }
    }
}

                }
                start() {
                    if (this.isAnimating) return;
                    this.isAnimating = true;
                    this.animate();
                }
                stop() {
                    this.isAnimating = false;
                }
                animate() {
                    if (!this.isAnimating) return;
                    this.update();
                    this.draw();
                    requestAnimationFrame(() => this.animate());
                }
                resize() {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                    for (let i = 0; i < this.particles.length; i++) {
                        const p = this.particles[i];
                        p.x = Math.random() * this.canvas.width;
                        p.y = Math.random() * this.canvas.height;
                    }
                }
            }
            class ConfettiSystem {
                constructor(canvas, count, nextColor) {
                    this.canvas = canvas;
                    this.ctx = canvas.getContext("2d");
                    this.particles = [];
                    this.isAnimating = false;
                    this.nextColor = nextColor || "#FFFFFF";
                    this.colors = ["#FFFFFF", this.nextColor];
                    this.maxCount = count;
                    this.spawnRate = 0.05;
                    this.removeProbability = 0.02;
                }
                createParticle() {
                    return {
                        x: Math.random() * this.canvas.width,
                        y: -Math.random() * 50,
                        width: Math.random() * 3 + 3,
                        height: Math.random() * 3 + 3,
                        speedY: Math.random() * 2 + 2,
                        opacity: 1,
                        color: this.colors[Math.floor(Math.random() * this.colors.length)],
                        rotation: Math.random() * Math.PI * 2,
                    };
                }
                update() {
                    this.particles = this.particles.filter((p) => {
                        p.y += p.speedY;
                        p.rotation += 0.05;
                        if (p.y > this.canvas.height * 0.9) return Math.random() > this.removeProbability;
                        return true;
                    });
                    if (this.particles.length < this.maxCount && Math.random() < this.spawnRate) this.particles.push(this.createParticle());
                }
                draw() {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    for (let i = 0; i < this.particles.length; i++) {
                        const p = this.particles[i];
                        this.ctx.save();
                        this.ctx.translate(p.x + p.width / 2, p.y + p.height / 2);
                        this.ctx.rotate(p.rotation);
                        this.ctx.fillStyle = p.color;
                        this.ctx.globalAlpha = p.opacity;
                        this.ctx.fillRect(-p.width / 2, -p.height / 2, p.width, p.height);
                        this.ctx.restore();
                    }
                }
                start(nextColor) {
                    if (this.isAnimating) return;
                    if (nextColor) {
                        this.nextColor = nextColor;
                        this.colors = ["#FFFFFF", this.nextColor];
                    }
                    this.particles = [];
                    for (let i = 0; i < this.maxCount; i++) {
                        const p = this.createParticle();
                        p.y = Math.random() * this.canvas.height;
                        this.particles.push(p);
                    }
                    this.isAnimating = true;
                    this.canvas.classList.remove("game-hidden");
                    this.canvas.classList.add("visible");
                    this.animate();
                }
                stop() {
                    this.isAnimating = false;
                    this.canvas.classList.remove("visible");
                    this.canvas.classList.add("game-hidden");
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.particles = [];
                }
                animate() {
                    if (!this.isAnimating) return;
                    this.update();
                    this.draw();
                    requestAnimationFrame(() => this.animate());
                }
                resize() {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                    this.particles = [];
                    if (this.isAnimating) {
                        for (let i = 0; i < this.maxCount; i++) {
                            const p = this.createParticle();
                            p.y = Math.random() * this.canvas.height;
                            this.particles.push(p);
                        }
                    }
                }
            }
            class ClickEffectPool {
                constructor() {
                    this.pool = [];
                    this.active = [];
                }
                getEffect() {
                    let effect = this.pool.pop();
                    if (!effect) {
                        effect = document.createElement("img");
                        effect.src = "https://em-content.zobj.net/source/telegram/386/collision_1f4a5.webp";
                        effect.className = "click-effect";
                        effect.setAttribute("draggable", "false");
                    }
                    return effect;
                }
                showEffect(x, y) {
                    const effect = this.getEffect();
                    effect.style.left = `${x}px`;
                    effect.style.top = `${y}px`;
                    document.body.appendChild(effect);
                    this.active.push(effect);
                    setTimeout(() => {
                        effect.remove();
                        this.active = this.active.filter((e) => e !== effect);
                        this.pool.push(effect);
                    }, CONFIG.CLICK_EFFECT_DURATION);
                }
            }
            class UIManager {
                constructor(elements) {
                    this.elements = elements;
                    this.pendingUpdates = {};
                }
                updateCoinCounterPosition() {
                    const topMenuHeight = this.elements.topMenu.offsetHeight;
                    this.elements.coinCounter.style.top = `${topMenuHeight + 10}px`;
                }
                updateLoadingPercent(percent) {
                    this.elements.loadingPercent.textContent = `${Math.round(percent)}%`;
                }
                showGameUI() {
                    this.elements.loadingScreen.classList.add("hidden");
                    this.elements.topMenu.classList.remove("game-hidden");
                    this.elements.topMenu.classList.add("visible");
                    this.elements.particleCanvas.classList.remove("game-hidden");
                    this.elements.particleCanvas.classList.add("visible");
                    this.elements.mainContent.classList.remove("game-hidden");
                    this.elements.mainContent.classList.add("visible");
                    this.elements.footer.classList.remove("game-hidden");
                    this.elements.footer.classList.add("visible");
                    setTimeout(() => {
                        this.elements.loadingScreen.style.display = "none";
                    }, 500);
                }
                updateCharacterScale(scale) {
                    this.elements.character.style.transform = `scale(${scale})`;
                }
                updateTimerDisplay(timeLeft) {
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    this.elements.timerDisplay.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
                }
                toggleConnectButton(show) {
                    this.elements.tonConnect.style.display = show ? "flex" : "none";
                }
                toggleDisconnectButton(show) {
                    this.elements.disconnectWallet.style.display = show ? "block" : "none";
                }
                queueUpdate(key, value) {
                    this.pendingUpdates[key] = value;
                }
                applyUpdates() {
                    requestAnimationFrame(() => {
                        for (const [key, value] of Object.entries(this.pendingUpdates)) {
                            if (key === "coins") this.elements.coinCount.textContent = Math.floor(value);
                            if (key === "totalCoins") this.elements.totalCoins.textContent = Math.floor(value);
                            if (key === "characterSrc") this.elements.character.src = value;
                            if (key === "gradient") document.documentElement.style.setProperty("--bg-gradient", value);
                            if (key === "highlightColor") document.documentElement.style.setProperty("--highlight-color", value);
                            if (key === "worldName") this.elements.playerStats.textContent = value;
                            if (key === "incomeRate") this.elements.incomeRate.textContent = value;
                        }
                        this.pendingUpdates = {};
                        const digits = this.elements.coinCount.textContent.length;
                        const translateX = digits > 5 ? -(digits - 5) * 10 : 0;
                        this.elements.coinCounter.style.transform = `translateX(${translateX}px)`;
                    });
                }
            }
            class CharacterController {
                constructor(state, ui, effectPool, confettiSystem) {
                    this.state = state;
                    this.ui = ui;
                    this.effectPool = effectPool;
                    this.confettiSystem = confettiSystem;
                    this.listeners = [];
                    this.lastTapTime = 0;
                    this.resetTimeout = null;
                }
                initialize() {
                    const currentSkin = SKINS[0];
                    this.ui.queueUpdate("characterSrc", currentSkin.src);
                    this.ui.queueUpdate("gradient", currentSkin.gradient);
                    this.ui.queueUpdate("highlightColor", currentSkin.color);
                    this.ui.queueUpdate("worldName", currentSkin.worldName);
                    this.ui.queueUpdate("coins", this.state.getCoins());
                    this.ui.queueUpdate("totalCoins", this.state.getCoins());
                    this.updateIncomeRate();
                    this.ui.applyUpdates();
                    this.attachListeners();
                }
                updateIncomeRate() {
                    const selectedCharacter = this.state.getSelectedCharacter();
                    const totalIncomeRate = selectedCharacter ? selectedCharacter.incomeRate || 100 : 100;
                    this.ui.queueUpdate("incomeRate", totalIncomeRate);
                }
updateAppearance() {
    const currentSkin = SKINS[0];
    const selectedCharacter = this.state.getSelectedCharacter();

    if (selectedCharacter) {
        this.ui.queueUpdate("characterSrc", selectedCharacter.src);

        if (selectedCharacter.isMutated) {
            const bg = selectedCharacter.background || MUTATION_GRADIENT;

            if (bg === '#000000' || bg.toLowerCase().includes('black')) {
                document.body.style.backgroundImage = '';
                document.body.style.background = '#000';

                if (this.rainbowInterval) clearInterval(this.rainbowInterval);
                // [удалено] радужный setInterval эффект при черном фоне
            } else {
                if (this.rainbowInterval) {
                    clearInterval(this.rainbowInterval);
                    this.rainbowInterval = null;
                }
                document.body.classList.remove('rainbow-flash');
                document.body.style.backgroundImage = bg;
            }

            this.ui.queueUpdate("highlightColor", "#FFD700");
        } else {
            // обычный персонаж
            if (this.rainbowInterval) {
                clearInterval(this.rainbowInterval);
                this.rainbowInterval = null;
            }
            document.body.classList.remove('rainbow-flash');
            document.body.style.background = '';
            document.body.style.backgroundImage = '';

            // 🔁 Сбросить цвета меню
            document.documentElement.style.setProperty('--highlight-color', '#fff');
            document.documentElement.style.setProperty('--top-menu-bg', 'rgba(30, 30, 30, 0.85)');
            document.documentElement.style.setProperty('--footer-bg', 'rgba(30, 30, 30, 0.85)');
            document.documentElement.style.setProperty('--counter-bg', 'rgba(30, 30, 30, 0.85)');
        }
    }

    this.ui.queueUpdate("worldName", currentSkin.worldName);
    this.ui.applyUpdates();
    this.updateIncomeRate();
}


                handleTap(e) {
                    e.preventDefault();
                    const now = performance.now();
                    if (now - this.lastTapTime < 100) return;
                    this.lastTapTime = now;
                    if (!this.state.canInteract || this.state.isOverlayActive) return;
                    if (!this.state.isTimerActive()) {
                        this.state.startTimer();
                        this.state.setNextIncomeTime(Date.now() + CONFIG.INCOME_INTERVAL);
                        this.startTimer();
                        this.startIncomeTimer();
                        this.startCoinUpdate();
                    }
                    this.state.scale = Math.min(this.state.scale + CONFIG.SCALE_INCREMENT, CONFIG.MAX_SCALE);
                    this.ui.updateCharacterScale(this.state.scale);
                    // [удалено] эффект клика
                    if (this.resetTimeout) clearTimeout(this.resetTimeout);
                    this.resetTimeout = setTimeout(() => {
                        if (this.state.scale !== CONFIG.MIN_SCALE) {
                            this.state.scale = CONFIG.MIN_SCALE;
                            this.ui.updateCharacterScale(this.state.scale);
                        }
                    }, 1000);
                }
                startIncomeTimer() {
                    setInterval(() => {
                        const selectedCharacter = this.state.getSelectedCharacter();
                        const totalIncomeRate = selectedCharacter ? selectedCharacter.incomeRate || 100 : 100;
                        this.ui.queueUpdate("incomeRate", totalIncomeRate);
                        this.ui.applyUpdates();
                        this.state.setNextIncomeTime(Date.now() + CONFIG.INCOME_INTERVAL);
                    }, CONFIG.INCOME_INTERVAL);
                }
                startCoinUpdate() {
                    const updateCoins = () => {
                        if (this.state.isTimerActive()) {
                            const selectedCharacter = this.state.getSelectedCharacter();
                            const totalIncomeRate = selectedCharacter ? selectedCharacter.incomeRate || 100 : 100;
                            const incomePerSecond = totalIncomeRate / 3600;
                            this.state.addCoins(incomePerSecond);
                            this.ui.queueUpdate("coins", this.state.getCoins());
                            this.ui.queueUpdate("totalCoins", this.state.getCoins());
                            this.ui.applyUpdates();
                        }
                        setTimeout(updateCoins, 1000);
                    };
                    updateCoins();
                }
                startTimer() {
                    const updateTimer = () => {
                        if (!this.state.isTimerActive()) {
                            this.ui.updateTimerDisplay(0);
                        } else {
                            const timeLeft = this.state.getNextIncomeTime() - Date.now();
                            if (timeLeft <= 0) {
                                this.ui.updateTimerDisplay(0);
                            } else {
                                this.ui.updateTimerDisplay(timeLeft);
                            }
                        }
                        requestAnimationFrame(updateTimer);
                    };
                    updateTimer();
                }
                attachListeners() {
                    const tapListener = this.handleTap.bind(this);
                    this.ui.elements.character.addEventListener("pointerdown", tapListener);
                    this.listeners.push({ element: this.ui.elements.character, type: "pointerdown", listener: tapListener });
                }
                destroy() {
                    this.listeners.forEach(({ element, type, listener }) => element.removeEventListener(type, listener));
                    if (this.resetTimeout) clearTimeout(this.resetTimeout);
                }
            }
            class Game {
                constructor(elements) {
                    this.state = new GameState();
                    this.ui = new UIManager(elements);
                    this.particleSystem = new ParticleSystem(elements.particleCanvas, CONFIG.PARTICLE_COUNT);
                    this.confettiSystem = new ConfettiSystem(elements.confettiCanvas, CONFIG.CONFETTI_COUNT, "#FFFFFF");
                    this.effectPool = new ClickEffectPool();
                    this.characterController = new CharacterController(this.state, this.ui, this.effectPool, this.confettiSystem);
                    this.resizeTimeout = null;
                    this.listeners = [];
                    this.isInventoryView = false;
                    this.availableMarketSkins = [...MARKET_SKINS];
                    this.tonConnectUI = null;
                }
                initializeWallet() {
                    try {
                        this.tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                            manifestUrl: "https://max27347.github.io/ProGameNew/manifest.json",
                            buttonRootId: "ton-connect",
                        });
                        if (this.state.isTelegramEnvironment()) {
                            this.tonConnectUI.uiOptions = {
                                twaReturnUrl: "https://t.me/nexari_bot",
                            };
                        }
                        this.tonConnectUI.onStatusChange((walletInfo) => {
                            if (walletInfo) {
                                const address = walletInfo.account.address;
                                this.state.setWalletConnected(true, address);
                                this.ui.toggleDisconnectButton(true);
                                this.ui.toggleConnectButton(false);
                            } else {
                                this.state.setWalletConnected(false, null);
                                this.ui.toggleDisconnectButton(false);
                                if (this.ui.elements.marketContainer.classList.contains("visible")) {
                                    this.ui.toggleConnectButton(true);
                                }
                            }
                            this.ui.applyUpdates();
                        });
                        const disconnectListener = async () => {
                            try {
                                await this.tonConnectUI.disconnect();
                                console.log("Wallet disconnected");
                            } catch (error) {
                                console.error("Error disconnecting wallet:", error);
                                alert(`Failed to disconnect wallet: ${error.message}`);
                            }
                        };
                        this.ui.elements.disconnectWallet.addEventListener("pointerdown", disconnectListener);
                        this.listeners.push({
                            element: this.ui.elements.disconnectWallet,
                            type: "pointerdown",
                            listener: disconnectListener,
                        });
                        if (this.tonConnectUI.wallet) {
                            this.state.setWalletConnected(true, this.tonConnectUI.wallet.account.address);
                            this.ui.toggleDisconnectButton(true);
                            this.ui.applyUpdates();
                        }
                    } catch (error) {
                        console.error("Error initializing TON Connect UI:", error);
                        this.ui.applyUpdates();
                    }
                }
                async preloadAssets() {
                    const imageUrls = [
                        "https://placehold.co/40x40",
                        ...SKINS.map((skin) => skin.src),
                        ...CHARACTERS.map((char) => char.src),
                        "https://em-content.zobj.net/source/telegram/386/television_1f4fa.webp",
                        "https://em-content.zobj.net/source/telegram/386/crown_1f451.webp",
                        "https://em-content.zobj.net/source/telegram/386/shopping-bags_1f6cd-fe0f.webp",
                        "https://em-content.zobj.net/source/telegram/386/collision_1f4a5.webp",
                        "https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp",
                        "https://em-content.zobj.net/source/telegram/386/popcorn_1f37f.webp",
                        "https://em-content.zobj.net/source/telegram/386/luggage_1f9f3.webp",
                        "https://em-content.zobj.net/source/telegram/386/joystick_1f579-fe0f.webp",
                    ];
                    let loadedCount = 0;
                    const totalImages = imageUrls.length;
                    const loadImage = (url) => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.src = url;
                            img.onload = () => {
                                loadedCount++;
                                const percent = (loadedCount / totalImages) * 100;
                                this.ui.updateLoadingPercent(percent);
                                resolve();
                            };
                            img.onerror = () => {
                                console.warn(`Failed to load image: ${url}. Attempting fallback.`);
                                img.src = "https://dummyimage.com/40x40/000/fff";
                                img.onload = () => {
                                    loadedCount++;
                                    const percent = (loadedCount / totalImages) * 100;
                                    this.ui.updateLoadingPercent(percent);
                                    resolve();
                                };
                                img.onerror = () => {
                                    console.error(`Failed to load fallback image for: ${url}`);
                                    loadedCount++;
                                    const percent = (loadedCount / totalImages) * 100;
                                    this.ui.updateLoadingPercent(percent);
                                    resolve();
                                };
                            };
                        });
                    };
                    await Promise.all(imageUrls.map(loadImage));
                    this.ui.showGameUI();
                    this.characterController.initialize();
                    this.particleSystem.start();
                    this.initializeWallet();
                }
                updateInventoryDisplay() {
                    const inventoryContainer = this.ui.elements.inventoryItems;
                    inventoryContainer.innerHTML = "";
                    const inventory = this.state.getInventory();
                    inventory.forEach((item) => {
                        const itemDiv = document.createElement("div");
                        itemDiv.className = "inventory-item-container";
                        itemDiv.style.background = item.background || "none";
                        itemDiv.style.boxShadow = "0 0 10px rgba(255,255,255,0.3)";
                        const img = document.createElement("img");
                        img.src = item.src;
                        img.alt = item.name;
                        img.className = "inventory-image";
                        if (item.isMutated) img.className += " mutated";
                        const nameDiv = document.createElement("div");
                        nameDiv.className = "inventory-name";
                        nameDiv.textContent = item.name;
                        const statsDiv = document.createElement("div");
                        statsDiv.className = "inventory-stats";
                        statsDiv.style.fontSize = "0.9rem";
                        statsDiv.style.color = "#FFF";
                        statsDiv.style.opacity = "0.8";
                        statsDiv.textContent = `Lvl ${item.level}, ${item.incomeRate}/h`;
                        const upgradeButton = document.createElement("div");
                        upgradeButton.className = "upgrade-button";

                        if (item.level < 5) {
                            let cost = item.level === 1 ? 500 : item.level === 2 ? 1000 : item.level === 3 ? 2000 : 4000;
                            upgradeButton.innerHTML = `Up ${cost} <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem Stone" class="gem-icon">`;
                        } else {
                            upgradeButton.innerHTML = "Max Level";
                            upgradeButton.style.opacity = "0.5";
                            upgradeButton.style.pointerEvents = "none";
                        }

                        if (item.level < 5) {
                            upgradeButton.addEventListener("pointerdown", () => {
                                if (this.state.upgradeCharacter(item)) {
                                    itemDiv.classList.add("upgrade-anim");
                                    setTimeout(() => itemDiv.classList.remove("upgrade-anim"), 500);
                                    this.ui.queueUpdate("coins", this.state.getCoins());
                                    this.ui.queueUpdate("totalCoins", this.state.getCoins());
                                    this.ui.applyUpdates();
                                    showUpgradeMessage();
                                    this.updateInventoryDisplay();
                                    if (this.state.getSelectedCharacter() === item) {
                                        this.characterController.updateAppearance();
                                    }
                                    this.characterController.updateIncomeRate();
                                } else {
                                    alert("Not enough diamonds or max level reached!");
                                }
                            });
                        } else {
                            upgradeButton.style.opacity = "0.5";
                            upgradeButton.style.pointerEvents = "none";
                        }
                        itemDiv.appendChild(img);
                        itemDiv.appendChild(nameDiv);
                        itemDiv.appendChild(statsDiv);
                        itemDiv.appendChild(upgradeButton);
                        itemDiv.addEventListener("pointerdown", (e) => {
                            if (e.target !== upgradeButton && !e.target.closest(".upgrade-button")) {
                                this.state.setSelectedCharacter(item);
                                this.ui.elements.inventoryContainer.classList.remove("visible");
                                this.ui.elements.inventoryContainer.classList.add("hidden");
                                this.ui.elements.shopContainer.classList.remove("hidden");
                                this.ui.elements.shopContainer.classList.add("visible");
                                this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                                this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                                this.ui.elements.inventoryArrowRight.classList.remove("visible");
                                this.ui.elements.inventoryArrowRight.classList.add("hidden");
                                this.ui.elements.shopArrowLeft.classList.remove("hidden");
                                this.ui.elements.shopArrowLeft.classList.add("visible");
                                this.ui.elements.shopArrowRight.classList.remove("hidden");
                                this.ui.elements.shopArrowRight.classList.add("visible");
                                this.isInventoryView = false;
                                this.characterController.updateAppearance();
                            }
                        });
                        inventoryContainer.appendChild(itemDiv);
                    });
                }
                updateLeaderboardDisplay() {
                    const tbody = this.ui.elements.leaderboardTable.querySelector("tbody");
                    tbody.innerHTML = "";
                    const leaderboard = this.state.getLeaderboard();
                    leaderboard.forEach((player) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                <td>${player.rank}</td>
                <td>${player.nickname}</td>
                <td>${Math.floor(player.coins)}</td>
            `;
                        tbody.appendChild(row);
                    });
                }
                initializeMarketFilters() {
                    const characterFilter = this.ui.elements.characterFilter;
                    const backgroundFilter = this.ui.elements.backgroundFilter;
                    CHARACTERS.forEach((char) => {
                        const option = document.createElement("option");
                        option.value = char.name;
                        option.textContent = char.name;
                        characterFilter.appendChild(option);
                    });
                    BACKGROUND_GRADIENTS.forEach((bg, index) => {
                        const option = document.createElement("option");
                        option.value = bg;
                        option.textContent = `Background ${index + 1}`;
                        backgroundFilter.appendChild(option);
                    });
                }
                updateMarketDisplay() {
                    const marketContainer = this.ui.elements.marketItems;
                    marketContainer.innerHTML = "";
                    let filteredSkins = [...this.availableMarketSkins];
                    const characterFilter = this.ui.elements.characterFilter.value;
                    const backgroundFilter = this.ui.elements.backgroundFilter.value;
                    const sortOption = this.ui.elements.priceSort.value;
                    if (characterFilter) {
                        filteredSkins = filteredSkins.filter((skin) => skin.character.name === characterFilter);
                    }
                    if (backgroundFilter) {
                        filteredSkins = filteredSkins.filter((skin) => skin.background === backgroundFilter);
                    }
                    if (sortOption === "price-desc") {
                        filteredSkins.sort((a, b) => b.price - a.price);
                    } else if (sortOption === "price-asc") {
                        filteredSkins.sort((a, b) => a.price - b.price);
                    } else {
                        filteredSkins.sort((a, b) => b.timestamp - a.timestamp);
                    }
                    filteredSkins.forEach((skin) => {
                        const itemDiv = document.createElement("div");
                        itemDiv.className = "market-item-container";
                        itemDiv.style.background = skin.background;
                        itemDiv.style.boxShadow = "0 0 10px rgba(255,255,255,0.3)";
                        itemDiv.style.minHeight = "200px";
                        const img = document.createElement("img");
                        img.src = skin.character.src;
                        img.alt = skin.character.name;
                        img.className = "market-image";
                        const nameDiv = document.createElement("div");
                        nameDiv.className = "market-name";
                        nameDiv.textContent = skin.character.name;
                        const priceDiv = document.createElement("div");
                        priceDiv.className = "market-price";
                        priceDiv.innerHTML = `
                <span>${skin.price}</span>
                <img src="https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp" alt="Gem Stone" class="gem-icon">
            `;
                        const buyButton = document.createElement("div");
                        buyButton.className = "buy-button";
                        buyButton.textContent = "Buy";
                        buyButton.addEventListener("pointerdown", () => {
                            if (this.state.getCoins() >= skin.price) {
                                this.state.addToInventory({
    src: skin.character.src,
    name: skin.character.name,
    background: skin.background,
    isMutated: skin.isMutated || false
});

                                this.availableMarketSkins = this.availableMarketSkins.filter((s) => s.id !== skin.id);
                                this.updateMarketDisplay();
                                this.updateInventoryDisplay();
                                this.ui.queueUpdate("coins", this.state.getCoins());
                                this.ui.queueUpdate("totalCoins", this.state.getCoins());
                                this.ui.applyUpdates();
                            } else {
                                alert("Not enough diamonds!");
                            }
                        });
                        itemDiv.appendChild(img);
                        itemDiv.appendChild(nameDiv);
                        itemDiv.appendChild(priceDiv);
                        itemDiv.appendChild(buyButton);
                        marketContainer.appendChild(itemDiv);
                    });
                }
                showCaseAnimation(caseType) {
                    const isDiamondCase = caseType === "diamond-rain";
                    const isTelegramGift = caseType === "telegram-gift";
                    const currency = isDiamondCase ? "100 Diamonds" : isTelegramGift ? "Free" : "Free (Test)";
                    const overlay = document.createElement("div");
                    overlay.className = "case-animation-overlay hidden";
                    const message = document.createElement("div");
                    message.className = "case-animation-message hidden";
                    message.textContent = `Spin for ${currency}!`;
                    const animationContainer = document.createElement("div");
                    animationContainer.id = "caseAnimationContainer";
                    animationContainer.className = "case-animation-container";
                    const rouletteStrip = document.createElement("div");
                    rouletteStrip.className = "roulette-strip";
                    animationContainer.appendChild(rouletteStrip);
                    const animationBar = document.createElement("div");
                    animationBar.className = "animation-bar";
                    animationContainer.appendChild(animationBar);
                    const spinButton = document.createElement("div");
                    spinButton.className = "case-animation-button";
                    spinButton.textContent = "Spin";
                    const cancelButton = document.createElement("div");
                    cancelButton.className = "case-animation-cancel";
                    cancelButton.textContent = "I'll stop tempting fate";
                    overlay.appendChild(message);
                    overlay.appendChild(animationContainer);
                    overlay.appendChild(spinButton);
                    overlay.appendChild(cancelButton);
                    document.body.appendChild(overlay);

                    const telegramGiftItems = [
                        { type: "skin", name: "Car", src: "https://em-content.zobj.net/source/telegram/386/automobile_1f697.webp" },
                        { type: "skin", name: "Boat", src: "https://em-content.zobj.net/source/telegram/386/motor-boat_1f6e5-fe0f.webp" },
                        { type: "skin", name: "Plane", src: "https://em-content.zobj.net/source/telegram/386/airplane_2708-fe0f.webp" },
                        { type: "skin", name: "Rocket", src: "https://em-content.zobj.net/source/telegram/386/rocket_1f680.webp" },
                        { type: "skin", name: "Phone", src: "https://em-content.zobj.net/source/telegram/386/mobile-phone_1f4f1.webp" },
                    ];

                    const items = isTelegramGift ? telegramGiftItems : [...CHARACTERS.slice(1)];
                    const diamondItem = { src: "https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp", name: "Diamonds" };
                    if (isDiamondCase) {
                        items.push(diamondItem);
                    }
                    const rouletteItems = [];
                    const reward = this.generateCaseReward(caseType);
                    for (let i = 0; i < 40; i++) {
                        if (i === 19) {
                            rouletteItems.push(reward);
                            continue;
                        } else if (caseType === "telegram-gift-2") {
                            if (Math.random() < 0.9) {
                                const value = 200 + Math.floor(Math.random() * 101);
                                randomItem = {
                                    name: `${value} Diamonds`,
                                    src: "https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp",
                                    type: "diamonds",
                                    value,
                                };
                            } else {
                                const gift2skins = [
                                    { name: "Car", src: "https://em-content.zobj.net/source/telegram/386/automobile_1f697.webp" },
                                    { name: "Boat", src: "https://em-content.zobj.net/source/telegram/386/motor-boat_1f6e5-fe0f.webp" },
                                    { name: "Plane", src: "https://em-content.zobj.net/source/telegram/386/airplane_2708-fe0f.webp" },
                                    { name: "Rocket", src: "https://em-content.zobj.net/source/telegram/386/rocket_1f680.webp" },
                                    { name: "Phone", src: "https://em-content.zobj.net/source/telegram/386/mobile-phone_1f4f1.webp" },
                                ];
                                randomItem = gift2skins[Math.floor(Math.random() * gift2skins.length)];
                                randomItem.type = "skin";
                            }
                        }
                        let randomItem;
                        if (isDiamondCase && Math.random() < 0.6) {
                            randomItem = diamondItem;
                        } else if (isTelegramGift) {
                            randomItem = telegramGiftItems[Math.floor(Math.random() * telegramGiftItems.length)];
                        } else {
                            randomItem = items[Math.floor(Math.random() * (isDiamondCase ? items.length : CHARACTERS.length - 1))];
                        }
                        rouletteItems.push({
                            ...randomItem,
                            isMutated: randomItem.name !== "Diamonds" && Math.random() < 0.1,
                            background: BACKGROUND_GRADIENTS[Math.floor(Math.random() * BACKGROUND_GRADIENTS.length)],
                            value: randomItem.name === "Diamonds" ? Math.floor(Math.random() * 250) + 1 : undefined,
                        });
                    }

                    const renderRoulette = () => {
                        rouletteStrip.innerHTML = "";
                        rouletteItems.forEach((item, index) => {
                            const itemDiv = document.createElement("div");
                            itemDiv.className = "roulette-item";
                            itemDiv.dataset.itemName = item.name;
                            itemDiv.style.background = item.background;
                            itemDiv.style.boxShadow = "0 0 10px rgba(255,255,255,0.3)";
                            const bgDiv = document.createElement("div");
                            bgDiv.className = "animation-background";
                            bgDiv.style.background = item.background;
                            itemDiv.appendChild(bgDiv);

                            const img = document.createElement("img");
                            img.src = item.src;
                            img.alt = item.name;
                            img.className = "animation-character";
                            if (item.isMutated && item.name !== "Diamonds") img.className += " mutated";
                            itemDiv.appendChild(img);

                            if (index === 19) {
                                itemDiv.dataset.winner = "true";
                            }
                            rouletteStrip.appendChild(itemDiv);
                        });
                    };

                    renderRoulette();
                    requestAnimationFrame(() => {
                        overlay.classList.remove("hidden");
                        overlay.classList.add("visible");
                        message.classList.remove("hidden");
                        message.classList.add("visible");
                        setTimeout(() => {
                            spinButton.className += " visible";
                            cancelButton.className += " visible";
                        }, 300);
                    });

                    const onCancel = () => {
                        overlay.classList.remove("visible");
                        overlay.classList.add("hidden");
                        message.classList.remove("visible");
                        message.classList.add("hidden");
                        spinButton.classList.remove("visible");
                        cancelButton.classList.remove("visible");
                        setTimeout(() => {
                            overlay.remove();
                            this.state.isOverlayActive = false;
                        }, 500);
                        cancelButton.removeEventListener("pointerdown", onCancel);
                    };
                    cancelButton.addEventListener("pointerdown", onCancel);

                    const startRoulette = () => {
                        if (isDiamondCase && this.state.getCoins() < 100) {
                            alert("Not enough diamonds!");
                            onCancel();
                            return;
                        }
                        if (isDiamondCase) {
                            this.state.addCoins(-100);
                            this.ui.queueUpdate("coins", this.state.getCoins());
                            this.ui.queueUpdate("totalCoins", this.state.getCoins());
                            this.ui.applyUpdates();
                        }
                        spinButton.style.pointerEvents = "none";
                        spinButton.style.opacity = "0.5";
                        rouletteStrip.style.opacity = "1";
                        rouletteStrip.style.animation = "roulette-spin 5s cubic-bezier(0.1, 0.7, 0.3, 1) forwards";

                        const onAnimationEnd = () => {
                            const isMobile = window.innerWidth <= 600;
                            rouletteStrip.style.transform = isMobile ? "translateX(-2008px)" : "translateX(-2434px)";
                            const winnerIndex = 19;
                            const winnerItem = rouletteStrip.children[winnerIndex];
                            if (winnerItem) {
                                if (isTelegramGift && reward.name !== "Diamonds") {
                                    const animContainer = winnerItem.querySelector(".animation-character");
                                    if (animContainer) {
                                        animContainer.innerHTML = "";
                                        if (reward.isMutated) {
                                            animContainer.style.filter = "brightness(1.5) hue-rotate(200deg)";
                                        }
                                    }
                                } else {
                                    const img = winnerItem.querySelector("img");
                                    if (img) {
                                        img.src = reward.src;
                                        img.alt = reward.name;
                                        img.className = "animation-character";
                                        if (reward.isMutated && reward.name !== "Diamonds") img.className += " mutated";
                                    }
                                }
                                const bgDiv = winnerItem.querySelector(".animation-background");
                                if (bgDiv) {
                                    bgDiv.style.background = reward.background;
                                }
                                winnerItem.dataset.itemName = reward.name;
                                winnerItem.style.background = reward.background;
                                winnerItem.style.boxShadow = "0 0 10px rgba(255,255,255,0.3)";
                                winnerItem.dataset.winner = "true";
                                winnerItem.classList.add("winner");
                                message.textContent = `You won ${reward.name === "Diamonds" ? `${reward.value} Diamonds` : reward.name}${reward.isMutated && reward.name !== "Diamonds" ? " (Mutated)" : ""}!`;
                                if (reward.name === "Diamonds") {
                                    this.state.addCoins(reward.value);
                                    this.ui.queueUpdate("coins", this.state.getCoins());
                                    this.ui.queueUpdate("totalCoins", this.state.getCoins());
                                } else {
                                    this.state.addToInventory(reward);
                                    this.updateInventoryDisplay();
                                }
                                this.ui.applyUpdates();
                                setTimeout(() => {
                                    overlay.classList.remove("visible");
                                    overlay.classList.add("hidden");
                                    message.classList.remove("visible");
                                    message.classList.add("hidden");
                                    spinButton.classList.remove("visible");
                                    cancelButton.classList.remove("visible");
                                    setTimeout(() => {
                                        overlay.remove();
                                        this.state.isOverlayActive = false;
                                        rouletteStrip.style.opacity = "1";
                                    }, 500);
                                }, 2000);
                            }
                            rouletteStrip.removeEventListener("animationend", onAnimationEnd);
                        };
                        rouletteStrip.addEventListener("animationend", onAnimationEnd);
                    };
                    spinButton.addEventListener("pointerdown", startRoulette);
                }

                generateCaseReward(caseType) {
                    const isDiamondCase = caseType === "diamond-rain";
                    const isTelegramGift = caseType === "telegram-gift";
                    const background = BACKGROUND_GRADIENTS[Math.floor(Math.random() * BACKGROUND_GRADIENTS.length)];
                    if (isDiamondCase) {
                        const roll = Math.random();
                        if (roll < 0.95) {
                            const diamonds = Math.floor(Math.random() * 180) + 1;
                            return {
                                type: "diamonds",
                                name: "Diamonds",
                                value: diamonds,
                                isMutated: false,
                                background,
                                src: "https://em-content.zobj.net/source/telegram/386/gem-stone_1f48e.webp",
                            };
                        } else {
                            const characterIndex = Math.floor(Math.random() * (CHARACTERS.length - 1)) + 1;
                            const character = CHARACTERS[characterIndex];
                            const isMutated = Math.random() < 0.1;
                            return {
                                type: "character",
                                character,
                                isMutated,
                                background,
                                name: character.name,
                                src: character.src,
                            };
                        }
                    } else if (isTelegramGift) {
                        const telegramGiftItems = [
                            { type: "skin", name: "Car", src: "https://em-content.zobj.net/source/telegram/386/automobile_1f697.webp" },
                            { type: "skin", name: "Boat", src: "https://em-content.zobj.net/source/telegram/386/motor-boat_1f6e5-fe0f.webp" },
                            { type: "skin", name: "Plane", src: "https://em-content.zobj.net/source/telegram/386/airplane_2708-fe0f.webp" },
                            { type: "skin", name: "Rocket", src: "https://em-content.zobj.net/source/telegram/386/rocket_1f680.webp" },
                            { type: "skin", name: "Phone", src: "https://em-content.zobj.net/source/telegram/386/mobile-phone_1f4f1.webp" },
                        ];
                        const selectedItem = telegramGiftItems[Math.floor(Math.random() * telegramGiftItems.length)];
                        const isMutated = Math.random() < 0.1;
                        return {
                            type: "animation",
                            name: selectedItem.name,
                            src: selectedItem.src,
                            isMutated,
                            background,
                        };
                    } else {
                        const characterIndex = Math.floor(Math.random() * (CHARACTERS.length - 1)) + 1;
                        const character = CHARACTERS[characterIndex];
                        const isMutated = Math.random() < 0.1;
                        return {
                            type: "character",
                            character,
                            isMutated,
                            background,
                            name: character.name,
                            src: character.src,
                        };
                    }
                }
                handleMenuClick(e) {
                    const menuItem = e.target.closest(".menu-item");
                    if (!menuItem) return;
                    const menuType = menuItem.dataset.menu;
                    document.querySelectorAll(".menu-item").forEach((item) => item.classList.remove("highlighted"));
                    menuItem.classList.add("highlighted");
                    if (menuType === "home") {
                        this.state.setShopViewActive(false);
                        this.state.setMarketViewActive(false);
                        this.state.setLeaderboardViewActive(false);
                        if (this.ui.elements.mainContent) this.ui.elements.mainContent.classList.remove("hidden-opacity");
                        this.ui.elements.mainContent.classList.add("visible");
                        this.ui.elements.coinCounter.classList.remove("hidden");
                        this.ui.elements.coinCounter.classList.add("visible");
                        if (this.ui.elements.character) this.ui.elements.character.classList.remove("hidden-opacity");
                        this.ui.elements.character.classList.add("visible");
                        this.ui.elements.shopContainer.classList.remove("visible");
                        this.ui.elements.shopContainer.classList.add("hidden");
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.marketContainer.classList.remove("visible");
                        this.ui.elements.marketContainer.classList.add("hidden");
                        this.ui.elements.leaderboardContainer.classList.remove("visible");
                        this.ui.elements.leaderboardContainer.classList.add("hidden");
                        this.ui.elements.shopArrowLeft.classList.remove("visible");
                        this.ui.elements.shopArrowLeft.classList.add("hidden");
                        this.ui.elements.shopArrowRight.classList.remove("visible");
                        this.ui.elements.shopArrowRight.classList.add("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");
                        this.isInventoryView = false;
                        this.ui.toggleConnectButton(false);
                        this.state.canInteract = true;
                    } else if (menuType === "shop") {
                        this.state.setShopViewActive(true);
                        this.state.setMarketViewActive(false);
                        this.state.setLeaderboardViewActive(false);
                        this.ui.elements.mainContent.classList.remove("visible");
                        this.ui.elements.mainContent.classList.add("hidden-opacity");
                        this.ui.elements.coinCounter.classList.remove("hidden");
                        this.ui.elements.coinCounter.classList.add("visible");
                        this.ui.elements.character.classList.remove("visible");
                        this.ui.elements.character.classList.add("hidden-opacity");
                        this.ui.elements.shopContainer.classList.remove("hidden");
                        this.ui.elements.shopContainer.classList.add("visible");
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.marketContainer.classList.remove("visible");
                        this.ui.elements.marketContainer.classList.add("hidden");
                        this.ui.elements.leaderboardContainer.classList.remove("visible");
                        this.ui.elements.leaderboardContainer.classList.add("hidden");
                        this.ui.elements.shopArrowLeft.classList.remove("hidden");
                        this.ui.elements.shopArrowLeft.classList.add("visible");
                        this.ui.elements.shopArrowRight.classList.remove("hidden");
                        this.ui.elements.shopArrowRight.classList.add("visible");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");
                        this.isInventoryView = false;
                        this.ui.toggleConnectButton(false);
                        this.state.canInteract = false;
                    } else if (menuType === "market") {
                        this.state.setShopViewActive(false);
                        this.state.setMarketViewActive(true);
                        this.state.setLeaderboardViewActive(false);
                        this.ui.elements.mainContent.classList.remove("visible");
                        this.ui.elements.mainContent.classList.add("hidden-opacity");
                        this.ui.elements.coinCounter.classList.remove("hidden");
                        this.ui.elements.coinCounter.classList.add("visible");
                        this.ui.elements.character.classList.remove("visible");
                        this.ui.elements.character.classList.add("hidden-opacity");
                        this.ui.elements.shopContainer.classList.remove("visible");
                        this.ui.elements.shopContainer.classList.add("hidden");
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.marketContainer.classList.remove("hidden");
                        this.ui.elements.marketContainer.classList.add("visible");
                        this.ui.elements.leaderboardContainer.classList.remove("visible");
                        this.ui.elements.leaderboardContainer.classList.add("hidden");
                        this.ui.elements.shopArrowLeft.classList.remove("visible");
                        this.ui.elements.shopArrowLeft.classList.add("hidden");
                        this.ui.elements.shopArrowRight.classList.remove("visible");
                        this.ui.elements.shopArrowRight.classList.add("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");
                        this.isInventoryView = false;
                        this.ui.toggleConnectButton(!this.state.isWalletConnected());
                        this.state.canInteract = false;
                        this.updateMarketDisplay();
                    } else if (menuType === "quests") {
                        this.state.setShopViewActive(false);
                        this.state.setMarketViewActive(false);
                        this.state.setLeaderboardViewActive(false);
                        this.ui.elements.mainContent.classList.remove("visible");
                        this.ui.elements.mainContent.classList.add("hidden-opacity");
                        this.ui.elements.coinCounter.classList.remove("hidden");
                        this.ui.elements.coinCounter.classList.add("visible");
                        this.ui.elements.character.classList.remove("visible");
                        this.ui.elements.character.classList.add("hidden-opacity");
                        this.ui.elements.shopContainer.classList.remove("visible");
                        this.ui.elements.shopContainer.classList.add("hidden");
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.marketContainer.classList.remove("visible");
                        this.ui.elements.marketContainer.classList.add("hidden");
                        this.ui.elements.leaderboardContainer.classList.remove("visible");
                        this.ui.elements.leaderboardContainer.classList.add("hidden");
                        this.ui.elements.questsContainer.classList.remove("hidden");
                        this.ui.elements.questsContainer.classList.add("visible");
                        this.ui.elements.friendsContainer.classList.remove("visible");
                        this.ui.elements.friendsContainer.classList.add("hidden");
                        this.ui.elements.shopArrowLeft.classList.remove("visible");
                        this.ui.elements.shopArrowLeft.classList.add("hidden");
                        this.ui.elements.shopArrowRight.classList.remove("visible");
                        this.ui.elements.shopArrowRight.classList.add("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");
                        this.isInventoryView = false;
                        this.ui.toggleConnectButton(false);
                        this.state.canInteract = false;
                    } else if (menuType === "friends") {
                        this.state.setShopViewActive(false);
                        this.state.setMarketViewActive(false);
                        this.state.setLeaderboardViewActive(false);
                        this.ui.elements.mainContent.classList.remove("visible");
                        this.ui.elements.mainContent.classList.add("hidden-opacity");
                        this.ui.elements.coinCounter.classList.remove("hidden");
                        this.ui.elements.coinCounter.classList.add("visible");
                        this.ui.elements.character.classList.remove("visible");
                        this.ui.elements.character.classList.add("hidden-opacity");
                        this.ui.elements.shopContainer.classList.remove("visible");
                        this.ui.elements.shopContainer.classList.add("hidden");
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.marketContainer.classList.remove("visible");
                        this.ui.elements.marketContainer.classList.add("hidden");
                        this.ui.elements.leaderboardContainer.classList.remove("visible");
                        this.ui.elements.leaderboardContainer.classList.add("hidden");
                        this.ui.elements.questsContainer.classList.remove("visible");
                        this.ui.elements.questsContainer.classList.add("hidden");
                        this.ui.elements.friendsContainer.classList.remove("hidden");
                        this.ui.elements.friendsContainer.classList.add("visible");
                        this.ui.elements.shopArrowLeft.classList.remove("visible");
                        this.ui.elements.shopArrowLeft.classList.add("hidden");
                        this.ui.elements.shopArrowRight.classList.remove("visible");
                        this.ui.elements.shopArrowRight.classList.add("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");
                        this.isInventoryView = false;
                        this.ui.toggleConnectButton(false);
                        this.state.canInteract = false;
                    }
                }
                handleCaseClick(e) {
                    const caseElement = e.target.closest(".case-container");
                    if (!caseElement) return;
                    const caseType = caseElement.dataset.case;
                    this.state.isOverlayActive = true;
                    this.showCaseAnimation(caseType);
                }
                handleArrowClick(e) {
                    const arrow = e.target;
                    if (arrow.id === "shopArrowLeft" || arrow.id === "shopArrowRight") {
                        this.ui.elements.shopContainer.classList.remove("visible");
                        this.ui.elements.shopContainer.classList.add("hidden");
                        this.ui.elements.inventoryContainer.classList.remove("hidden");
                        this.ui.elements.inventoryContainer.classList.add("visible");
                        this.ui.elements.shopArrowLeft.classList.remove("visible");
                        this.ui.elements.shopArrowLeft.classList.add("hidden");
                        this.ui.elements.shopArrowRight.classList.remove("visible");
                        this.ui.elements.shopArrowRight.classList.add("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.remove("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.add("visible");
                        this.ui.elements.inventoryArrowRight.classList.remove("hidden");
                        this.ui.elements.inventoryArrowRight.classList.add("visible");
                        this.isInventoryView = true;
                        this.updateInventoryDisplay();
                    } else if (arrow.id === "inventoryArrowLeft" || arrow.id === "inventoryArrowRight") {
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.shopContainer.classList.remove("hidden");
                        this.ui.elements.shopContainer.classList.add("visible");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");
                        this.ui.elements.shopArrowLeft.classList.remove("hidden");
                        this.ui.elements.shopArrowLeft.classList.add("visible");
                        this.ui.elements.shopArrowRight.classList.remove("hidden");
                        this.ui.elements.shopArrowRight.classList.add("visible");
                        this.isInventoryView = false;
                    }
                }
                handleFilterChange() {
                    this.updateMarketDisplay();
                }
                handleTopMenuClick() {
                    if (this.state.isLeaderboardViewActive()) {
                        // Отключаем таблицу лидеров и возвращаемся на домашний экран
                        this.state.setLeaderboardViewActive(false);
                        this.state.setShopViewActive(false);
                        this.state.setMarketViewActive(false);

                        // Восстанавливаем содержимое главной страницы
                        if (this.ui.elements.mainContent) this.ui.elements.mainContent.classList.remove("hidden-opacity");
                        this.ui.elements.mainContent.classList.add("visible");
                        this.ui.elements.coinCounter.classList.remove("hidden");
                        this.ui.elements.coinCounter.classList.add("visible");
                        if (this.ui.elements.character) this.ui.elements.character.classList.remove("hidden-opacity");
                        this.ui.elements.character.classList.add("visible");

                        // Скрываем все остальные контейнеры
                        this.ui.elements.leaderboardContainer.classList.remove("visible");
                        this.ui.elements.leaderboardContainer.classList.add("hidden");
                        this.ui.elements.shopContainer.classList.remove("visible");
                        this.ui.elements.shopContainer.classList.add("hidden");
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.marketContainer.classList.remove("visible");
                        this.ui.elements.marketContainer.classList.add("hidden");

                        // Скрываем стрелки навигации
                        this.ui.elements.shopArrowLeft.classList.remove("visible");
                        this.ui.elements.shopArrowLeft.classList.add("hidden");
                        this.ui.elements.shopArrowRight.classList.remove("visible");
                        this.ui.elements.shopArrowRight.classList.add("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");

                        // Сбрасываем состояние инвентаря и включаем взаимодействие
                        this.isInventoryView = false;
                        this.ui.toggleConnectButton(false);
                        this.state.canInteract = true;

                        // Выделяем пункт "Home" в нижнем меню
                        document.querySelectorAll(".menu-item").forEach((item) => item.classList.remove("highlighted"));
                        const homeMenuItem = document.querySelector('.menu-item[data-menu="home"]');
                        if (homeMenuItem) {
                            homeMenuItem.classList.add("highlighted");
                        }
                    } else {
                        // Показываем таблицу лидеров (оставляем без изменений)
                        this.state.setShopViewActive(false);
                        this.state.setMarketViewActive(false);
                        this.state.setLeaderboardViewActive(true);
                        this.ui.elements.mainContent.classList.remove("visible");
                        this.ui.elements.mainContent.classList.add("hidden-opacity");
                        this.ui.elements.character.classList.remove("visible");
                        this.ui.elements.character.classList.add("hidden-opacity");
                        this.ui.elements.shopContainer.classList.remove("visible");
                        this.ui.elements.shopContainer.classList.add("hidden");
                        this.ui.elements.inventoryContainer.classList.remove("visible");
                        this.ui.elements.inventoryContainer.classList.add("hidden");
                        this.ui.elements.marketContainer.classList.remove("visible");
                        this.ui.elements.marketContainer.classList.add("hidden");
                        this.ui.elements.leaderboardContainer.classList.remove("hidden");
                        this.ui.elements.leaderboardContainer.classList.add("visible");
                        this.ui.elements.shopArrowLeft.classList.remove("visible");
                        this.ui.elements.shopArrowLeft.classList.add("hidden");
                        this.ui.elements.shopArrowRight.classList.remove("visible");
                        this.ui.elements.shopArrowRight.classList.add("hidden");
                        this.ui.elements.inventoryArrowLeft.classList.remove("visible");
                        this.ui.elements.inventoryArrowLeft.classList.add("hidden");
                        this.ui.elements.inventoryArrowRight.classList.remove("visible");
                        this.ui.elements.inventoryArrowRight.classList.add("hidden");
                        this.isInventoryView = false;
                        this.ui.toggleConnectButton(false);
                        this.state.canInteract = false;
                        this.updateLeaderboardDisplay();
                    }
                }
                attachEventListeners() {
                    const menuClickListener = this.handleMenuClick.bind(this);
                    this.ui.elements.footer.addEventListener("pointerdown", menuClickListener);
                    this.listeners.push({ element: this.ui.elements.footer, type: "pointerdown", listener: menuClickListener });
                    const caseClickListener = this.handleCaseClick.bind(this);
                    this.ui.elements.shopContainer.addEventListener("pointerdown", caseClickListener);
                    this.listeners.push({ element: this.ui.elements.shopContainer, type: "pointerdown", listener: caseClickListener });
                    const arrowClickListener = this.handleArrowClick.bind(this);
                    this.ui.elements.shopArrowLeft.addEventListener("pointerdown", arrowClickListener);
                    this.ui.elements.shopArrowRight.addEventListener("pointerdown", arrowClickListener);
                    this.ui.elements.inventoryArrowLeft.addEventListener("pointerdown", arrowClickListener);
                    this.ui.elements.inventoryArrowRight.addEventListener("pointerdown", arrowClickListener);
                    this.listeners.push({ element: this.ui.elements.shopArrowLeft, type: "pointerdown", listener: arrowClickListener });
                    this.listeners.push({ element: this.ui.elements.shopArrowRight, type: "pointerdown", listener: arrowClickListener });
                    this.listeners.push({ element: this.ui.elements.inventoryArrowLeft, type: "pointerdown", listener: arrowClickListener });
                    this.listeners.push({ element: this.ui.elements.inventoryArrowRight, type: "pointerdown", listener: arrowClickListener });
                    const filterChangeListener = this.handleFilterChange.bind(this);
                    this.ui.elements.characterFilter.addEventListener("change", filterChangeListener);
                    this.ui.elements.backgroundFilter.addEventListener("change", filterChangeListener);
                    this.ui.elements.priceSort.addEventListener("change", filterChangeListener);
                    this.listeners.push({ element: this.ui.elements.characterFilter, type: "change", listener: filterChangeListener });
                    this.listeners.push({ element: this.ui.elements.backgroundFilter, type: "change", listener: filterChangeListener });
                    this.listeners.push({ element: this.ui.elements.priceSort, type: "change", listener: filterChangeListener });
                    const topMenuClickListener = this.handleTopMenuClick.bind(this);
                    this.ui.elements.topMenu.addEventListener("pointerdown", topMenuClickListener);
                    this.listeners.push({ element: this.ui.elements.topMenu, type: "pointerdown", listener: topMenuClickListener });
                    const resizeListener = () => {
                        if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
                        this.resizeTimeout = setTimeout(() => {
                            this.particleSystem.resize();
                            this.confettiSystem.resize();
                            this.ui.updateCoinCounterPosition();
                        }, CONFIG.RESIZE_DEBOUNCE);
                    };
                    window.addEventListener("resize", resizeListener);
                    this.listeners.push({ element: window, type: "resize", listener: resizeListener });
                }
                initialize() {
                    this.ui.updateCoinCounterPosition();
                    this.particleSystem.resize();
                    this.confettiSystem.resize();
                    this.attachEventListeners();
                    this.initializeMarketFilters();
                    this.updateLeaderboardDisplay();
                    // Initialize inventory with Controller
                    this.state.addToInventory({
                        src: "https://em-content.zobj.net/source/telegram/386/video-game_1f3ae.webp",
                        name: "Controller",
                        background: SKINS[0].gradient,
                        isMutated: false,
                    });
                    this.updateInventoryDisplay();
                    this.preloadAssets();
                }
                destroy() {
                    this.listeners.forEach(({ element, type, listener }) => element.removeEventListener(type, listener));
                    this.characterController.destroy();
                    this.particleSystem.stop();
                    this.confettiSystem.stop();
                    if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
                }
            }
            document.addEventListener("DOMContentLoaded", () => {
                const elements = {
                    loadingScreen: document.getElementById("loadingScreen"),
                    loadingPercent: document.getElementById("loadingPercent"),
                    topMenu: document.getElementById("topMenu"),
                    particleCanvas: document.getElementById("particleCanvas"),
                    confettiCanvas: document.getElementById("confettiCanvas"),
                    mainContent: document.getElementById("mainContent"),
                    incomeCounter: document.getElementById("incomeCounter"),
                    incomeRate: document.getElementById("incomeRate"),
                    incomeTimer: document.getElementById("incomeTimer"),
                    timerDisplay: document.getElementById("timerDisplay"),
                    coinCounter: document.getElementById("coinCounter"),
                    coinCount: document.getElementById("coinCount"),
                    character: document.getElementById("character"),
                    footer: document.getElementById("footer"),
                    shopContainer: document.getElementById("shopContainer"),
                    inventoryContainer: document.getElementById("inventoryContainer"),
                    inventoryItems: document.getElementById("inventoryItems"),
                    marketContainer: document.getElementById("marketContainer"),
                    marketItems: document.getElementById("marketItems"),
                    leaderboardContainer: document.getElementById("leaderboardContainer"),
                    leaderboardTable: document.getElementById("leaderboardTable"),
                    shopArrowLeft: document.getElementById("shopArrowLeft"),
                    shopArrowRight: document.getElementById("shopArrowRight"),
                    inventoryArrowLeft: document.getElementById("inventoryArrowLeft"),
                    inventoryArrowRight: document.getElementById("inventoryArrowRight"),
                    tonConnect: document.getElementById("ton-connect"),
                    disconnectWallet: document.getElementById("disconnect-wallet"),
                    totalCoins: document.getElementById("totalCoins"),
                    playerStats: document.querySelector(".player-stats"),
                    characterFilter: document.getElementById("characterFilter"),
                    backgroundFilter: document.getElementById("backgroundFilter"),
                    priceSort: document.getElementById("priceSort"),
                };
                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.ready();
                    document.body.dataset.telegram = "true";
                }
                const game = new Game(elements);
                game.initialize();
                window.addEventListener("beforeunload", () => game.destroy());
            });
</script>
<script>
            document.addEventListener("DOMContentLoaded", function () {
                const menuItems = document.querySelectorAll(".menu-item");
                const sections = {
                    home: document.getElementById("mainContent"),
                    shop: document.getElementById("shopContainer"),
                    market: document.getElementById("marketContainer"),
                    quests: document.getElementById("questsContainer"),
                    friends: document.getElementById("friendsContainer"),
                };
                const coinCounter = document.getElementById("coinCounter");
                const incomeCounter = document.getElementById("incomeCounter");
                const incomeTimer = document.getElementById("incomeTimer");

                menuItems.forEach((item) => {
                    item.addEventListener("click", () => {
                        const selected = item.getAttribute("data-menu");

                        for (let key in sections) {
                            if (sections[key]) {
                                sections[key].classList.remove("visible");
                                sections[key].classList.add("hidden");
                            }
                        }

                        // Show selected section
                        if (sections[selected]) {
                            sections[selected].classList.remove("hidden");
                            sections[selected].classList.add("visible");
                        }

                        // Toggle visibility of home-only elements

                        const isHome = selected === "home";
                        const topMenu = document.querySelector(".top-menu");
                        if (isHome) {
                            topMenu.style.display = "flex";
                        } else {
                            topMenu.style.display = "none";
                        }

                        [coinCounter, incomeCounter, incomeTimer].forEach((el) => {
                            if (!el) return;
                            if (isHome) {
                                el.classList.add("visible");
                                el.classList.remove("hidden");
                            } else {
                                el.classList.remove("visible");
                                el.classList.add("hidden");
                            }
                        });
                    });
                });
            });
</script>
<script>
            const mainContent = document.getElementById("mainContent");
            const incomeCounter = document.getElementById("incomeCounter");
            const incomeTimer = document.getElementById("incomeTimer");
            const coinCounter = document.getElementById("coinCounter");
            const shopContainer = document.getElementById("shopContainer");
            const inventoryContainer = document.getElementById("inventoryContainer");
            const marketContainer = document.getElementById("marketContainer");
            const leaderboardContainer = document.getElementById("leaderboardContainer");
            const questsContainer = document.getElementById("questsContainer");
            const friendsContainer = document.getElementById("friendsContainer");

            function hideAllSections() {
                shopContainer.classList.add("hidden");
                inventoryContainer.classList.add("hidden");
                marketContainer.classList.add("hidden");
                leaderboardContainer.classList.add("hidden");
                questsContainer.classList.add("hidden");
                friendsContainer.classList.add("hidden");
                mainContent.style.display = "none";
                incomeCounter.style.display = "none";
                incomeTimer.style.display = "none";
                coinCounter.style.display = "none";
            }
            function showHome() {
                hideAllSections();
                mainContent.style.display = "flex";
                incomeCounter.style.display = "flex";
                incomeTimer.style.display = "flex";
                coinCounter.style.display = "flex";
            }
            document.querySelectorAll(".menu-item").forEach((item) => {
                item.addEventListener("click", () => {
                    const menu = item.getAttribute("data-menu");
                    if (menu === "home") {
                        showHome();
                    } else {
                        hideAllSections();
                        if (menu === "shop") shopContainer.classList.remove("hidden");
                        if (menu === "market") marketContainer.classList.remove("hidden");
                        if (menu === "quests") questsContainer.classList.remove("hidden");
                        if (menu === "friends") friendsContainer.classList.remove("hidden");
                        if (menu === "leaderboard") leaderboardContainer.classList.remove("hidden");
                    }
                    document.querySelectorAll(".menu-item").forEach((i) => i.classList.remove("highlighted"));
                    item.classList.add("highlighted");
                });
            });
</script>
<div id="donationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center;">
<div style="background: #1e1e1e; padding: 2rem; border-radius: 16px; text-align: center; color: white; width: 90%; max-width: 400px;">
<h2 style="margin-bottom: 1rem;">Support the Game</h2>
<button style="margin: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: 12px; background: #14b8a6; color: white; font-weight: bold;">Donate with TON</button>
<button style="margin: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: 12px; background: #7289da; color: white; font-weight: bold;">Donate with Telegram Stars</button>
<button style="margin: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: 12px; background: #f97316; color: white; font-weight: bold;">Donate with Card (₽)</button>
<div style="margin-top: 1rem;">
<button onclick="document.getElementById('donationModal').style.display='none';" style="background: none; border: none; color: gray; font-size: 0.9rem;">Close</button>
</div>
</div>
</div>
<script>
            document.getElementById("starDonation").addEventListener("click", function () {
                document.getElementById("donationModal").style.display = "flex";
            });
</script>
<script>
        document.addEventListener("DOMContentLoaded", () => {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();

            document.getElementById("buyDiamonds").addEventListener("click", async () => {
                const chatId = window.Telegram.WebApp.initDataUnsafe.user?.id || 0;
                const response = await fetch("http://localhost:8000/create-invoice", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        product: "100 Diamonds",
                        amount: 100,
                        chat_id: chatId
                    })
                });
                const { invoiceLink } = await response.json();
                window.Telegram.WebApp.openInvoice(invoiceLink, (status) => {
                    if (status === "paid") {
                        updateDiamonds(100);
                        window.Telegram.WebApp.showAlert("Thank you! You've received 100 Diamonds!");
                    } else if (status === "cancelled") {
                        window.Telegram.WebApp.showAlert("Payment cancelled.");
                    }
                });
            });

            function updateDiamonds(amount) {
                let currentDiamonds = parseInt(localStorage.getItem("diamonds") || "8000");
                currentDiamonds += amount;
                localStorage.setItem("diamonds", currentDiamonds);
                document.getElementById("diamondsDisplay").textContent = currentDiamonds;
            }
        });
</script>
<!-- Reward Animation Container -->
<div id="rewardAnimationContainer" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; width: 200px; height: 200px; display: none; pointer-events: none;">
<div id="rewardAnimation" style="width: 100%; height: 100%;"></div>
</div>
<script>
            function showRewardAnimation(animationPath) {
                const container = document.getElementById("rewardAnimationContainer");
                const animEl = document.getElementById("rewardAnimation");

                container.style.display = "block";
                animEl.innerHTML = "";

                setTimeout(() => {
                    container.style.display = "none";
                    animEl.innerHTML = "";
                }, 3000);
            }

            function openTelegramGiftCase() {
                const animations = ["images/cookie.json", "images/bottle.json", "images/clock.json", "images/heart.json", "images/rocket.json"];
                const randomPath = animations[Math.floor(Math.random() * animations.length)];
                showRewardAnimation(randomPath);
            }
</script>
<script>
            let walletConnected = false;

            function toggleWallet() {
                const btn = document.getElementById("connectWalletBtn");
                if (!walletConnected) {
                    connectWallet(); // ваша функция подключения
                    btn.textContent = "Disconnect Wallet";
                    walletConnected = true;
                } else {
                    disconnectWallet(); // функция отключения
                    btn.textContent = "Connect Wallet";
                    walletConnected = false;
                }
            }

            // Заглушка: замените на настоящую реализацию
            function connectWallet() {
                console.log("Wallet connected");
            }
            function disconnectWallet() {
                console.log("Wallet disconnected");
            }
</script>
<script>
            function activateX4() {
                alert("x4 boost upgrade coming soon!");
            }
</script>
<script>
            function showSection(section) {
                document.querySelectorAll(".section").forEach((s) => s.classList.add("hidden"));
                document.getElementById(section + "Container")?.classList.remove("hidden");

                // Скрытие стрелок по умолчанию
                document.querySelectorAll(".inventory-arrow").forEach((el) => (el.style.display = "none"));

                // Отображение стрелок только в inventory
                if (section === "inventory") {
                    document.querySelectorAll(".inventory-arrow").forEach((el) => (el.style.display = "block"));
                }
            }
</script>
<script>
            function showSection(section) {
                document.querySelectorAll(".section").forEach((s) => s.classList.add("hidden"));
                document.getElementById(section + "Container")?.classList.remove("hidden");

                // Скрытие стрелок
                document.querySelectorAll(".inventory-arrow").forEach((el) => (el.style.display = "none"));

                // Показывать стрелки только в инвентаре
                if (section === "inventory") {
                    document.querySelectorAll(".inventory-arrow").forEach((el) => (el.style.display = "block"));
                }
            }

            function activateX4() {
                alert("x4 boost feature coming soon!");
            }
</script>
<script>
            let openCasesCount = 0;
            function incrementCaseCount() {
                openCasesCount++;
                if (openCasesCount >= 3) {
                    openCasesCount = 0;
                }
            }
            document.querySelectorAll(".case-container").forEach((caseElement) => {
                caseElement.addEventListener("click", incrementCaseCount);
            });

            function showUpgradeMessage() {
                const msg = document.createElement("div");
                msg.textContent = "Улучшение куплено";
                msg.style.position = "fixed";
                msg.style.top = "20%";
                msg.style.left = "50%";
                msg.style.transform = "translate(-50%, -50%)";
                msg.style.backgroundColor = "#000";
                msg.style.color = "#fff";
                msg.style.padding = "1rem";
                msg.style.borderRadius = "12px";
                msg.style.zIndex = 9999;
                document.body.appendChild(msg);
            }
</script>
<script>
            let clicks = 0;
            let telegramVisited = false;
            let stars = 0;
            let leaderboardTop10 = true; // Simplified check
            let diamondGoalReached = false;

            document.getElementById("character").addEventListener("click", () => {
                clicks++;
                updateQuestButtons();
            });

            document.querySelector("a[href*='t.me']").addEventListener("click", () => {
                telegramVisited = true;
                updateQuestButtons();
            });

            function updateQuestButtons() {
                const buttons = document.querySelectorAll(".claim-button");
                if (telegramVisited) buttons[0].disabled = false;
                if (clicks >= 50) buttons[1].disabled = false;
                if (stars >= 100) buttons[2].disabled = false;
                if (leaderboardTop10) buttons[3].disabled = false;
                const coinCount = parseInt(document.getElementById("coinCount").textContent);
                if (coinCount >= 3000) {
                    diamondGoalReached = true;
                    buttons[4].disabled = false;
                }
            }

            document.querySelectorAll(".claim-button").forEach((btn, i) => {
                btn.disabled = true;
                btn.addEventListener("click", () => {
                    if (btn.disabled) return;
                    let reward = [50, 150, 200, 500, 100][i];
                    let coinsEl = document.getElementById("coinCount");
                    let totalCoinsEl = document.getElementById("totalCoins");
                    let current = parseInt(coinsEl.textContent);
                    current += reward;
                    coinsEl.textContent = totalCoinsEl.textContent = current;
                    btn.disabled = true;
                    btn.textContent = "Claimed";
                    showNotification("Награда получена");
                });
            });

            function showNotification(message) {
                const msg = document.createElement("div");
                msg.textContent = message;
                msg.style.position = "fixed";
                msg.style.top = "20%";
                msg.style.left = "50%";
                msg.style.transform = "translate(-50%, -50%)";
                msg.style.backgroundColor = "#000";
                msg.style.color = "#fff";
                msg.style.padding = "1rem";
                msg.style.borderRadius = "12px";
                msg.style.zIndex = 9999;
                document.body.appendChild(msg);
            }
</script>
<script>
            document.addEventListener("DOMContentLoaded", () => {
                let clicks = 0;
                let telegramVisited = false;
                let stars = 0;
                let leaderboardTop10 = true;
                let diamondGoalReached = false;

                const buttons = document.querySelectorAll(".claim-button");
                const gemCountEl = document.getElementById("coinCount");

                document.getElementById("character").addEventListener("click", () => {
                    clicks++;
                    updateQuests();
                });

                document.querySelector("a[href*='t.me']").addEventListener("click", () => {
                    telegramVisited = true;
                    updateQuests();
                });

                function updateQuests() {
                    if (telegramVisited) enableClaim(0);
                    if (clicks >= 50) enableClaim(1);
                    if (stars >= 100) enableClaim(2);
                    if (leaderboardTop10) enableClaim(3);
                    const gems = parseInt(gemCountEl.textContent);
                    if (gems >= 3000) enableClaim(4);
                }

                function enableClaim(index) {
                    const btn = buttons[index];
                    btn.disabled = false;
                    btn.classList.add("pulse");
                }

                buttons.forEach((btn, i) => {
                    btn.disabled = true;
                    btn.addEventListener("click", () => {
                        if (btn.disabled) return;
                        const rewards = [50, 150, 200, 500, 100];
                        let current = parseInt(gemCountEl.textContent);
                        gemCountEl.textContent = current + rewards[i];
                        btn.disabled = true;
                        btn.textContent = "Claimed";
                        btn.classList.remove("pulse");
                        showNotification("Награда получена");
                    });
                });

                function showNotification(message) {
                    const msg = document.createElement("div");
                    msg.textContent = message;
                    msg.style.position = "fixed";
                    msg.style.top = "20%";
                    msg.style.left = "50%";
                    msg.style.transform = "translate(-50%, -50%)";
                    msg.style.backgroundColor = "#000";
                    msg.style.color = "#fff";
                    msg.style.padding = "1rem";
                    msg.style.borderRadius = "12px";
                    msg.style.zIndex = 9999;
                    document.body.appendChild(msg);
                }
            });
</script>
<div class="quests-arrow left" id="newQuestsArrowLeft">&lt;</div>
<div class="quests-arrow right" id="newQuestsArrowRight">&gt;</div>
<script>
  const newQuestsArrowLeft = document.getElementById('newQuestsArrowLeft');
  const newQuestsArrowRight = document.getElementById('newQuestsArrowRight');

  document.querySelectorAll(".menu-item").forEach(item => {
    item.addEventListener("click", () => {
      const menu = item.getAttribute("data-menu");
      const isQuests = menu === "quests";

      if (newQuestsArrowLeft && newQuestsArrowRight) {
        newQuestsArrowLeft.style.display = isQuests ? "block" : "none";
        newQuestsArrowRight.style.display = isQuests ? "block" : "none";
      }
    });
  });
</script>
<script>
  let showingFriends = false;

  function toggleQuestsAndFriends() {
    const quests = document.getElementById("questsContainer");
    const friends = document.getElementById("friendsContainer");

    if (!quests || !friends) return;

    if (showingFriends) {
      // показать квесты
      quests.classList.remove("hidden");
      quests.classList.add("visible");
      friends.classList.add("hidden");
      friends.classList.remove("visible");
    } else {
      // показать друзей
      friends.classList.remove("hidden");
      friends.classList.add("visible");
      quests.classList.add("hidden");
      quests.classList.remove("visible");
    }

    showingFriends = !showingFriends;
  }

  document.getElementById("newQuestsArrowLeft").addEventListener("click", toggleQuestsAndFriends);
  document.getElementById("newQuestsArrowRight").addEventListener("click", toggleQuestsAndFriends);
</script>
<script>
  document.querySelectorAll(".menu-item").forEach(item => {
    item.addEventListener("click", () => {
      const menu = item.getAttribute("data-menu");
      document.querySelectorAll(".leaderboard-container").forEach(container => {
        container.classList.add("hidden");
        container.classList.remove("visible");
      });
      const active = document.getElementById(menu + "Container");
      if (active) {
        active.classList.remove("hidden");
        active.classList.add("visible");
      }
    });
  });
</script>
<!-- Мини-игра "Лови звезды" -->
<style>
  #catchGame {
    position: fixed;
    inset: 0;
    background: black;
    z-index: 10000;
    display: none;
    overflow: hidden;
  }
  #rocket {
    position: absolute;
    bottom: 20px;
    width: 80px;
    height: auto;
    transition: left 0.1s linear;
  }
  .star {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 0;
  }
  #score {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.5rem;
    color: white;
  }
  #quitCatchGame {
    position: absolute;
    top: 10px;
    right: 10px;
    background: transparent;
    color: white;
    font-size: 1.5rem;
    border: none;
    cursor: pointer;
  }
  .minigame-button {
  background: linear-gradient(135deg, #4facfe, #00f2fe); /* градиент */
  border: none;
  color: white;
  font-size: 1.2rem;
  font-weight: bold;
  padding: 12px 24px;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  transition: transform 0.1s ease, box-shadow 0.2s ease;
}
</style>
<div id="catchGame">
<canvas id="minigameStarfield"></canvas>
<div id="score">Score: 0</div>
<button id="quitCatchGame">✕ Quit</button>
<img alt="Rocket" id="rocket" src="https://clipart-library.com/images/Bcgje7dc8.png"/>
</div>
<script>
  const catchGame = document.getElementById('catchGame');
  const rocket = document.getElementById('rocket');
  const scoreDisplay = document.getElementById('score');
  const quitBtn = document.getElementById('quitCatchGame');

let globalSpeed = 4;
let spawnRate = 1000;
let spawnRateDecrement = 50;
let minSpawnRate = 300;

  let score = 0;
  let gameRunning = false;
  let starInterval;

  function startCatchGame() {
  globalSpeed = 4;
  spawnRate = 1200;
    score = 0;
    scoreDisplay.textContent = 'Score: 0';
    rocket.style.left = '50%';
    catchGame.style.display = 'block';
    gameRunning = true;
  resizeStarCanvas();
  animateStarBackground();
    spawnStars();
  }

  function endCatchGame() {
    gameRunning = false;
    catchGame.style.display = 'none';
    alert('Game Over! Your score: ' + score);
    document.querySelectorAll('.star').forEach(s => s.remove());
    clearInterval(starInterval);
  }

  quitBtn.onclick = endCatchGame;


catchGame.addEventListener('touchmove', e => {
    const touch = e.touches[0];
    let x = touch.clientX - 40;
    x = Math.max(0, Math.min(window.innerWidth - 80, x));
    rocket.style.left = x + 'px';
  });

function spawnStars() {
  function spawnLoop() {
    if (!gameRunning) return;

    const star = document.createElement('img');
    star.src = 'https://i.pinimg.com/originals/3c/48/d3/3c48d3b9c636f8182f9f18c51eb70117.png';
    star.classList.add('star');
    star.style.left = Math.random() * (window.innerWidth - 40) + 'px';
    star.style.top = '0px';
    catchGame.appendChild(star);

    let speed = Math.min(globalSpeed += 0.05, 25); // увеличиваем скорость
    let startTime = null;

    function animateStar(timestamp) {
      if (!startTime) startTime = timestamp;
      const elapsed = timestamp - startTime;
      const top = elapsed * speed / 16;
      star.style.top = top + 'px';

      const rocketRect = rocket.getBoundingClientRect();
      const starRect = star.getBoundingClientRect();

      if (
        rocketRect.left < starRect.right &&
        rocketRect.right > starRect.left &&
        rocketRect.top < starRect.bottom &&
        rocketRect.bottom > starRect.top
      ) {
        score++;
        scoreDisplay.textContent = 'Score: ' + score;
        star.remove();
        return;
      }

      if (top > window.innerHeight - 40) {
        star.remove();
        endCatchGame();
        return;
      }

      if (gameRunning) requestAnimationFrame(animateStar);
    }
    requestAnimationFrame(animateStar);

    // Уменьшаем интервал и запускаем следующий спавн
    if (spawnRate > minSpawnRate) {
      spawnRate -= spawnRateDecrement;
    }

    setTimeout(spawnLoop, spawnRate);
  }

  spawnLoop();
}

</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const playBtn = document.getElementById("earnCoinsPlayBtn");
  if (playBtn) {
    playBtn.removeAttribute("disabled");
    playBtn.addEventListener("click", startCatchGame);
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const playBtn = document.getElementById("earnCoinsPlayBtn");
  if (playBtn) {
    playBtn.addEventListener("click", startCatchGame);
  }
});
</script>
<script>
const starCanvas = document.getElementById('minigameStarfield');
const starCtx = starCanvas.getContext('2d');
let starArray = [];

function resizeStarCanvas() {
  starCanvas.width = catchGame.offsetWidth;
  starCanvas.height = catchGame.offsetHeight;
  starArray = Array.from({ length: 100 }, () => ({
    x: Math.random() * starCanvas.width,
    y: Math.random() * starCanvas.height,
    size: Math.random() * 2,
    speed: Math.random() * 0.4 + 0.2
  }));
}

function animateStarBackground() {
  if (!gameRunning) return;
  starCtx.clearRect(0, 0, starCanvas.width, starCanvas.height);
  starCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
  starArray.forEach(star => {
    starCtx.beginPath();
    starCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
    starCtx.fill();
    star.y += star.speed;
    if (star.y > starCanvas.height) {
      star.y = 0;
      star.x = Math.random() * starCanvas.width;
    }
  });
  requestAnimationFrame(animateStarBackground);
}

window.addEventListener('resize', () => {
  if (gameRunning) resizeStarCanvas();
});

const originalStartCatchGame = startCatchGame;
startCatchGame = function() {
  resizeStarCanvas();
  animateStarBackground();
  originalStartCatchGame();
};
</script>
<!-- Мини-игра "Торт" -->
<div id="cakeGame" style="position: fixed; inset: 0; background: linear-gradient(to top, #aee4ff, white); display: none; z-index: 10000;">
<button id="quitCakeGame" style="position: absolute; top: 10px; right: 10px; background: transparent; color: black; font-size: 1.5rem; border: none; cursor: pointer;">✕ Quit</button>
<div id="game" style="position: relative; width: 100vw; height: 100vh;">
<div id="score2" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-family: sans-serif; font-size: 1.2rem;">Score: 0

</div>
</div>
</div>
<style>
  .block {
    position: absolute;
    height: 30px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: opacity 0.3s ease-in;
  }
  .cake1 {
    background: linear-gradient(to top, #f7c59f, #fcd5ce);
    border: 2px solid #d58a7b;
  }
  .cake2 {
    background: linear-gradient(to top, #ffc0cb, #ffe0eb);
    border: 2px solid #cc6688;
  }
  .cake3 {
    background: linear-gradient(to top, #ffffff, #f2f2f2);
    border: 2px solid #ccc;
  }
  .cake4 {
    background: linear-gradient(to top, #ffccdd, #ffe6f0);
    border: 2px solid #e892a2;
  }
  .cake5 {
    background: linear-gradient(to top, #ffffff, #f9f9f9);
    border: 2px solid #cccccc;
  }
</style>
<script>
  let stack = [];
  let currentBlock = null;
  let direction = 1;
  let score2 = 0;
  let movingAnimation = null;

  const game = document.getElementById("game");
  let scoreDisplay2 = document.getElementById("score2");

  function startCakeGame() {
    stack = [];
    score2 = 0;
    game.innerHTML = '<div id="score2" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); font-family: sans-serif; font-size: 1.2rem;">Score: 0</div>';
    scoreDisplay2 = document.getElementById("score2");
    createBaseBlock();
    createMovingBlock();
  }

  function createBaseBlock() {
    const base = document.createElement("div");
    base.className = "block cake2";
    base.style.width = "150px";
    base.style.left = "calc(50% - 75px)";
    base.style.bottom = "0px";
    game.appendChild(base);
    stack.push({ left: window.innerWidth / 2 - 75, width: 150, bottom: 0 });
  }

  function createMovingBlock() {
    const last = stack[stack.length - 1];
    const newWidth = last.width;
    const block = document.createElement("div");
    const colorList = ['cake1', 'cake2', 'cake3', 'cake4', 'cake5'];
    block.className = "block " + colorList[Math.floor(Math.random() * colorList.length)];
    const dir = Math.random() < 0.5 ? 1 : -1;
    block.style.left = dir === 1 ? "-100px" : window.innerWidth + "px";
    block.style.width = newWidth + "px";
    block.style.bottom = last.bottom + 30 + "px";
    game.appendChild(block);

    currentBlock = {
      el: block,
      width: newWidth,
      bottom: last.bottom + 30,
      x: dir === 1 ? -100 : window.innerWidth,
      speed: dir === 1
        ? (score2 >= 10 ? (Math.random() * 1.5 + 2.8) : (Math.random() * 0.8 + 1.8))
        : -(score2 >= 10 ? (Math.random() * 1.5 + 2.8) : (Math.random() * 0.8 + 1.8))
    };

    cancelAnimationFrame(movingAnimation);
    moveBlock();
  }

  function moveBlock() {
    if (!currentBlock) return;
    currentBlock.x += currentBlock.speed;
    currentBlock.el.style.left = currentBlock.x + "px";

    if (
      (currentBlock.speed > 0 && currentBlock.x > window.innerWidth) ||
      (currentBlock.speed < 0 && currentBlock.x + currentBlock.width < 0)
    ) {

alert("Game Over! Final Score: " + score2);

const cakeGameEl = document.getElementById("cakeGame");
if (cakeGameEl) {
  cakeGameEl.style.display = "none";
}


      currentBlock = null;
      cancelAnimationFrame(movingAnimation);
      return;
    }

    movingAnimation = requestAnimationFrame(moveBlock);
  }

  function placeBlock() {
    if (!currentBlock) return;

    const last = stack[stack.length - 1];
    const overlapLeft = Math.max(currentBlock.x, last.left);
    const overlapRight = Math.min(currentBlock.x + currentBlock.width, last.left + last.width);
    const overlapWidth = overlapRight - overlapLeft;

    if (overlapWidth <= 0) {

alert("Game Over! Final Score: " + score2);

const cakeGameEl = document.getElementById("cakeGame");
if (cakeGameEl) {
  cakeGameEl.style.display = "none";
}


      currentBlock = null;
      return;
    }

    currentBlock.el.style.left = overlapLeft + "px";
    currentBlock.el.style.width = overlapWidth + "px";
    stack.push({ left: overlapLeft, width: overlapWidth, bottom: currentBlock.bottom });
    currentBlock = null;
    direction *= -1;
    score2++;
    scoreDisplay2.textContent = "Score: " + score2;
    createMovingBlock();
  }

  document.addEventListener("DOMContentLoaded", function () {
    const tortBtn = document.getElementById("tortGamePlayBtn");
    const cakeGame = document.getElementById("cakeGame");
    const quitBtn = document.getElementById("quitCakeGame");

    if (tortBtn && cakeGame) {
      tortBtn.removeAttribute("disabled");
      tortBtn.addEventListener("click", function () {
        cakeGame.style.display = "block";
        startCakeGame();
      });
    }

    if (quitBtn) {
      quitBtn.addEventListener("click", function () {
        cakeGame.style.display = "none";
        cancelAnimationFrame(movingAnimation);
      });
    }

    cakeGame.addEventListener("click", placeBlock);
  });


const tortGameBtn = document.getElementById('tortGamePlayBtn');
const tortGameContainer = document.getElementById('tortGameContainer');
const tortExitBtn = document.getElementById('tortExitBtn');
const tortExitPrompt = document.getElementById('tortExitPrompt');
const confirmExitBtn = document.getElementById('confirmExitBtn');

let tortGameInterval = null;

tortGameBtn?.addEventListener('click', () => {

const tortGameContainer = document.getElementById("tortGameContainer");
if (tortGameContainer) {
  tortGameContainer.style.display = 'flex';
}


setTimeout(() => {
  const container = document.getElementById("tortGameContainer");
  if (container) {
    container.classList.remove("hidden-opacity");
  }
}, 10);


    tortGameInterval = setInterval(() => {
        console.log('Игра TORT работает...');
    }, 1000);
});

tortExitBtn?.addEventListener('click', () => {
    clearInterval(tortGameInterval);
    tortExitPrompt.style.display = 'block';
    setTimeout(() => tortExitPrompt.classList.remove('hidden-opacity'), 10);
});

confirmExitBtn?.addEventListener('click', () => {
    tortExitPrompt.classList.add('hidden-opacity');
    setTimeout(() => {
        tortExitPrompt.style.display = 'none';
    }, 500);

    tortGameContainer.classList.add('hidden-opacity');
    setTimeout(() => {
        tortGameContainer.style.display = 'none';
    }, 500);
});
</script>
<!-- Мини-игра "Гонки" -->
<div id="raceGame" style="
  position: fixed;
  inset: 0;
  background: linear-gradient(to bottom right, #1a1a1a, #333333);
  display: none;
  z-index: 10000;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  color: white;
  font-family: sans-serif;
  overflow-y: auto;
">
<button id="quitRaceGame" style="
    position: absolute;
    top: 15px;
    right: 20px;
    background: transparent;
    color: white;
    font-size: 2rem;
    border: none;
    cursor: pointer;
  ">✕</button>
<h1 style="margin-top: 60px; font-size: 6vw; text-align: center;">Choose who wins</h1>
<div class="race-container" style="display: flex; flex-direction: column; align-items: center; margin-top: 30px; width: 100%;">
<div class="track" id="track1" style="
      width: 90vw;
      max-width: 600px;
      height: 60px;
      background: #444;
      margin: 15px 0;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
    ">
<img class="vehicle" id="v1" src="" style="
        position: absolute;
        top: 5px;
        left: 0;
        height: 45px;
        transform: translateX(0px);
      "/>
</div>
<div class="track" id="track2" style="
      width: 90vw;
      max-width: 600px;
      height: 60px;
      background: #444;
      margin: 15px 0;
      position: relative;
      border-radius: 12px;
      overflow: hidden;
    ">
<img class="vehicle" id="v2" src="" style="
        position: absolute;
        top: 5px;
        left: 0;
        height: 45px;
        transform: translateX(0px);
      "/>
</div>
</div>
<div class="buttons" style="
    margin-top: 30px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    width: 100%;
  ">
<button id="choose1" style="
      padding: 14px 24px;
      font-size: 5vw;
      max-width: 300px;
      background: linear-gradient(to right, #00c6ff, #0072ff);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      flex: 1;
    ">...</button>
<button id="choose2" style="
      padding: 14px 24px;
      font-size: 5vw;
      max-width: 300px;
      background: linear-gradient(to right, #ff8c00, #ff3c00);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      flex: 1;
    ">...</button>
</div>
<div id="raceResult" style="
    margin-top: 30px;
    font-size: 5vw;
    font-weight: bold;
    text-align: center;
    text-shadow: 1px 1px 2px black;
  "></div>
</div>
<script>
  const vehicles = [
    "https://freepngimg.com/thumb/bmw/22658-4-bmw-m3-photos.png",
    "https://img2.clipart-library.com/27/picture-of-airplane-clipart/picture-of-airplane-clipart-20.png",
    "https://www.pngmart.com/files/23/Sailboat-PNG-Pic.png",
    "https://clipart-library.com/2023/15153-illustration-of-an-army-tank-pv.png",
    "https://i2.wp.com/webstockreview.net/images/motorcycle-clipart-svg-5.png"
  ];

  let v1 = null;
  let v2 = null;
  let result = null;
  let chosen = null;
  let animationFrame;
  let pos1 = 0, pos2 = 0;
  let finishLine = 540; // значение по умолчанию

  function getVehicleName(src) {
    if (src.includes("bmw")) return "Car";
    if (src.includes("airplane")) return "Airplane";
    if (src.includes("Sailboat")) return "Ship";
    if (src.includes("tank")) return "Tank";
    if (src.includes("motorcycle")) return "Bike";
    return "Transport";
  }

  function pickTwoRandomVehicles() {
    const indexes = [...Array(vehicles.length).keys()];
    const i1 = indexes.splice(Math.floor(Math.random() * indexes.length), 1)[0];
    const i2 = indexes[Math.floor(Math.random() * indexes.length)];
    return [vehicles[i1], vehicles[i2]];
  }

  function resetRace() {
    const [src1, src2] = pickTwoRandomVehicles();
    v1.src = src1;
    v2.src = src2;
    v1.style.transform = "translateX(0px)";
    v2.style.transform = "translateX(0px)";
    document.getElementById("choose1").textContent = getVehicleName(src1);
    document.getElementById("choose2").textContent = getVehicleName(src2);
    result.textContent = "";
    pos1 = 0;
    pos2 = 0;

    // Пересчёт границы финиша
    const trackWidth = document.getElementById("track1").offsetWidth;
    finishLine = trackWidth - 60; // 60 — примерная ширина транспорта
  }

  function startRace() {
    cancelAnimationFrame(animationFrame);
    pos1 = 0;
    pos2 = 0;

    const outcome = Math.random();
    const playerShouldWin = outcome < 0.4;

    const baseSpeed = 0.7;
    const variation = 0.3;
    let speed1, speed2;

    if ((chosen === 1 && playerShouldWin) || (chosen === 2 && !playerShouldWin)) {
      speed1 = baseSpeed + variation;
      speed2 = baseSpeed + Math.random();
    } else {
      speed1 = baseSpeed + Math.random();
      speed2 = baseSpeed + variation;
    }

    function step() {
      pos1 += speed1;
      pos2 += speed2;
      v1.style.transform = `translateX(${pos1}px)`;
      v2.style.transform = `translateX(${pos2}px)`;

      if (pos1 >= finishLine || pos2 >= finishLine) {
        const winner = pos1 > pos2 ? "1" : "2";
        const winName = winner === "1" ? getVehicleName(v1.src) : getVehicleName(v2.src);
        result.textContent = (winner === String(chosen))
          ? "Вы выиграли! Победил: " + winName
          : "Вы проиграли. Победил: " + winName;

        setTimeout(() => {
          resetRace();
          chosen = null;
        }, 2000);
      } else {
        animationFrame = requestAnimationFrame(step);
      }
    }

    animationFrame = requestAnimationFrame(step);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const playBtn = document.getElementById("raceGamePlayBtn");
    const raceGame = document.getElementById("raceGame");
    const quitBtn = document.getElementById("quitRaceGame");

    v1 = document.getElementById("v1");
    v2 = document.getElementById("v2");
    result = document.getElementById("raceResult");

    document.getElementById("choose1").onclick = () => {
      chosen = 1;
      startRace();
    };
    document.getElementById("choose2").onclick = () => {
      chosen = 2;
      startRace();
    };

    if (playBtn && raceGame) {
      playBtn.addEventListener("click", () => {
        raceGame.style.display = "flex";
        resetRace();
      });
    }

    if (quitBtn) {
      quitBtn.addEventListener("click", () => {
        raceGame.style.display = "none";
        cancelAnimationFrame(animationFrame);
      });
    }
  });
</script>
<!-- Мини-игра "Монетка" -->
<!-- Мини-игра Монетка -->
<style>
@keyframes flipCoin {
  0% { transform: rotateY(0); }
  50% { transform: rotateY(720deg); }
  100% { transform: rotateY(1440deg); }
}
</style>
<!-- Пользовательская версия игры "Монетка" -->
<div id="coinFlipGame" style="position: fixed; inset: 0; background: #f0f0f0; display: none; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; color: black; font-family: sans-serif;">
<button id="quitCoinFlipGame" style="position: absolute; top: 10px; right: 10px; background: transparent; color: black; font-size: 1.5rem; border: none; cursor: pointer;">✕ Quit</button>
<h1 style="color: #333;">Heads or Tails</h1>
<div class="controls" style="margin-bottom: 20px;">
<button onclick="choose('Heads')">Heads</button>
<button onclick="choose('Tails')">Tails</button>
</div>
<div id="coin" style="width: 120px; height: 120px; background-size: cover; background-position: center; border-radius: 50%; margin: 20px; position: relative; transform-style: preserve-3d; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>
<div id="result" style="font-size: 24px; font-weight: bold; margin-top: 20px;"></div>
</div>
<style>
@keyframes tossCoin {
  0%   { transform: translateY(0) rotateY(0deg); opacity: 1; }
  25%  { transform: translateY(-150px) rotateY(360deg); opacity: 0.8; }
  50%  { transform: translateY(-200px) rotateY(720deg); opacity: 0.6; }
  75%  { transform: translateY(-150px) rotateY(1080deg); opacity: 0.8; }
  100% { transform: translateY(0) rotateY(1440deg); opacity: 1; }
}
.flip {
  animation: tossCoin 1.5s ease-in-out;
}
button {
  padding: 10px 20px;
  margin: 5px;
  font-size: 16px;
  cursor: pointer;
  border: none;
  border-radius: 5px;
  background-color: #007bff;
  color: white;
}
button:hover {
  background-color: #0056b3;
}
</style>
<script>
document.addEventListener("DOMContentLoaded", () => {
  let userChoice = null;
  const coin = document.getElementById('coin');
  const result = document.getElementById('result');
  const coinGame = document.getElementById('coinFlipGame');
  const playBtn = document.getElementById('coinFlipPlayBtn');
  const quitBtn = document.getElementById('quitCoinFlipGame');

  const headsURL = "https://image.pngaaa.com/973/432973-middle.png";
  const tailsURL = "https://avatars.mds.yandex.net/i?id=1ed4de7e6b69fa91fffa7735e321531d25ca14cf-7761242-images-thumbs&n=13";

  coin.style.backgroundImage = `url('${tailsURL}')`;

  if (playBtn) {
    playBtn.addEventListener("click", () => {
      coinGame.style.display = "flex";
      result.textContent = "";
      coin.style.backgroundImage = `url('${tailsURL}')`;
    });
  }

  if (quitBtn) {
    quitBtn.addEventListener("click", () => {
      coinGame.style.display = "none";
    });
  }

  window.choose = function(choice) {
    userChoice = choice;
    result.textContent = `You chose: ${choice}`;
    flipCoin();
  }

  function flipCoin() {
    const outcome = Math.random() < 0.5 ? 'Heads' : 'Tails';
    let flipCount = 0;

    const interval = setInterval(() => {
      // Чередуем картинки
      coin.style.backgroundImage = (flipCount % 2 === 0)
        ? `url('${headsURL}')`
        : `url('${tailsURL}')`;
      flipCount++;
    }, 100); // быстрое переключение для имитации вращения

    coin.classList.add('flip');

    setTimeout(() => {
      clearInterval(interval);
      const finalImage = (outcome === 'Heads') ? headsURL : tailsURL;
      coin.style.backgroundImage = `url('${finalImage}')`;
      coin.classList.remove('flip');

      if (userChoice === outcome) {
        result.textContent = `Congratulations! It's ${outcome}. You win!`;
      } else {
        result.textContent = `Sorry! It's ${outcome}. You lose.`;
      }
    }, 1500);
  }
});
</script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</body>
</html>